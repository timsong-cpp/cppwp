<!DOCTYPE html><html lang='en'><head><title>[stoptoken.concepts]</title><meta charset='UTF-8'><link rel='stylesheet' type='text/css' href='14882.css'><link rel='stylesheet' type='text/css' href='https://fonts.googleapis.com/css2?family=Noto+Serif'><link rel='stylesheet' type='text/css' href='https://fonts.googleapis.com/css2?family=Noto+Sans'><link rel='stylesheet' type='text/css' href='https://fonts.googleapis.com/css2?family=Noto+Sans+Mono'><link rel='icon' href='icon.png'><link rel='stylesheet' type='text/css' href='expanded.css' title='Normal'><link rel='alternate stylesheet' type='text/css' href='colored.css' title='Notes and examples colored'><link rel='alternate stylesheet' type='text/css' href='normative-only.css' title='Notes and examples hidden'></head><body><div class='wrapper'><h1 ><a class='secnum' style='min-width:50pt'>32</a> Concurrency support library <a class='abbr_ref' href='./#thread'>[thread]</a></h1><h2 ><a class='secnum' style='min-width:65pt'>32.3</a> Stop tokens <a class='abbr_ref' href='thread.stoptoken#stoptoken.concepts'>[thread.stoptoken]</a></h2><h3 ><a class='secnum' style='min-width:80pt'>32.3.3</a> Stop token concepts <a class='abbr_ref'>[stoptoken.concepts]</a></h3><div class='para' id='1'><div class='marginalizedparent'><a class='marginalized' href='#1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/ac78ae76c579883a32a9eb5b00346150a41e8e47/source/threads.tex#L566'>#</a></div><div class='texpara'><div id='1.sentence-1' class='sentence'>The exposition-only <a href='#concept:stoppable-callback-for' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable-callback-for'><span class='texttt'><i >stoppable-callback-for</i></span></span></a> concept
checks for a callback compatible with a given <span class='texttt'>Token</span> type<a class='hidden_link' href='#1.sentence-1'>.</a></div> <span class='codeblock'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> CallbackFn, <span class='keyword'>class</span> Token, <span class='keyword'>class</span> Initializer <span class='operator'>=</span> CallbackFn<span class='anglebracket'>&gt;</span>
  <span class='keyword'>concept</span> <a class='hidden_link' href='#concept:stoppable-callback-for' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='concept:stoppable-callback-for'><span class='tcode_in_codeblock'><i >stoppable-callback-for</i></span></span></a> <span class='operator'>=</span>                          <span class='comment'>// <i >exposition only</i></span>
    <a href='concept.invocable#concept:invocable' title='18.7.2&emsp;Concept invocable&emsp;[concept.invocable]'><span id='conceptref:invocable'><span class='tcode_in_codeblock'>invocable</span></span></a><span class='anglebracket'>&lt;</span>CallbackFn<span class='anglebracket'>&gt;</span> <span class='operator'>&amp;</span><span class='operator'>&amp;</span>
    <a href='concept.constructible#concept:constructible_from' title='18.4.11&emsp;Concept constructible_&shy;from&emsp;[concept.constructible]'><span id='conceptref:constructible_from'><span class='tcode_in_codeblock'>constructible_<span class='shy'></span>from</span></span></a><span class='anglebracket'>&lt;</span>CallbackFn, Initializer<span class='anglebracket'>&gt;</span> <span class='operator'>&amp;</span><span class='operator'>&amp;</span>
    <span class='keyword'>requires</span> <span class='curlybracket'>{</span> <span class='keyword'>typename</span> stop_callback_for_t<span class='anglebracket'>&lt;</span>Token, CallbackFn<span class='anglebracket'>&gt;</span>; <span class='curlybracket'>}</span> <span class='operator'>&amp;</span><span class='operator'>&amp;</span>
    <a href='concept.constructible#concept:constructible_from' title='18.4.11&emsp;Concept constructible_&shy;from&emsp;[concept.constructible]'><span id='conceptref:constructible_from_'><span class='tcode_in_codeblock'>constructible_<span class='shy'></span>from</span></span></a><span class='anglebracket'>&lt;</span>stop_callback_for_t<span class='anglebracket'>&lt;</span>Token, CallbackFn<span class='anglebracket'>&gt;</span>, <span class='keyword'>const</span> Token<span class='operator'>&amp;</span>, Initializer<span class='anglebracket'>&gt;</span>;
</span></div></div><div class='para' id='2'><div class='marginalizedparent'><a class='marginalized' href='#2'>2</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/ac78ae76c579883a32a9eb5b00346150a41e8e47/source/threads.tex#L578'>#</a></div><div class='texpara'><div id='2.sentence-1' class='sentence'>Let <span class='texttt'>t</span> and <span class='texttt'>u</span> be distinct, valid objects of type <span class='texttt'>Token</span>
that reference the same logical stop state;
let <span class='texttt'>init</span> be an expression such that
<span class='texttt'><a href='concept.same#concept:same_as' title='18.4.2&emsp;Concept same_&shy;as&emsp;[concept.same]'><span id='conceptref:same_as'><span class='texttt'>same_<span class='shy'></span>as</span></span></a><span class='anglebracket'>&lt;</span><span class='keyword'>decltype</span><span class='parenthesis'>(</span>init<span class='parenthesis'>)</span>, Initializer<span class='anglebracket'>&gt;</span></span> is <span class='texttt'><span class='literal'>true</span></span>; and
let <span class='texttt'>SCB</span> denote the type <span class='texttt'>stop_<span class='shy'></span>callback_<span class='shy'></span>for_<span class='shy'></span>t<span class='anglebracket'>&lt;</span>Token, CallbackFn<span class='anglebracket'>&gt;</span></span><a class='hidden_link' href='#2.sentence-1'>.</a></div></div></div><div class='para' id='3'><div class='marginalizedparent'><a class='marginalized' href='#3'>3</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/ac78ae76c579883a32a9eb5b00346150a41e8e47/source/threads.tex#L585'>#</a></div><div class='texpara'><div id='3.sentence-1' class='sentence'>The concept
<span class='texttt'><a href='#concept:stoppable-callback-for' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable-callback-for_'><span class='texttt'><i >stoppable-callback-for</i></span></span></a><span class='anglebracket'>&lt;</span>CallbackFn, Token, Initializer<span class='anglebracket'>&gt;</span></span>
is modeled only if:
<ul class='itemize'><li id='3.1'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#3.1'>(3.1)</a></div><div class='texpara'><div id='3.1.sentence-1' class='sentence'>The following concepts are modeled:
<ul class='itemize'><li id='3.1.1'><div class='marginalizedparent' style='left:-36mm'><a class='marginalized' href='#3.1.1'>(3.1.1)</a></div><span class='texttt'><a href='concept.constructible#concept:constructible_from' title='18.4.11&emsp;Concept constructible_&shy;from&emsp;[concept.constructible]'><span id='conceptref:constructible_from__'><span class='texttt'>constructible_<span class='shy'></span>from</span></span></a><span class='anglebracket'>&lt;</span>SCB, Token, Initializer<span class='anglebracket'>&gt;</span></span></li><li id='3.1.2'><div class='marginalizedparent' style='left:-36mm'><a class='marginalized' href='#3.1.2'>(3.1.2)</a></div><span class='texttt'><a href='concept.constructible#concept:constructible_from' title='18.4.11&emsp;Concept constructible_&shy;from&emsp;[concept.constructible]'><span id='conceptref:constructible_from___'><span class='texttt'>constructible_<span class='shy'></span>from</span></span></a><span class='anglebracket'>&lt;</span>SCB, Token<span class='operator'>&amp;</span>, Initializer<span class='anglebracket'>&gt;</span></span></li><li id='3.1.3'><div class='marginalizedparent' style='left:-36mm'><a class='marginalized' href='#3.1.3'>(3.1.3)</a></div><span class='texttt'><a href='concept.constructible#concept:constructible_from' title='18.4.11&emsp;Concept constructible_&shy;from&emsp;[concept.constructible]'><span id='conceptref:constructible_from____'><span class='texttt'>constructible_<span class='shy'></span>from</span></span></a><span class='anglebracket'>&lt;</span>SCB, <span class='keyword'>const</span> Token, Initializer<span class='anglebracket'>&gt;</span></span></li></ul></div></div></li><li id='3.2'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#3.2'>(3.2)</a></div><div class='texpara'><div id='3.2.sentence-1' class='sentence'>An object of type <span class='texttt'>SCB</span> has
an associated callback function of type <span class='texttt'>CallbackFn</span><a class='hidden_link' href='#3.2.sentence-1'>.</a></div> <div id='3.2.sentence-2' class='sentence'>Let <span class='texttt'>scb</span> be an object of type <span class='texttt'>SCB</span> and
let <span class='texttt'>callback_<span class='shy'></span>fn</span> denote <span class='texttt'>scb's</span> associated callback function<a class='hidden_link' href='#3.2.sentence-2'>.</a></div> <div id='3.2.sentence-3' class='sentence'>Direct-non-list-initializing <span class='texttt'>scb</span> from
arguments <span class='texttt'>t</span> and <span class='texttt'>init</span>
shall execute a <a class='hidden_link' href='#def:registration,stoppable_callback' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='def:registration,stoppable_callback'><i >stoppable callback registration</i></span></a> as follows:
<ul class='itemize'><li id='3.2.1'><div class='marginalizedparent' style='left:-36mm'><a class='marginalized' href='#3.2.1'>(3.2.1)</a></div>If <span class='texttt'>t<span class='operator'>.</span>stop_<span class='shy'></span>possible<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> is <span class='texttt'><span class='literal'>true</span></span>:
<ul class='itemize'><li id='3.2.1.1'><div class='marginalizedparent' style='left:-45mm'><a class='marginalized' href='#3.2.1.1'>(3.2.1.1)</a></div><div class='texpara'><div id='3.2.1.1.sentence-1' class='sentence'><span class='texttt'>callback_<span class='shy'></span>fn</span> shall be direct-initialized with <span class='texttt'>init</span><a class='hidden_link' href='#3.2.1.1.sentence-1'>.</a></div></div></li><li id='3.2.1.2'><div class='marginalizedparent' style='left:-45mm'><a class='marginalized' href='#3.2.1.2'>(3.2.1.2)</a></div><div class='texpara'><div id='3.2.1.2.sentence-1' class='sentence'>Construction of <span class='texttt'>scb</span> shall only throw exceptions
thrown by the initialization of <span class='texttt'>callback_<span class='shy'></span>fn</span> from <span class='texttt'>init</span><a class='hidden_link' href='#3.2.1.2.sentence-1'>.</a></div></div></li><li id='3.2.1.3'><div class='marginalizedparent' style='left:-45mm'><a class='marginalized' href='#3.2.1.3'>(3.2.1.3)</a></div><div class='texpara'><div id='3.2.1.3.sentence-1' class='sentence'>The callback invocation <span class='texttt'>std<span class='operator'>&#x200b;::&#x200b;</span>forward<span class='anglebracket'>&lt;</span>CallbackFn<span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>callback_<span class='shy'></span>fn<span class='parenthesis'>)</span><span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>
shall be registered with <span class='texttt'>t</span>'s associated stop state as follows:
<ul class='itemize'><li id='3.2.1.3.1'><div class='marginalizedparent' style='left:-54mm'><a class='marginalized' href='#3.2.1.3.1'>(3.2.1.3.1)</a></div><div class='texpara'><div id='3.2.1.3.1.sentence-1' class='sentence'>If <span class='texttt'>t<span class='operator'>.</span>stop_<span class='shy'></span>requested<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> evaluates to <span class='texttt'><span class='literal'>false</span></span>
at the time of registration,
the callback invocation is added to the stop state's list of callbacks
such that <span class='texttt'>std<span class='operator'>&#x200b;::&#x200b;</span>forward<span class='anglebracket'>&lt;</span>CallbackFn<span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span><br>callback_<span class='shy'></span>fn<span class='parenthesis'>)</span><span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> is evaluated
if a stop request is made on the stop state<a class='hidden_link' href='#3.2.1.3.1.sentence-1'>.</a></div></div></li><li id='3.2.1.3.2'><div class='marginalizedparent' style='left:-54mm'><a class='marginalized' href='#3.2.1.3.2'>(3.2.1.3.2)</a></div><div class='texpara'><div id='3.2.1.3.2.sentence-1' class='sentence'>Otherwise, <span class='texttt'>std<span class='operator'>&#x200b;::&#x200b;</span>forward<span class='anglebracket'>&lt;</span>CallbackFn<span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>callback_<span class='shy'></span>fn<span class='parenthesis'>)</span><span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>
shall be immediately evaluated
on the thread executing <span class='texttt'>scb</span>'s constructor, and
the callback invocation shall not be added to the list of callback invocations<a class='hidden_link' href='#3.2.1.3.2.sentence-1'>.</a></div></div></li></ul></div> <div id='3.2.1.3.sentence-2' class='sentence'>
If the callback invocation was added to stop state's list of callbacks,
<span class='texttt'>scb</span> shall be associated with the stop state<a class='hidden_link' href='#3.2.1.3.sentence-2'>.</a></div></div></li></ul></li><li id='3.2.2'><div class='marginalizedparent' style='left:-36mm'><a class='marginalized' href='#3.2.2'>(3.2.2)</a></div><div id='note-1' class='note'><div class='texpara'>[<i>Note&nbsp;<a href='#note-1'>1</a></i>:&ensp;<div id='3.2.2.sentence-1' class='sentence'>If <span class='texttt'>t<span class='operator'>.</span>stop_<span class='shy'></span>possible<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> is <span class='texttt'><span class='literal'>false</span></span>,
there is no requirement
that the initialization of <span class='texttt'>scb</span>
causes the initialization of <span class='texttt'>callback_<span class='shy'></span>fn</span><a class='hidden_link' href='#3.2.2.sentence-1'>.</a></div> —&nbsp;<i>end note</i>]</div></div></li></ul></div></div></li><li id='3.3'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#3.3'>(3.3)</a></div><div class='texpara'><div id='3.3.sentence-1' class='sentence'>Destruction of <span class='texttt'>scb</span> shall execute
a <a class='hidden_link' href='#def:callback_deregistration,stoppable' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='def:callback_deregistration,stoppable'><i >stoppable callback deregistration</i></span></a> as follows (in order):
<ul class='itemize'><li id='3.3.1'><div class='marginalizedparent' style='left:-36mm'><a class='marginalized' href='#3.3.1'>(3.3.1)</a></div><div class='texpara'><div id='3.3.1.sentence-1' class='sentence'>If the constructor of <span class='texttt'>scb</span> did not register
a callback invocation with <span class='texttt'>t</span>'s stop state,
then the stoppable callback deregistration shall have no effect
other than destroying <span class='texttt'>callback_<span class='shy'></span>fn</span> if it was constructed<a class='hidden_link' href='#3.3.1.sentence-1'>.</a></div></div></li><li id='3.3.2'><div class='marginalizedparent' style='left:-36mm'><a class='marginalized' href='#3.3.2'>(3.3.2)</a></div><div class='texpara'><div id='3.3.2.sentence-1' class='sentence'>Otherwise, the invocation of <span class='texttt'>callback_<span class='shy'></span>fn</span> shall be removed
from the associated stop state<a class='hidden_link' href='#3.3.2.sentence-1'>.</a></div></div></li><li id='3.3.3'><div class='marginalizedparent' style='left:-36mm'><a class='marginalized' href='#3.3.3'>(3.3.3)</a></div><div class='texpara'><div id='3.3.3.sentence-1' class='sentence'>If <span class='texttt'>callback_<span class='shy'></span>fn</span> is concurrently executing on another thread,
then the stoppable callback deregistration shall block (<a href='defns.block' title='3.6&emsp;block'>[defns.<span class='shy'></span>block]</a>)
until the invocation of <span class='texttt'>callback_<span class='shy'></span>fn</span> returns
such that the return from the invocation of <span class='texttt'>callback_<span class='shy'></span>fn</span>
strongly happens before (<a href='intro.races' title='6.9.2.2&emsp;Data races'>[intro.<span class='shy'></span>races]</a>)
the destruction of <span class='texttt'>callback_<span class='shy'></span>fn</span><a class='hidden_link' href='#3.3.3.sentence-1'>.</a></div></div></li><li id='3.3.4'><div class='marginalizedparent' style='left:-36mm'><a class='marginalized' href='#3.3.4'>(3.3.4)</a></div><div class='texpara'><div id='3.3.4.sentence-1' class='sentence'>If <span class='texttt'>callback_<span class='shy'></span>fn</span> is executing on the current thread,
then the destructor shall not block
waiting for the return from the invocation of <span class='texttt'>callback_<span class='shy'></span>fn</span><a class='hidden_link' href='#3.3.4.sentence-1'>.</a></div></div></li><li id='3.3.5'><div class='marginalizedparent' style='left:-36mm'><a class='marginalized' href='#3.3.5'>(3.3.5)</a></div><div class='texpara'><div id='3.3.5.sentence-1' class='sentence'>A stoppable callback deregistration shall not block
on the completion of the invocation of some other callback
registered with the same logical stop state<a class='hidden_link' href='#3.3.5.sentence-1'>.</a></div></div></li><li id='3.3.6'><div class='marginalizedparent' style='left:-36mm'><a class='marginalized' href='#3.3.6'>(3.3.6)</a></div><div class='texpara'><div id='3.3.6.sentence-1' class='sentence'>The stoppable callback deregistration shall destroy <span class='texttt'>callback_<span class='shy'></span>fn</span><a class='hidden_link' href='#3.3.6.sentence-1'>.</a></div></div></li></ul></div></div></li></ul></div></div></div><div class='para' id='4'><div class='marginalizedparent'><a class='marginalized' href='#4'>4</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/ac78ae76c579883a32a9eb5b00346150a41e8e47/source/threads.tex#L675'>#</a></div><div class='texpara'><div id='4.sentence-1' class='sentence'>The <a href='#concept:stoppable_token' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable_token'><span class='texttt'>stoppable_<span class='shy'></span>token</span></span></a> concept checks
for the basic interface of a stop token
that is copyable and allows polling to see if stop has been requested and
also whether a stop request is possible<a class='hidden_link' href='#4.sentence-1'>.</a></div> <div id='4.sentence-2' class='sentence'>The <a href='#concept:unstoppable_token' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:unstoppable_token'><span class='texttt'>unstoppable_<span class='shy'></span>token</span></span></a> concept checks
for a <a href='#concept:stoppable_token' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable_token_'><span class='texttt'>stoppable_<span class='shy'></span>token</span></span></a> type that does not allow stopping<a class='hidden_link' href='#4.sentence-2'>.</a></div> <span class='codeblock'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span><span class='anglebracket'>&gt;</span> <span class='keyword'>class</span><span class='anglebracket'>&gt;</span>
  <span class='keyword'>struct</span> <i >check-type-alias-exists</i>;                               <span class='comment'>// <i >exposition only</i></span>

<span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Token<span class='anglebracket'>&gt;</span>
  <span class='keyword'>concept</span> <a class='hidden_link' href='#concept:stoppable_token' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='concept:stoppable_token'><span id='lib:stoppable_token'><span class='tcode_in_codeblock'>stoppable_<span class='shy'></span>token</span></span></span></a> <span class='operator'>=</span>
    <span class='keyword'>requires</span> <span class='parenthesis'>(</span><span class='keyword'>const</span> Token tok<span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
      <span class='keyword'>typename</span> <i >check-type-alias-exists</i><span class='anglebracket'>&lt;</span>Token<span class='operator'>::</span><span class='keyword'>template</span> callback_type<span class='anglebracket'>&gt;</span>;
      <span class='curlybracket'>{</span> tok<span class='operator'>.</span>stop_requested<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>}</span> <span class='keyword'>noexcept</span> <span class='operator'>-</span><span class='anglebracket'>&gt;</span> <a href='concept.same#concept:same_as' title='18.4.2&emsp;Concept same_&shy;as&emsp;[concept.same]'><span id='conceptref:same_as_'><span class='tcode_in_codeblock'>same_<span class='shy'></span>as</span></span></a><span class='anglebracket'>&lt;</span><span class='keyword'>bool</span><span class='anglebracket'>&gt;</span>;
      <span class='curlybracket'>{</span> tok<span class='operator'>.</span>stop_possible<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>}</span> <span class='keyword'>noexcept</span> <span class='operator'>-</span><span class='anglebracket'>&gt;</span> <a href='concept.same#concept:same_as' title='18.4.2&emsp;Concept same_&shy;as&emsp;[concept.same]'><span id='conceptref:same_as__'><span class='tcode_in_codeblock'>same_<span class='shy'></span>as</span></span></a><span class='anglebracket'>&lt;</span><span class='keyword'>bool</span><span class='anglebracket'>&gt;</span>;
      <span class='curlybracket'>{</span> Token<span class='parenthesis'>(</span>tok<span class='parenthesis'>)</span> <span class='curlybracket'>}</span> <span class='keyword'>noexcept</span>;                  <span class='comment'>// see implicit expression variations (<a href='concepts.equality' title='18.2&emsp;Equality preservation'>[concepts.<span class='shy'></span>equality]</a>)</span>
    <span class='curlybracket'>}</span> <span class='operator'>&amp;</span><span class='operator'>&amp;</span>
    <a href='concepts.object#concept:copyable' title='18.6&emsp;Object concepts&emsp;[concepts.object]'><span id='conceptref:copyable'><span class='tcode_in_codeblock'>copyable</span></span></a><span class='anglebracket'>&lt;</span>Token<span class='anglebracket'>&gt;</span> <span class='operator'>&amp;</span><span class='operator'>&amp;</span>
    <a href='concept.equalitycomparable#concept:equality_comparable' title='18.5.4&emsp;Concept equality_&shy;comparable&emsp;[concept.equalitycomparable]'><span id='conceptref:equality_comparable'><span class='tcode_in_codeblock'>equality_<span class='shy'></span>comparable</span></span></a><span class='anglebracket'>&lt;</span>Token<span class='anglebracket'>&gt;</span>;

<span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Token<span class='anglebracket'>&gt;</span>
  <span class='keyword'>concept</span> <a class='hidden_link' href='#concept:unstoppable_token' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='concept:unstoppable_token'><span id='lib:unstoppable_token'><span class='tcode_in_codeblock'>unstoppable_<span class='shy'></span>token</span></span></span></a> <span class='operator'>=</span>
    <a href='#concept:stoppable_token' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable_token__'><span class='tcode_in_codeblock'>stoppable_<span class='shy'></span>token</span></span></a><span class='anglebracket'>&lt;</span>Token<span class='anglebracket'>&gt;</span> <span class='operator'>&amp;</span><span class='operator'>&amp;</span>
    <span class='keyword'>requires</span> <span class='parenthesis'>(</span><span class='keyword'>const</span> Token tok<span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
      <span class='keyword'>requires</span> bool_constant<span class='anglebracket'>&lt;</span><span class='parenthesis'>(</span><span class='operator'>!</span>tok<span class='operator'>.</span>stop_possible<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span><span class='anglebracket'>&gt;</span><span class='operator'>::</span>value;
    <span class='curlybracket'>}</span>;
</span></div></div><div class='para' id='5'><div class='marginalizedparent'><a class='marginalized' href='#5'>5</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/ac78ae76c579883a32a9eb5b00346150a41e8e47/source/threads.tex#L705'>#</a></div><div class='texpara'><div id='5.sentence-1' class='sentence'>An object whose type models <a href='#concept:stoppable_token' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable_token___'><span class='texttt'>stoppable_<span class='shy'></span>token</span></span></a>
has at most one associated logical stop state<a class='hidden_link' href='#5.sentence-1'>.</a></div> <div id='5.sentence-2' class='sentence'>A <a href='#concept:stoppable_token' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable_token____'><span class='texttt'>stoppable_<span class='shy'></span>token</span></span></a> object with no associated stop state
is said to be <a class='hidden_link' href='#def:disengaged' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='def:disengaged'><i >disengaged</i></span></a><a class='hidden_link' href='#5.sentence-2'>.</a></div></div></div><div class='para' id='6'><div class='marginalizedparent'><a class='marginalized' href='#6'>6</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/ac78ae76c579883a32a9eb5b00346150a41e8e47/source/threads.tex#L711'>#</a></div><div class='texpara'><div id='6.sentence-1' class='sentence'>Let <span class='texttt'>SP</span> be an evaluation of <span class='texttt'>t<span class='operator'>.</span>stop_<span class='shy'></span>possible<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>
that is <span class='texttt'><span class='literal'>false</span></span>, and
let SR be an evaluation of <span class='texttt'>t<span class='operator'>.</span>stop_<span class='shy'></span>requested<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> that is <span class='texttt'><span class='literal'>true</span></span><a class='hidden_link' href='#6.sentence-1'>.</a></div></div></div><div class='para' id='7'><div class='marginalizedparent'><a class='marginalized' href='#7'>7</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/ac78ae76c579883a32a9eb5b00346150a41e8e47/source/threads.tex#L716'>#</a></div><div class='texpara'><div id='7.sentence-1' class='sentence'>The type <span class='texttt'>Token</span> models <a href='#concept:stoppable_token' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable_token_____'><span class='texttt'>stoppable_<span class='shy'></span>token</span></span></a> only if:
<ul class='itemize'><li id='7.1'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#7.1'>(7.1)</a></div><div class='texpara'><div id='7.1.sentence-1' class='sentence'>Any evaluation of <span class='texttt'>u<span class='operator'>.</span>stop_<span class='shy'></span>possible<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> or <span class='texttt'>u<span class='operator'>.</span>stop_<span class='shy'></span>requested<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>
that happens after (<a href='intro.races' title='6.9.2.2&emsp;Data races'>[intro.<span class='shy'></span>races]</a>) <span class='texttt'>SP</span> is <span class='texttt'><span class='literal'>false</span></span><a class='hidden_link' href='#7.1.sentence-1'>.</a></div></div></li><li id='7.2'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#7.2'>(7.2)</a></div><div class='texpara'><div id='7.2.sentence-1' class='sentence'>Any evaluation of <span class='texttt'>u<span class='operator'>.</span>stop_<span class='shy'></span>possible<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> or <span class='texttt'>u<span class='operator'>.</span>stop_<span class='shy'></span>requested<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>
that happens after <span class='texttt'>SR</span> is <span class='texttt'><span class='literal'>true</span></span><a class='hidden_link' href='#7.2.sentence-1'>.</a></div></div></li><li id='7.3'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#7.3'>(7.3)</a></div><div class='texpara'><div id='7.3.sentence-1' class='sentence'>For any types <span class='texttt'>CallbackFn</span> and <span class='texttt'>Initializer</span> such that
<span class='texttt'><a href='#concept:stoppable-callback-for' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable-callback-for__'><span class='texttt'><i >stoppable-callback-for</i></span></span></a><span class='anglebracket'>&lt;</span>CallbackFn, Token, Initializer<span class='anglebracket'>&gt;</span></span>
is satisfied,
<span class='texttt'><a href='#concept:stoppable-callback-for' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable-callback-for___'><span class='texttt'><i >stoppable-callback-for</i></span></span></a><span class='anglebracket'>&lt;</span>CallbackFn, Token, Initializer<span class='anglebracket'>&gt;</span></span>
is modeled<a class='hidden_link' href='#7.3.sentence-1'>.</a></div></div></li><li id='7.4'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#7.4'>(7.4)</a></div><div class='texpara'><div id='7.4.sentence-1' class='sentence'>If <span class='texttt'>t</span> is disengaged,
evaluations of <span class='texttt'>t<span class='operator'>.</span>stop_<span class='shy'></span>possible<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> and <span class='texttt'>t<span class='operator'>.</span>stop_<span class='shy'></span>requested<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>
are <span class='texttt'><span class='literal'>false</span></span><a class='hidden_link' href='#7.4.sentence-1'>.</a></div></div></li><li id='7.5'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#7.5'>(7.5)</a></div><div class='texpara'><div id='7.5.sentence-1' class='sentence'>If <span class='texttt'>t</span> and <span class='texttt'>u</span> reference the same stop state, or
if both <span class='texttt'>t</span> and <span class='texttt'>u</span> are disengaged,
<span class='texttt'>t <span class='operator'>=</span><span class='operator'>=</span> u</span> is <span class='texttt'><span class='literal'>true</span></span>; otherwise, it is <span class='texttt'><span class='literal'>false</span></span><a class='hidden_link' href='#7.5.sentence-1'>.</a></div></div></li></ul></div></div></div><div class='para' id='8'><div class='marginalizedparent'><a class='marginalized' href='#8'>8</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/ac78ae76c579883a32a9eb5b00346150a41e8e47/source/threads.tex#L741'>#</a></div><div class='texpara'><div id='8.sentence-1' class='sentence'>An object
whose type models the exposition-only <a href='#concept:stoppable-source' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable-source'><span class='texttt'><i >stoppable-source</i></span></span></a> concept
can be queried
whether stop has been requested (<span class='texttt'>stop_<span class='shy'></span>requested</span>) and
whether stop is possible (<span class='texttt'>stop_<span class='shy'></span>possible</span>)<a class='hidden_link' href='#8.sentence-1'>.</a></div> <div id='8.sentence-2' class='sentence'>It is a factory for associated stop tokens (<span class='texttt'>get_<span class='shy'></span>token</span>), and
a stop request can be made on it (<span class='texttt'>request_<span class='shy'></span>stop</span>)<a class='hidden_link' href='#8.sentence-2'>.</a></div> <div id='8.sentence-3' class='sentence'>It maintains a list of registered stop callback invocations
that it executes when a stop request is first made<a class='hidden_link' href='#8.sentence-3'>.</a></div> <span class='codeblock'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Source<span class='anglebracket'>&gt;</span>
  <span class='keyword'>concept</span> <a class='hidden_link' href='#concept:stoppable-source' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='concept:stoppable-source'><span class='tcode_in_codeblock'><i >stoppable-source</i></span></span></a> <span class='operator'>=</span>                                    <span class='comment'>// <i >exposition only</i></span>
    <span class='keyword'>requires</span> <span class='parenthesis'>(</span>Source<span class='operator'>&amp;</span> src, <span class='keyword'>const</span> Source csrc<span class='parenthesis'>)</span> <span class='curlybracket'>{</span>         <span class='comment'>// see implicit expression variations (<a href='concepts.equality' title='18.2&emsp;Equality preservation'>[concepts.<span class='shy'></span>equality]</a>)</span>
      <span class='curlybracket'>{</span> csrc<span class='operator'>.</span>get_token<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>}</span> <span class='operator'>-</span><span class='anglebracket'>&gt;</span> stoppable_token;
      <span class='curlybracket'>{</span> csrc<span class='operator'>.</span>stop_possible<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>}</span> <span class='keyword'>noexcept</span> <span class='operator'>-</span><span class='anglebracket'>&gt;</span> <a href='concept.same#concept:same_as' title='18.4.2&emsp;Concept same_&shy;as&emsp;[concept.same]'><span id='conceptref:same_as___'><span class='tcode_in_codeblock'>same_<span class='shy'></span>as</span></span></a><span class='anglebracket'>&lt;</span><span class='keyword'>bool</span><span class='anglebracket'>&gt;</span>;
      <span class='curlybracket'>{</span> csrc<span class='operator'>.</span>stop_requested<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>}</span> <span class='keyword'>noexcept</span> <span class='operator'>-</span><span class='anglebracket'>&gt;</span> <a href='concept.same#concept:same_as' title='18.4.2&emsp;Concept same_&shy;as&emsp;[concept.same]'><span id='conceptref:same_as____'><span class='tcode_in_codeblock'>same_<span class='shy'></span>as</span></span></a><span class='anglebracket'>&lt;</span><span class='keyword'>bool</span><span class='anglebracket'>&gt;</span>;
      <span class='curlybracket'>{</span> src<span class='operator'>.</span>request_stop<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>}</span> <span class='operator'>-</span><span class='anglebracket'>&gt;</span> <a href='concept.same#concept:same_as' title='18.4.2&emsp;Concept same_&shy;as&emsp;[concept.same]'><span id='conceptref:same_as_____'><span class='tcode_in_codeblock'>same_<span class='shy'></span>as</span></span></a><span class='anglebracket'>&lt;</span><span class='keyword'>bool</span><span class='anglebracket'>&gt;</span>;
    <span class='curlybracket'>}</span>;
</span></div></div><div class='para' id='9'><div class='marginalizedparent'><a class='marginalized' href='#9'>9</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/ac78ae76c579883a32a9eb5b00346150a41e8e47/source/threads.tex#L762'>#</a></div><div class='texpara'><div id='9.sentence-1' class='sentence'>An object whose type models <a href='#concept:stoppable-source' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable-source_'><span class='texttt'><i >stoppable-source</i></span></span></a> has
at most one associated logical stop state<a class='hidden_link' href='#9.sentence-1'>.</a></div> <div id='9.sentence-2' class='sentence'>If it has no associated stop state, it is said to be disengaged<a class='hidden_link' href='#9.sentence-2'>.</a></div> <div id='9.sentence-3' class='sentence'>Let <span class='texttt'>s</span> be an object whose type models <a href='#concept:stoppable-source' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable-source__'><span class='texttt'><i >stoppable-source</i></span></span></a> and
that is disengaged<a class='hidden_link' href='#9.sentence-3'>.</a></div> <div id='9.sentence-4' class='sentence'><span class='texttt'>s<span class='operator'>.</span>stop_<span class='shy'></span>possible<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> and <span class='texttt'>s<span class='operator'>.</span>stop_<span class='shy'></span>requested<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> shall be <span class='texttt'><span class='literal'>false</span></span><a class='hidden_link' href='#9.sentence-4'>.</a></div></div></div><div class='para' id='10'><div class='marginalizedparent'><a class='marginalized' href='#10'>10</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/ac78ae76c579883a32a9eb5b00346150a41e8e47/source/threads.tex#L770'>#</a></div><div class='texpara'><div id='10.sentence-1' class='sentence'>Let <span class='texttt'>t</span> be an object whose type models <a href='#concept:stoppable-source' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable-source___'><span class='texttt'><i >stoppable-source</i></span></span></a><a class='hidden_link' href='#10.sentence-1'>.</a></div> <div id='10.sentence-2' class='sentence'>If <span class='texttt'>t</span> is disengaged,
<span class='texttt'>t<span class='operator'>.</span>get_<span class='shy'></span>token<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> shall return a disengaged stop token;
otherwise, it shall return
a stop token that is associated with the stop state of <span class='texttt'>t</span><a class='hidden_link' href='#10.sentence-2'>.</a></div></div></div><div class='para' id='11'><div class='marginalizedparent'><a class='marginalized' href='#11'>11</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/ac78ae76c579883a32a9eb5b00346150a41e8e47/source/threads.tex#L777'>#</a></div><div class='texpara'><div id='11.sentence-1' class='sentence'>Calls to the member functions
<span class='texttt'>request_<span class='shy'></span>stop</span>, <span class='texttt'>stop_<span class='shy'></span>requested</span>, and <span class='texttt'>stop_<span class='shy'></span>possible</span> and
similarly named member functions
on associated <a href='#concept:stoppable_token' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable_token______'><span class='texttt'>stoppable_<span class='shy'></span>token</span></span></a> objects
do not introduce data races<a class='hidden_link' href='#11.sentence-1'>.</a></div> <div id='11.sentence-2' class='sentence'>A call to <span class='texttt'>request_<span class='shy'></span>stop</span> that returns <span class='texttt'><span class='literal'>true</span></span> synchronizes with
a call to <span class='texttt'>stop_<span class='shy'></span>requested</span> on
an associated
<a href='#concept:stoppable_token' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable_token_______'><span class='texttt'>stoppable_<span class='shy'></span>token</span></span></a> or <a href='#concept:stoppable-source' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable-source____'><span class='texttt'><i >stoppable-source</i></span></span></a> object
that returns <span class='texttt'><span class='literal'>true</span></span><a class='hidden_link' href='#11.sentence-2'>.</a></div> <div id='11.sentence-3' class='sentence'>Registration of a callback synchronizes with the invocation of that callback<a class='hidden_link' href='#11.sentence-3'>.</a></div></div></div><div class='para' id='12'><div class='marginalizedparent'><a class='marginalized' href='#12'>12</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/ac78ae76c579883a32a9eb5b00346150a41e8e47/source/threads.tex#L790'>#</a></div><div class='texpara'><div id='12.sentence-1' class='sentence'>If the <a href='#concept:stoppable-source' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable-source_____'><span class='texttt'><i >stoppable-source</i></span></span></a> is disengaged,
<span class='texttt'>request_<span class='shy'></span>stop</span> shall have no effect and return <span class='texttt'><span class='literal'>false</span></span><a class='hidden_link' href='#12.sentence-1'>.</a></div> <div id='12.sentence-2' class='sentence'>Otherwise, it shall execute a <a class='hidden_link' href='#def:operation,stop_request' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='def:operation,stop_request'><i >stop request operation</i></span></a>
on the associated stop state<a class='hidden_link' href='#12.sentence-2'>.</a></div> <div id='12.sentence-3' class='sentence'>A stop request operation determines
whether the stop state has received a stop request, and
if not, makes a stop request<a class='hidden_link' href='#12.sentence-3'>.</a></div> <div id='12.sentence-4' class='sentence'>The determination and making of the stop request shall happen atomically,
as-if by a read-modify-write operation (<a href='intro.races' title='6.9.2.2&emsp;Data races'>[intro.<span class='shy'></span>races]</a>)<a class='hidden_link' href='#12.sentence-4'>.</a></div> <div id='12.sentence-5' class='sentence'>If the request was made,
the stop state's registered callback invocations shall be
synchronously executed<a class='hidden_link' href='#12.sentence-5'>.</a></div> <div id='12.sentence-6' class='sentence'>If an invocation of a callback exits via an exception
then <span class='texttt'>terminate</span> shall be invoked (<a href='except.terminate' title='14.6.2&emsp;The std&#x200b;::&#x200b;terminate function'>[except.<span class='shy'></span>terminate]</a>)<a class='hidden_link' href='#12.sentence-6'>.</a></div> <div id='note-2' class='note'><div class='texpara'>[<i>Note&nbsp;<a href='#note-2'>2</a></i>:&ensp;<div id='12.sentence-7' class='sentence'>No constraint is placed on the order
in which the callback invocations are executed<a class='hidden_link' href='#12.sentence-7'>.</a></div> —&nbsp;<i>end note</i>]</div></div> <div id='12.sentence-8' class='sentence'><span class='texttt'>request_<span class='shy'></span>stop</span> shall return <span class='texttt'><span class='literal'>true</span></span> if a stop request was made, and
<span class='texttt'><span class='literal'>false</span></span> otherwise<a class='hidden_link' href='#12.sentence-8'>.</a></div> <div id='12.sentence-9' class='sentence'>After a call to <span class='texttt'>request_<span class='shy'></span>stop</span> either
a call to <span class='texttt'>stop_<span class='shy'></span>possible</span> shall return <span class='texttt'><span class='literal'>false</span></span> or
a call to <span class='texttt'>stop_<span class='shy'></span>requested</span> shall return <span class='texttt'><span class='literal'>true</span></span><a class='hidden_link' href='#12.sentence-9'>.</a></div> <div id='note-3' class='note'><div class='texpara'>[<i>Note&nbsp;<a href='#note-3'>3</a></i>:&ensp;<div id='12.sentence-10' class='sentence'>A stop request includes notifying
all condition variables of type <span class='texttt'>condition_<span class='shy'></span>variable_<span class='shy'></span>any</span>
temporarily registered during
an interruptible wait (<a href='thread.condvarany.intwait' title='32.7.5.3&emsp;Interruptible waits'>[thread.<span class='shy'></span>condvarany.<span class='shy'></span>intwait]</a>)<a class='hidden_link' href='#12.sentence-10'>.</a></div> —&nbsp;<i>end note</i>]</div></div></div></div></div></body></html>