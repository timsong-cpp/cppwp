<!DOCTYPE html><html lang='en'><head><title>[class.free]</title><meta charset='UTF-8'/><link rel='stylesheet' type='text/css' href='14882.css'/><link rel='stylesheet' type='text/css' href='expanded.css' title='Notes and examples expanded'/><link rel='alternate stylesheet' type='text/css' href='colored.css' title='Notes and examples colored'/><link rel='icon' href='icon.png'/></head><body><div class='wrapper'><h1 ><a class='secnum' style='min-width:73pt'>11</a> Classes <a class='abbr_ref' href='./#class'>[class]</a></h1><h2 ><a class='secnum' style='min-width:88pt'>11.11</a> Free store <a class='abbr_ref'>[class.free]</a></h2><span class='indexparent'><a class='index' id=':free_store'></a></span><div class='para' id='1'><div class='marginalizedparent'><a class='marginalized' href='#1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/be443affbf06bfb14c2295311ed469896ae39d6c/source/classes.tex#L6972'>#</a></div><div id='1.sentence-1' class='sentence'><span class='indexparent'><a class='index' id=':new,type_of'></a></span>
Any allocation function for a class
<span class='texttt'>T</span>
is a static member (even if not explicitly declared
<span class='texttt'><span class='keyword'>static</span></span>)<a class='hidden_link' href='#1.sentence-1'>.</a></div></div><div class='para' id='2'><div class='marginalizedparent'><a class='marginalized' href='#2'>2</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/be443affbf06bfb14c2295311ed469896ae39d6c/source/classes.tex#L6979'>#</a></div><div id='2.example-1' class='example'>[&nbsp;<a class='example_link' href='#2.example-1'><span class='textit'>Example</span></a><div class='exampleBody'><span class='textit'>:</span> <pre class='codeblock'>
<span class='keyword'>class</span> Arena;
<span class='keyword'>struct</span> B <span class='curlybracket'>{</span>
  <span class='keyword'>void</span><span class='operator'>*</span> <span class='keyword'>operator</span> <span class='keyword'>new</span><span class='parenthesis'>(</span>std<span class='operator'>::</span>size_t, Arena<span class='operator'>*</span><span class='parenthesis'>)</span>;
<span class='curlybracket'>}</span>;
<span class='keyword'>struct</span> D1 <span class='operator'>:</span> B <span class='curlybracket'>{</span>
<span class='curlybracket'>}</span>;

Arena<span class='operator'>*</span>  ap;
<span class='keyword'>void</span> foo<span class='parenthesis'>(</span><span class='keyword'>int</span> i<span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  <span class='keyword'>new</span> <span class='parenthesis'>(</span>ap<span class='parenthesis'>)</span> D1;      <span class='comment'>// calls <span class='tcode_in_codeblock'>B&#x200b;::&#x200b;operator new(std&#x200b;::&#x200b;size_&shy;t, Arena*)</span></span>
  <span class='keyword'>new</span> D1<span class='squarebracket'>[</span>i<span class='squarebracket'>]</span>;        <span class='comment'>// calls <span class='tcode_in_codeblock'>&#x200b;::&#x200b;operator new[](std&#x200b;::&#x200b;size_&shy;t)</span></span>
  <span class='keyword'>new</span> D1;           <span class='comment'>// ill-formed: <span class='tcode_in_codeblock'>&#x200b;::&#x200b;operator new(std&#x200b;::&#x200b;size_&shy;t)</span> hidden</span>
<span class='curlybracket'>}</span>
</pre> —&nbsp;<i>end example</i></div>&nbsp;]</div> </div><div class='para' id='3'><div class='marginalizedparent'><a class='marginalized' href='#3'>3</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/be443affbf06bfb14c2295311ed469896ae39d6c/source/classes.tex#L6998'>#</a></div><div id='3.sentence-1' class='sentence'><span class='indexparent'><a class='index' id=':delete'></a></span>When an object is deleted with a
<i ><a href='expr.delete#nt:delete-expression'>delete-expression</a></i> (<a href='expr.delete'>[expr.delete]</a>),
a deallocation function
<span class='indexparent'><a class='index' id=':function,deallocation'></a></span>(<span class='texttt'><span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>
<span class='indexparent'><a class='index' id=':operator_delete'></a></span>for non-array objects or
<span class='texttt'><span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='squarebracket'>[</span><span class='squarebracket'>]</span><span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>
<span class='indexparent'><a class='index' id=':operator_delete_'></a></span>for arrays) is (implicitly) called to reclaim the storage occupied by
the object (<a href='basic.stc.dynamic.deallocation'>[basic.stc.dynamic.deallocation]</a>)<a class='hidden_link' href='#3.sentence-1'>.</a></div></div><div class='para' id='4'><div class='marginalizedparent'><a class='marginalized' href='#4'>4</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/be443affbf06bfb14c2295311ed469896ae39d6c/source/classes.tex#L7012'>#</a></div><div id='4.sentence-1' class='sentence'>Class-specific deallocation function lookup is a part of general deallocation
function lookup (<a href='expr.delete'>[expr.delete]</a>) and occurs as follows<a class='hidden_link' href='#4.sentence-1'>.</a></div> <div id='4.sentence-2' class='sentence'>If the <i ><a href='expr.delete#nt:delete-expression'>delete-expression</a></i>
is used to deallocate a class object whose static type has a virtual
destructor, the deallocation function is the one selected at the point
of definition of the dynamic type's virtual
destructor (<a href='class.dtor'>[class.dtor]</a>)<a class='hidden_link' href='#4.sentence-2'>.</a><a class='footnotenum' href='#footnote-116' id='footnoteref-116'>116</a></div> <div id='4.sentence-3' class='sentence'>
Otherwise, if the
<i ><a href='expr.delete#nt:delete-expression'>delete-expression</a></i>
is used to deallocate an object of class
<span class='texttt'>T</span>
or array thereof,
the deallocation function's name is looked up in the scope of
<span class='texttt'>T</span><a class='hidden_link' href='#4.sentence-3'>.</a></div> <div id='4.sentence-4' class='sentence'>If this lookup fails to find the name, general deallocation function
lookup (<a href='expr.delete'>[expr.delete]</a>) continues<a class='hidden_link' href='#4.sentence-4'>.</a></div> <div id='4.sentence-5' class='sentence'>If the result of the lookup is ambiguous or inaccessible, or if the lookup
selects a placement deallocation function, the program is ill-formed<a class='hidden_link' href='#4.sentence-5'>.</a></div></div><div class='para' id='5'><div class='marginalizedparent'><a class='marginalized' href='#5'>5</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/be443affbf06bfb14c2295311ed469896ae39d6c/source/classes.tex#L7036'>#</a></div><div id='5.sentence-1' class='sentence'><span class='indexparent'><a class='index' id=':delete,type_of'></a></span>Any deallocation function for a class
<span class='texttt'>X</span>
is a static member (even if not explicitly declared
<span class='texttt'><span class='keyword'>static</span></span>)<a class='hidden_link' href='#5.sentence-1'>.</a></div> <div id='5.example-1' class='example'>[&nbsp;<a class='example_link' href='#5.example-1'><span class='textit'>Example</span></a><div class='exampleBody'><span class='textit'>:</span> <pre class='codeblock'>
<span class='keyword'>class</span> X <span class='curlybracket'>{</span>
  <span class='keyword'>void</span> <span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span><span class='parenthesis'>)</span>;
  <span class='keyword'>void</span> <span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='squarebracket'>[</span><span class='squarebracket'>]</span><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span>, std<span class='operator'>::</span>size_t<span class='parenthesis'>)</span>;
<span class='curlybracket'>}</span>;

<span class='keyword'>class</span> Y <span class='curlybracket'>{</span>
  <span class='keyword'>void</span> <span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span>, std<span class='operator'>::</span>size_t<span class='parenthesis'>)</span>;
  <span class='keyword'>void</span> <span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='squarebracket'>[</span><span class='squarebracket'>]</span><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span><span class='parenthesis'>)</span>;
<span class='curlybracket'>}</span>;
</pre> —&nbsp;<i>end example</i></div>&nbsp;]</div> </div><div class='para' id='6'><div class='marginalizedparent'><a class='marginalized' href='#6'>6</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/be443affbf06bfb14c2295311ed469896ae39d6c/source/classes.tex#L7056'>#</a></div><div id='6.sentence-1' class='sentence'>Since member allocation and deallocation functions are
<span class='texttt'><span class='keyword'>static</span></span>
they cannot be virtual<a class='hidden_link' href='#6.sentence-1'>.</a></div> <div id='6.note-1' class='note'>[&nbsp;<a class='note_link' href='#6.note-1'><span class='textit'>Note</span></a><div class='noteBody'><span class='textit'>:</span> <div id='6.sentence-2' class='sentence'>However, when the
<i ><a href='expr.cast#nt:cast-expression'>cast-expression</a></i>
of a
<i ><a href='expr.delete#nt:delete-expression'>delete-expression</a></i>
refers to an object of class type,
because the deallocation function actually called is looked up in the scope of
the class that is the dynamic type of the object
if the destructor is virtual, the effect is the same in that case<a class='hidden_link' href='#6.sentence-2'>.</a></div> <div id='6.sentence-3' class='sentence'>For example,
<pre class='codeblock'>
<span class='keyword'>struct</span> B <span class='curlybracket'>{</span>
  <span class='keyword'>virtual</span> <span class='operator'>~</span>B<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  <span class='keyword'>void</span> <span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span>, std<span class='operator'>::</span>size_t<span class='parenthesis'>)</span>;
<span class='curlybracket'>}</span>;

<span class='keyword'>struct</span> D <span class='operator'>:</span> B <span class='curlybracket'>{</span>
  <span class='keyword'>void</span> <span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span><span class='parenthesis'>)</span>;
<span class='curlybracket'>}</span>;

<span class='keyword'>struct</span> E <span class='operator'>:</span> B <span class='curlybracket'>{</span>
  <span class='keyword'>void</span> log_deletion<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  <span class='keyword'>void</span> <span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='parenthesis'>(</span>E <span class='operator'>*</span>p, std<span class='operator'>::</span>destroying_delete_t<span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
    p<span class='operator'>-</span><span class='anglebracket'>&gt;</span>log_deletion<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
    p<span class='operator'>-</span><span class='anglebracket'>&gt;</span><span class='operator'>~</span>E<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
    <span class='operator'>::</span><span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='parenthesis'>(</span>p<span class='parenthesis'>)</span>;
  <span class='curlybracket'>}</span>
<span class='curlybracket'>}</span>;

<span class='keyword'>void</span> f<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  B<span class='operator'>*</span> bp <span class='operator'>=</span> <span class='keyword'>new</span> D;
  <span class='keyword'>delete</span> bp;        <span class='comment'>// 1: uses <span class='tcode_in_codeblock'>D&#x200b;::&#x200b;operator delete(void*)</span></span>
  bp <span class='operator'>=</span> <span class='keyword'>new</span> E;
  <span class='keyword'>delete</span> bp;        <span class='comment'>// 2: uses <span class='tcode_in_codeblock'>E&#x200b;::&#x200b;operator delete(E*, std&#x200b;::&#x200b;destroying_&shy;delete_&shy;t)</span></span>
<span class='curlybracket'>}</span>
</pre></div> <div id='6.sentence-4' class='sentence'>
Here, storage for the object of class
<span class='texttt'>D</span>
is deallocated by
<span class='texttt'>D<span class='operator'>&#x200b;::&#x200b;</span><span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>,
and
the object of class <span class='texttt'>E</span> is destroyed
and its storage is deallocated
by <span class='texttt'>E<span class='operator'>&#x200b;::&#x200b;</span><span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>,
due to the virtual destructor<a class='hidden_link' href='#6.sentence-4'>.</a></div> —&nbsp;<i>end note</i></div>&nbsp;]</div>  <div id='6.note-2' class='note'>[&nbsp;<a class='note_link' href='#6.note-2'><span class='textit'>Note</span></a><div class='noteBody'><span class='textit'>:</span> <div id='6.sentence-5' class='sentence'>Virtual destructors have no effect on the deallocation function actually
called when the
<i ><a href='expr.cast#nt:cast-expression'>cast-expression</a></i>
of a
<i ><a href='expr.delete#nt:delete-expression'>delete-expression</a></i>
refers to an array of objects of class type<a class='hidden_link' href='#6.sentence-5'>.</a></div> <div id='6.sentence-6' class='sentence'>For example,
<pre class='codeblock'>
<span class='keyword'>struct</span> B <span class='curlybracket'>{</span>
  <span class='keyword'>virtual</span> <span class='operator'>~</span>B<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  <span class='keyword'>void</span> <span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='squarebracket'>[</span><span class='squarebracket'>]</span><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span>, std<span class='operator'>::</span>size_t<span class='parenthesis'>)</span>;
<span class='curlybracket'>}</span>;

<span class='keyword'>struct</span> D <span class='operator'>:</span> B <span class='curlybracket'>{</span>
  <span class='keyword'>void</span> <span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='squarebracket'>[</span><span class='squarebracket'>]</span><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span>, std<span class='operator'>::</span>size_t<span class='parenthesis'>)</span>;
<span class='curlybracket'>}</span>;

<span class='keyword'>void</span> f<span class='parenthesis'>(</span><span class='keyword'>int</span> i<span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  D<span class='operator'>*</span> dp <span class='operator'>=</span> <span class='keyword'>new</span> D<span class='squarebracket'>[</span>i<span class='squarebracket'>]</span>;
  <span class='keyword'>delete</span> <span class='squarebracket'>[</span><span class='squarebracket'>]</span> dp;     <span class='comment'>// uses <span class='tcode_in_codeblock'>D&#x200b;::&#x200b;operator delete[](void*, std&#x200b;::&#x200b;size_&shy;t)</span></span>
  B<span class='operator'>*</span> bp <span class='operator'>=</span> <span class='keyword'>new</span> D<span class='squarebracket'>[</span>i<span class='squarebracket'>]</span>;
  <span class='keyword'>delete</span><span class='squarebracket'>[</span><span class='squarebracket'>]</span> bp;      <span class='comment'>// undefined behavior</span>
<span class='curlybracket'>}</span>
</pre></div> —&nbsp;<i>end note</i></div>&nbsp;]</div> </div><div class='para' id='7'><div class='marginalizedparent'><a class='marginalized' href='#7'>7</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/be443affbf06bfb14c2295311ed469896ae39d6c/source/classes.tex#L7133'>#</a></div><div id='7.sentence-1' class='sentence'>Access to the deallocation function is checked statically<a class='hidden_link' href='#7.sentence-1'>.</a></div> <div id='7.sentence-2' class='sentence'>Hence, even though a different one might actually be executed,
the statically visible deallocation function is required to be accessible<a class='hidden_link' href='#7.sentence-2'>.</a></div> <div id='7.example-1' class='example'>[&nbsp;<a class='example_link' href='#7.example-1'><span class='textit'>Example</span></a><div class='exampleBody'><span class='textit'>:</span> <div id='7.sentence-3' class='sentence'>For the call on line “// 1” above,
if
<span class='texttt'>B<span class='operator'>&#x200b;::&#x200b;</span><span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>
had been private, the delete expression would have been ill-formed<a class='hidden_link' href='#7.sentence-3'>.</a></div> —&nbsp;<i>end example</i></div>&nbsp;]</div> </div><div class='para' id='8'><div class='marginalizedparent'><a class='marginalized' href='#8'>8</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/be443affbf06bfb14c2295311ed469896ae39d6c/source/classes.tex#L7144'>#</a></div><div id='8.note-1' class='note'>[&nbsp;<a class='note_link' href='#8.note-1'><span class='textit'>Note</span></a><div class='noteBody'><span class='textit'>:</span> <div id='8.sentence-1' class='sentence'>If a deallocation function has no explicit <i ><a href='except.spec#nt:noexcept-specifier'>noexcept-specifier</a></i>, it
has a non-throwing exception specification (<a href='except.spec'>[except.spec]</a>)<a class='hidden_link' href='#8.sentence-1'>.</a></div> —&nbsp;<i>end note</i></div>&nbsp;]</div> </div><div class='footnote' id='footnote-116'><div class='footnoteNumberParent'><a class='marginalized' href='#footnote-116'>116)</a></div><div id='footnote-116.sentence-1' class='sentence'>A similar provision is not needed for
the array version of <span class='texttt'><span class='keyword'>operator</span></span> <span class='texttt'><span class='keyword'>delete</span></span> because <a href='expr.delete'>[expr.delete]</a>
requires that in this situation, the static type of the object to be deleted be
the same as its dynamic type<a class='hidden_link' href='#footnote-116.sentence-1'>.</a></div> <a href='#footnoteref-116'>⮥</a></div></div></body></html>