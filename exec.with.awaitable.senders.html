<!DOCTYPE html><html lang='en'><head><title>[exec.with.awaitable.senders]</title><meta charset='UTF-8'/><link rel='stylesheet' type='text/css' href='14882.css'/><link rel='stylesheet' type='text/css' href='https://fonts.googleapis.com/css2?family=Noto+Serif'/><link rel='stylesheet' type='text/css' href='https://fonts.googleapis.com/css2?family=Noto+Sans'/><link rel='stylesheet' type='text/css' href='https://fonts.googleapis.com/css2?family=Noto+Sans+Mono'/><link rel='icon' href='icon.png'/><link rel='stylesheet' type='text/css' href='expanded.css' title='Normal'/><link rel='alternate stylesheet' type='text/css' href='colored.css' title='Notes and examples colored'/><link rel='alternate stylesheet' type='text/css' href='normative-only.css' title='Notes and examples hidden'/></head><body><div class='wrapper'><h1 ><a class='secnum' style='min-width:50pt'>33</a> Execution control library <a class='abbr_ref' href='./#exec'>[exec]</a></h1><h2 ><a class='secnum' style='min-width:65pt'>33.13</a> Coroutine utilities <a class='abbr_ref' href='exec.coro.util#exec.with.awaitable.senders'>[exec.coro.util]</a></h2><h3 ><a class='secnum' style='min-width:80pt'>33.13.2</a> <span class='texttt'>execution&#x200b;::&#x200b;with_<span class='shy'></span>awaitable_<span class='shy'></span>senders</span> <a class='abbr_ref'>[exec.with.awaitable.senders]</a></h3><div class='para' id='1'><div class='marginalizedparent'><a class='marginalized' href='#1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/399b93910d0bb6f5632405ad188e9f4aad0ae99a/source/exec.tex#L5587'>#</a></div><div class='texpara'><div id='1.sentence-1' class='sentence'><span class='texttt'>with_<span class='shy'></span>awaitable_<span class='shy'></span>senders</span>,
when used as the base class of a coroutine promise type,
makes senders awaitable in that coroutine type<a class='hidden_link' href='#1.sentence-1'>.</a></div></div><div class='texpara'><div id='1.sentence-2' class='sentence'>In addition, it provides a default implementation of <span class='texttt'>unhandled_<span class='shy'></span>stopped</span>
such that if a sender completes by calling <span class='texttt'>set_<span class='shy'></span>stopped</span>,
it is treated as if an uncatchable "stopped" exception were thrown
from the <a href='expr.await#nt:await-expression' title='7.6.2.4&emsp;Await&emsp;[expr.await]'><span id='ntref:await-expression'><span class='textsf'><i >await-expression</i></span></span></a><a class='hidden_link' href='#1.sentence-2'>.</a></div> <div id='note-1' class='note'><div class='texpara'>[<i>Note&nbsp;<a href='#note-1'>1</a></i>:&ensp;<div id='1.sentence-3' class='sentence'>The coroutine is never resumed, and
the <span class='texttt'>unhandled_<span class='shy'></span>stopped</span> of the coroutine caller's promise type is called<a class='hidden_link' href='#1.sentence-3'>.</a></div> â€”&nbsp;<i>end note</i>]</div></div></div><div class='texpara'><span class='codeblock'><span class='keyword'>namespace</span> std<span class='operator'>::</span>execution <span class='curlybracket'>{</span>
  <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><a href='execution.syn#concept:class-type' title='33.4&emsp;Header &lt;execution&gt; synopsis&emsp;[execution.syn]'><span id='conceptref:class-type'><span class='tcode_in_codeblock'><i >class-type</i></span></span></a> Promise<span class='anglebracket'>&gt;</span>
    <span class='keyword'>struct</span> <span id='lib:with_awaitable_senders'><a class='hidden_link' href='#lib:with_awaitable_senders' title='33.13.2&emsp;execution&#x200b;::&#x200b;with_&shy;awaitable_&shy;senders&emsp;[exec.with.awaitable.senders]'>with_awaitable_senders</a></span> <span class='curlybracket'>{</span>
      <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> OtherPromise<span class='anglebracket'>&gt;</span>
        <span class='keyword'>requires</span> <span class='parenthesis'>(</span><span class='operator'>!</span><a href='concept.same#concept:same_as' title='18.4.2&emsp;Concept same_&shy;as&emsp;[concept.same]'><span id='conceptref:same_as'><span class='tcode_in_codeblock'>same_<span class='shy'></span>as</span></span></a><span class='anglebracket'>&lt;</span>OtherPromise, <span class='keyword'>void</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>)</span>
      <span class='keyword'>void</span> set_continuation<span class='parenthesis'>(</span>coroutine_handle<span class='anglebracket'>&lt;</span>OtherPromise<span class='anglebracket'>&gt;</span> h<span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;

      coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span> <span id='lib:with_awaitable_senders,continuation'><span id='lib:continuation,with_awaitable_senders'><a class='hidden_link' href='#lib:with_awaitable_senders,continuation' title='33.13.2&emsp;execution&#x200b;::&#x200b;with_&shy;awaitable_&shy;senders&emsp;[exec.with.awaitable.senders]'>continuation</a></span></span><span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='keyword'>const</span> <span class='keyword'>noexcept</span> <span class='curlybracket'>{</span> <span class='keyword'>return</span> <i >continuation</i>; <span class='curlybracket'>}</span>

      coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span> <span id='lib:with_awaitable_senders,unhandled_stopped'><span id='lib:unhandled_stopped,with_awaitable_senders'><a class='hidden_link' href='#lib:with_awaitable_senders,unhandled_stopped' title='33.13.2&emsp;execution&#x200b;::&#x200b;with_&shy;awaitable_&shy;senders&emsp;[exec.with.awaitable.senders]'>unhandled_stopped</a></span></span><span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span> <span class='curlybracket'>{</span>
        <span class='keyword'>return</span> <i >stopped-handler</i><span class='parenthesis'>(</span><i >continuation</i><span class='operator'>.</span>address<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span>;
      <span class='curlybracket'>}</span>

      <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Value<span class='anglebracket'>&gt;</span>
      <i ><span class='texttt'>see below</span></i> await_transform<span class='parenthesis'>(</span>Value<span class='operator'>&amp;</span><span class='operator'>&amp;</span> value<span class='parenthesis'>)</span>;

    <span class='keyword'>private</span><span class='operator'>:</span>
      <span class='squarebracket'>[</span><span class='squarebracket'>[</span>noreturn<span class='squarebracket'>]</span><span class='squarebracket'>]</span> <span class='keyword'>static</span> coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span>
        <i >default-unhandled-stopped</i><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span> <span class='curlybracket'>{</span>             <span class='comment'>// <i >exposition only</i></span>
        terminate<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
      <span class='curlybracket'>}</span>
      coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span> <i >continuation</i><span class='curlybracket'>{</span><span class='curlybracket'>}</span>;                        <span class='comment'>// <i >exposition only</i></span>
      coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span> <span class='parenthesis'>(</span><span class='operator'>*</span><i >stopped-handler</i><span class='parenthesis'>)</span><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span> <span class='operator'>=</span>   <span class='comment'>// <i >exposition only</i></span>
        <span class='operator'>&amp;</span><i >default-unhandled-stopped</i>;
    <span class='curlybracket'>}</span>;
<span class='curlybracket'>}</span>
</span></div></div><div class='texpara'><div id='lib:with_awaitable_senders,set_continuation'><div id='lib:set_continuation,with_awaitable_senders'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:set_continuation,with_awaitable_senders'>ðŸ”—</a></div><code class='itemdeclcode'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> OtherPromise<span class='anglebracket'>&gt;</span>
  <span class='keyword'>requires</span> <span class='parenthesis'>(</span><span class='operator'>!</span><a href='concept.same#concept:same_as' title='18.4.2&emsp;Concept same_&shy;as&emsp;[concept.same]'><span id='conceptref:same_as_'><span class='texttt'>same_<span class='shy'></span>as</span></span></a><span class='anglebracket'>&lt;</span>OtherPromise, <span class='keyword'>void</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>)</span>
<span class='keyword'>void</span> set_continuation<span class='parenthesis'>(</span>coroutine_handle<span class='anglebracket'>&lt;</span>OtherPromise<span class='anglebracket'>&gt;</span> h<span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;
</code></div></div></div></div><div class='para' id='2'><div class='marginalizedparent'><a class='marginalized' href='#2'>2</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/399b93910d0bb6f5632405ad188e9f4aad0ae99a/source/exec.tex#L5638'>#</a></div><div class='texpara'><div id='2.sentence-1' class='sentence'><i >Effects</i>: Equivalent to:
<span class='codeblock'><i >continuation</i> <span class='operator'>=</span> h;
<span class='keyword'>if</span> <span class='keyword'>constexpr</span> <span class='parenthesis'>(</span> <span class='keyword'>requires</span><span class='parenthesis'>(</span>OtherPromise<span class='operator'>&amp;</span> other<span class='parenthesis'>)</span> <span class='curlybracket'>{</span> other<span class='operator'>.</span>unhandled_stopped<span class='parenthesis'>(</span><span class='parenthesis'>)</span>; <span class='curlybracket'>}</span> <span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  <i >stopped-handler</i> <span class='operator'>=</span> <span class='squarebracket'>[</span><span class='squarebracket'>]</span><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span> p<span class='parenthesis'>)</span> <span class='keyword'>noexcept</span> <span class='operator'>-</span><span class='anglebracket'>&gt;</span> coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span> <span class='curlybracket'>{</span>
    <span class='keyword'>return</span> coroutine_handle<span class='anglebracket'>&lt;</span>OtherPromise<span class='anglebracket'>&gt;</span><span class='operator'>::</span>from_address<span class='parenthesis'>(</span>p<span class='parenthesis'>)</span>
      <span class='operator'>.</span>promise<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='operator'>.</span>unhandled_stopped<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  <span class='curlybracket'>}</span>;
<span class='curlybracket'>}</span> <span class='keyword'>else</span> <span class='curlybracket'>{</span>
  <i >stopped-handler</i> <span class='operator'>=</span> <span class='operator'>&amp;</span><i >default-unhandled-stopped</i>;
<span class='curlybracket'>}</span>
</span></div></div></div></div><div class='texpara'><div id='lib:with_awaitable_senders,await_transform'><div id='lib:await_transform,with_awaitable_senders'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:await_transform,with_awaitable_senders'>ðŸ”—</a></div><code class='itemdeclcode'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Value<span class='anglebracket'>&gt;</span>
<span class='texttt'><i >call-result-t</i></span><span class='anglebracket'>&lt;</span>as_awaitable_t, Value, Promise<span class='operator'>&amp;</span><span class='anglebracket'>&gt;</span> await_transform<span class='parenthesis'>(</span>Value<span class='operator'>&amp;</span><span class='operator'>&amp;</span> value<span class='parenthesis'>)</span>;
</code></div></div></div></div><div class='para' id='3'><div class='marginalizedparent'><a class='marginalized' href='#3'>3</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/399b93910d0bb6f5632405ad188e9f4aad0ae99a/source/exec.tex#L5661'>#</a></div><div class='texpara'><div id='3.sentence-1' class='sentence'><i >Effects</i>: Equivalent to:
<span class='codeblock'><span class='keyword'>return</span> as_awaitable<span class='parenthesis'>(</span>std<span class='operator'>::</span>forward<span class='anglebracket'>&lt;</span>Value<span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>value<span class='parenthesis'>)</span>, <span class='keyword'>static_cast</span><span class='anglebracket'>&lt;</span>Promise<span class='operator'>&amp;</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span>;
</span></div></div></div></div></div></body></html>