<!DOCTYPE html><html lang='en'><head><title>[class.copy.elision]</title><meta charset='UTF-8'/><link rel='stylesheet' type='text/css' href='14882.css'/><link rel='stylesheet' type='text/css' href='expanded.css' title='Normal'/><link rel='alternate stylesheet' type='text/css' href='colored.css' title='Notes and examples colored'/><link rel='alternate stylesheet' type='text/css' href='normative-only.css' title='Notes and examples hidden'/><link rel='icon' href='icon.png'/></head><body><div class='wrapper'><h1 ><a class='secnum' style='min-width:50pt'>11</a> Classes <a class='abbr_ref' href='./#class'>[class]</a></h1><h2 ><a class='secnum' style='min-width:65pt'>11.9</a> Initialization <a class='abbr_ref' href='class.init#class.copy.elision'>[class.init]</a></h2><h3 ><a class='secnum' style='min-width:80pt'>11.9.6</a> Copy/move elision <a class='abbr_ref'>[class.copy.elision]</a></h3><div class='para' id='1'><div class='marginalizedparent'><a class='marginalized' href='#1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/a4b1ffd9e65188ae19c29dffd2db42cb1558cee2/source/classes.tex#L6173'>#</a></div><div class='texpara'><div id='1.sentence-1' class='sentence'><a class='index' id=':temporary,elimination_of'></a><a class='index' id=':constructor,copy,elision'></a><a class='index' id=':constructor,move,elision'></a>When certain criteria are met, an implementation is
allowed to omit the copy/move construction of a class object,
even if the constructor selected for the copy/move operation and/or the
destructor for the object have
<a class='index' id=':side_effects'></a>side effects<a class='hidden_link' href='#1.sentence-1'>.</a></div> <div id='1.sentence-2' class='sentence'>In such cases, the
implementation treats the source and target of the
omitted copy/move operation as simply two different ways of
referring to the same object<a class='hidden_link' href='#1.sentence-2'>.</a></div> <div id='1.sentence-3' class='sentence'>If the first parameter of the
selected constructor is an rvalue reference to the object's type,
the destruction of that object occurs when the target would have been destroyed;
otherwise, the destruction occurs at the later of the times when the
two objects would have been destroyed without the
optimization<a class='hidden_link' href='#1.sentence-3'>.</a><a class='footnoteref' href='#footnote-105' id='footnoteref-105' title='Because only one object is destroyed instead of two, and one copy/move constructor is not executed, there is still one object destroyed for each one constructed.'>105</a></div> <div id='1.sentence-4' class='sentence'>
This elision of copy/move operations, called
<a class='index' id='def:copy_elision|seeconstructor,_copy,_elision'></a><a class='index' id='def:elision,copy|seeconstructor,_copy,_elision'></a><a class='index' id='def:constructor,copy,elision'></a><a class='index' id='def:constructor,move,elision'></a><a class='hidden_link' href='#def:copy_elision' id='def:copy_elision'><i>copy elision</i></a>,
is permitted in the
following circumstances (which may be combined to
eliminate multiple copies):
<ul class='itemize'><li id='1.1'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#1.1'>(1.1)</a></div>in a <span class='texttt'><span class='keyword'>return</span></span> statement in a function with a class return type,
when the <a href='expr.comma#nt:expression' title='7.6.20&emsp;Comma operator&emsp;[expr.comma]'><span id='ntref:expression'><span class='textsf'><i >expression</i></span></span></a> is the name of a non-volatile
object with automatic storage duration (other than a function parameter or a variable
introduced by the <a href='except.pre#nt:exception-declaration' title='14.1&emsp;Preamble&emsp;[except.pre]'><span id='ntref:exception-declaration'><span class='textsf'><i >exception-declaration</i></span></span></a> of a
<a href='except.pre#nt:handler' title='14.1&emsp;Preamble&emsp;[except.pre]'><span id='ntref:handler'><span class='textsf'><i >handler</i></span></span></a> (<a href='except.handle' title='14.4&emsp;Handling an exception'>[except.<span class='shy'></span>handle]</a>))
with the same type (ignoring cv-qualification) as
the function return type, the copy/move operation can be
omitted by constructing the object directly
into the function call's return object</li><li id='1.2'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#1.2'>(1.2)</a></div>in a <a href='expr.throw#nt:throw-expression' title='7.6.18&emsp;Throwing an exception&emsp;[expr.throw]'><span id='ntref:throw-expression'><span class='textsf'><i >throw-expression</i></span></span></a> (<a href='expr.throw' title='7.6.18&emsp;Throwing an exception'>[expr.<span class='shy'></span>throw]</a>), when the operand
is the name of a non-volatile object with automatic storage duration
(other than a function or catch-clause parameter)
that belongs to a scope that does not contain
the innermost enclosing <a href='stmt.block#nt:compound-statement' title='8.4&emsp;Compound statement or block&emsp;[stmt.block]'><span id='ntref:compound-statement'><span class='textsf'><i >compound-statement</i></span></span></a>
associated with a <a href='except.pre#nt:try-block' title='14.1&emsp;Preamble&emsp;[except.pre]'><span id='ntref:try-block'><span class='textsf'><i >try-block</i></span></span></a> (if there is one),
the copy/move operation can be omitted by
constructing the object directly into the exception object</li><li id='1.3'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#1.3'>(1.3)</a></div>in a <a href='dcl.fct.def.coroutine' title='9.5.4&emsp;Coroutine definitions&emsp;[dcl.fct.def.coroutine]'>coroutine</a>, a copy of a coroutine parameter
can be omitted and references to that copy replaced with references to the
corresponding parameter if the meaning of the program will be unchanged except for
the execution of a constructor and destructor for the parameter copy object</li><li id='1.4'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#1.4'>(1.4)</a></div>when the <a href='except.pre#nt:exception-declaration' title='14.1&emsp;Preamble&emsp;[except.pre]'><span id='ntref:exception-declaration_'><span class='textsf'><i >exception-declaration</i></span></span></a> of an
exception handler (<a href='except.pre' title='14.1&emsp;Preamble'>[except.<span class='shy'></span>pre]</a>) declares an object of the same
type (except for cv-qualification) as the exception
object (<a href='except.throw' title='14.2&emsp;Throwing an exception'>[except.<span class='shy'></span>throw]</a>), the copy operation can be omitted by treating
the <a href='except.pre#nt:exception-declaration' title='14.1&emsp;Preamble&emsp;[except.pre]'><span id='ntref:exception-declaration__'><span class='textsf'><i >exception-declaration</i></span></span></a> as an alias for the exception
object if the meaning of the program will be unchanged except for the execution
of constructors and destructors for the object declared by the
<a href='except.pre#nt:exception-declaration' title='14.1&emsp;Preamble&emsp;[except.pre]'><span id='ntref:exception-declaration___'><span class='textsf'><i >exception-declaration</i></span></span></a><a class='hidden_link' href='#1.sentence-4'>.</a> <div class='texpara'><div id='note-1' class='note'><div class='texpara'>[<i>Note&nbsp;<a href='#note-1'>1</a></i>: <div id='1.4.sentence-2' class='sentence'>There cannot be a move from the exception object because it is
always an lvalue<a class='hidden_link' href='#1.4.sentence-2'>.</a></div> —&nbsp;<i>end note</i>]</div></div></div></li></ul></div> <div id='1.sentence-5' class='sentence'>
Copy elision is not permitted
where an expression is evaluated in a context
requiring a constant expression (<a href='expr.const' title='7.7&emsp;Constant expressions'>[expr.<span class='shy'></span>const]</a>)
and in constant initialization (<a href='basic.start.static' title='6.9.3.2&emsp;Static initialization'>[basic.<span class='shy'></span>start.<span class='shy'></span>static]</a>)<a class='hidden_link' href='#1.sentence-5'>.</a></div> <div id='note-2' class='note'><div class='texpara'>[<i>Note&nbsp;<a href='#note-2'>2</a></i>: <div id='1.sentence-6' class='sentence'>It is possible that copy elision is performed
if the same expression
is evaluated in another context<a class='hidden_link' href='#1.sentence-6'>.</a></div> —&nbsp;<i>end note</i>]</div></div></div></div><div class='para nonNormativeOnly' id='2'><div class='marginalizedparent'><a class='marginalized' href='#2'>2</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/a4b1ffd9e65188ae19c29dffd2db42cb1558cee2/source/classes.tex#L6253'>#</a></div><div class='texpara'><div id='example-1' class='example'><div class='texpara'>[<i>Example&nbsp;<a href='#example-1'>1</a></i>: <span class='codeblock'><span class='keyword'>class</span> Thing <span class='curlybracket'>{</span>
<span class='keyword'>public</span><span class='operator'>:</span>
  Thing<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  <span class='operator'>~</span>Thing<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  Thing<span class='parenthesis'>(</span><span class='keyword'>const</span> Thing<span class='operator'>&amp;</span><span class='parenthesis'>)</span>;
<span class='curlybracket'>}</span>;

Thing f<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  Thing t;
  <span class='keyword'>return</span> t;
<span class='curlybracket'>}</span>

Thing t2 <span class='operator'>=</span> f<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;

<span class='keyword'>struct</span> A <span class='curlybracket'>{</span>
  <span class='keyword'>void</span> <span class='operator'>*</span>p;
  <span class='keyword'>constexpr</span> A<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='operator'>:</span> p<span class='parenthesis'>(</span><span class='keyword'>this</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span><span class='curlybracket'>}</span>
<span class='curlybracket'>}</span>;

<span class='keyword'>constexpr</span> A g<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  A loc;
  <span class='keyword'>return</span> loc;
<span class='curlybracket'>}</span>

<span class='keyword'>constexpr</span> A a;          <span class='comment'>// well-formed, <span class='tcode_in_codeblock'>a.p</span> points to <span class='tcode_in_codeblock'>a</span></span>
<span class='keyword'>constexpr</span> A b <span class='operator'>=</span> g<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;    <span class='comment'>// error: <span class='tcode_in_codeblock'>b.p</span> would be dangling (<a href='expr.const' title='7.7&emsp;Constant expressions'>[expr.<span class='shy'></span>const]</a>)</span>

<span class='keyword'>void</span> h<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  A c <span class='operator'>=</span> g<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;            <span class='comment'>// well-formed, <span class='tcode_in_codeblock'>c.p</span> can point to <span class='tcode_in_codeblock'>c</span> or be dangling</span>
<span class='curlybracket'>}</span>
</span> <div id='2.sentence-1' class='sentence'>
Here the criteria for elision can eliminate
the copying of the object <span class='texttt'>t</span> with automatic storage duration
into the result object for the function call <span class='texttt'>f<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>,
which is the non-local object <span class='texttt'>t2</span><a class='hidden_link' href='#2.sentence-1'>.</a></div> <div id='2.sentence-2' class='sentence'>Effectively, the construction of <span class='texttt'>t</span>
can be viewed as directly initializing <span class='texttt'>t2</span>,
and that object's destruction will occur at program exit<a class='hidden_link' href='#2.sentence-2'>.</a></div> <div id='2.sentence-3' class='sentence'>Adding a move constructor to <span class='texttt'>Thing</span> has the same effect, but it is the
move construction from the object with automatic storage duration to <span class='texttt'>t2</span> that is elided<a class='hidden_link' href='#2.sentence-3'>.</a></div> —&nbsp;<i>end example</i>]</div></div></div></div><div class='para nonNormativeOnly' id='3'><div class='marginalizedparent'><a class='marginalized' href='#3'>3</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/a4b1ffd9e65188ae19c29dffd2db42cb1558cee2/source/classes.tex#L6298'>#</a></div><div class='texpara'><div id='example-2' class='example'><div class='texpara'>[<i>Example&nbsp;<a href='#example-2'>2</a></i>: <span class='codeblock'><span class='keyword'>class</span> Thing <span class='curlybracket'>{</span>
<span class='keyword'>public</span><span class='operator'>:</span>
  Thing<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  <span class='operator'>~</span>Thing<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  Thing<span class='parenthesis'>(</span>Thing<span class='operator'>&amp;</span><span class='operator'>&amp;</span><span class='parenthesis'>)</span>;
<span class='keyword'>private</span><span class='operator'>:</span>
  Thing<span class='parenthesis'>(</span><span class='keyword'>const</span> Thing<span class='operator'>&amp;</span><span class='parenthesis'>)</span>;
<span class='curlybracket'>}</span>;

Thing f<span class='parenthesis'>(</span><span class='keyword'>bool</span> b<span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  Thing t;
  <span class='keyword'>if</span> <span class='parenthesis'>(</span>b<span class='parenthesis'>)</span>
    <span class='keyword'>throw</span> t;            <span class='comment'>// OK, <span class='tcode_in_codeblock'>Thing(Thing&amp;&amp;)</span> used (or elided) to throw <span class='tcode_in_codeblock'>t</span></span>
  <span class='keyword'>return</span> t;             <span class='comment'>// OK, <span class='tcode_in_codeblock'>Thing(Thing&amp;&amp;)</span> used (or elided) to return <span class='tcode_in_codeblock'>t</span></span>
<span class='curlybracket'>}</span>

Thing t2 <span class='operator'>=</span> f<span class='parenthesis'>(</span><span class='literal'>false</span><span class='parenthesis'>)</span>;    <span class='comment'>// OK, no extra copy/move performed, <span class='tcode_in_codeblock'>t2</span> constructed by call to <span class='tcode_in_codeblock'>f</span></span>

<span class='keyword'>struct</span> Weird <span class='curlybracket'>{</span>
  Weird<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  Weird<span class='parenthesis'>(</span>Weird<span class='operator'>&amp;</span><span class='parenthesis'>)</span>;
<span class='curlybracket'>}</span>;

Weird g<span class='parenthesis'>(</span><span class='keyword'>bool</span> b<span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  <span class='keyword'>static</span> Weird w1;
  Weird w2;
  <span class='keyword'>if</span> <span class='parenthesis'>(</span>b<span class='parenthesis'>)</span>
    <span class='keyword'>return</span> w1;  <span class='comment'>// OK, uses <span class='tcode_in_codeblock'>Weird(Weird&amp;)</span></span>
  <span class='keyword'>else</span>
    <span class='keyword'>return</span> w2;  <span class='comment'>// error: <span class='tcode_in_codeblock'>w2</span> in this context is an xvalue</span>
<span class='curlybracket'>}</span>

<span class='keyword'>int</span><span class='operator'>&amp;</span> h<span class='parenthesis'>(</span><span class='keyword'>bool</span> b, <span class='keyword'>int</span> i<span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  <span class='keyword'>static</span> <span class='keyword'>int</span> s;
  <span class='keyword'>if</span> <span class='parenthesis'>(</span>b<span class='parenthesis'>)</span>
    <span class='keyword'>return</span> s;   <span class='comment'>// OK</span>
  <span class='keyword'>else</span>
    <span class='keyword'>return</span> i;   <span class='comment'>// error: <span class='tcode_in_codeblock'>i</span> is an xvalue</span>
<span class='curlybracket'>}</span>

<span class='keyword'>decltype</span><span class='parenthesis'>(</span><span class='keyword'>auto</span><span class='parenthesis'>)</span> h2<span class='parenthesis'>(</span>Thing t<span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  <span class='keyword'>return</span> t;     <span class='comment'>// OK, <span class='tcode_in_codeblock'>t</span> is an xvalue and <span class='tcode_in_codeblock'>h2</span>'s return type is <span class='tcode_in_codeblock'>Thing</span></span>
<span class='curlybracket'>}</span>

<span class='keyword'>decltype</span><span class='parenthesis'>(</span><span class='keyword'>auto</span><span class='parenthesis'>)</span> h3<span class='parenthesis'>(</span>Thing t<span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  <span class='keyword'>return</span> <span class='parenthesis'>(</span>t<span class='parenthesis'>)</span>;   <span class='comment'>// OK, <span class='tcode_in_codeblock'>(t)</span> is an xvalue and <span class='tcode_in_codeblock'>h3</span>'s return type is <span class='tcode_in_codeblock'>Thing&amp;&amp;</span></span>
<span class='curlybracket'>}</span>
</span> —&nbsp;<i>end example</i>]</div></div></div></div><div class='para nonNormativeOnly' id='4'><div class='marginalizedparent'><a class='marginalized' href='#4'>4</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/a4b1ffd9e65188ae19c29dffd2db42cb1558cee2/source/classes.tex#L6351'>#</a></div><div class='texpara'><div id='example-3' class='example'><div class='texpara'>[<i>Example&nbsp;<a href='#example-3'>3</a></i>: <span class='codeblock'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> T<span class='anglebracket'>&gt;</span> <span class='keyword'>void</span> g<span class='parenthesis'>(</span><span class='keyword'>const</span> T<span class='operator'>&amp;</span><span class='parenthesis'>)</span>;

<span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> T<span class='anglebracket'>&gt;</span> <span class='keyword'>void</span> f<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  T x;
  <span class='keyword'>try</span> <span class='curlybracket'>{</span>
    T y;
    <span class='keyword'>try</span> <span class='curlybracket'>{</span> g<span class='parenthesis'>(</span>x<span class='parenthesis'>)</span>; <span class='curlybracket'>}</span>
    <span class='keyword'>catch</span> <span class='parenthesis'>(</span><span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
      <span class='keyword'>if</span> <span class='parenthesis'>(</span><span class='comment'>/*...*/</span><span class='parenthesis'>)</span>
        <span class='keyword'>throw</span> x;        <span class='comment'>// does not move</span>
      <span class='keyword'>throw</span> y;          <span class='comment'>// moves</span>
    <span class='curlybracket'>}</span>
    g<span class='parenthesis'>(</span>y<span class='parenthesis'>)</span>;
  <span class='curlybracket'>}</span> <span class='keyword'>catch</span><span class='parenthesis'>(</span><span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
    g<span class='parenthesis'>(</span>x<span class='parenthesis'>)</span>;
    g<span class='parenthesis'>(</span>y<span class='parenthesis'>)</span>;               <span class='comment'>// error: <span class='tcode_in_codeblock'>y</span> is not in scope</span>
  <span class='curlybracket'>}</span>
<span class='curlybracket'>}</span>
</span> —&nbsp;<i>end example</i>]</div></div></div></div><div class='footnoteSeparator'></div><div class='footnote' id='footnote-105'><div class='texpara'><a class='footnotenum' href='#footnote-105'>105)</a><a class='footnoteBacklink' href='#footnoteref-105'>105)</a> <div id='footnote-105.sentence-1' class='sentence'>Because only one object is destroyed instead of two,
and one copy/move constructor
is not executed, there is still one object destroyed for each one constructed<a class='hidden_link' href='#footnote-105.sentence-1'>.</a></div></div></div></div></body></html>