<!DOCTYPE html><html lang='en'><head><title>[exec.coro.util]</title><meta charset='UTF-8'><link rel='stylesheet' type='text/css' href='14882.css'><link rel='stylesheet' type='text/css' href='https://fonts.googleapis.com/css2?family=Noto+Serif'><link rel='stylesheet' type='text/css' href='https://fonts.googleapis.com/css2?family=Noto+Sans'><link rel='stylesheet' type='text/css' href='https://fonts.googleapis.com/css2?family=Noto+Sans+Mono'><link rel='icon' href='icon.png'><link rel='stylesheet' type='text/css' href='expanded.css' title='Normal'><link rel='alternate stylesheet' type='text/css' href='colored.css' title='Notes and examples colored'><link rel='alternate stylesheet' type='text/css' href='normative-only.css' title='Notes and examples hidden'></head><body><div class='wrapper'><h1 ><a class='secnum' style='min-width:50pt'>33</a> Execution control library <a class='abbr_ref' href='./#exec'>[exec]</a></h1><h2 ><a class='secnum' style='min-width:65pt'>33.13</a> Coroutine utilities <a class='abbr_ref'>[exec.coro.util]</a></h2><div id='exec.as.awaitable' class='section'><h3 ><a class='secnum' href='#exec.as.awaitable' style='min-width:80pt'>33.13.1</a> <span class='texttt'>execution&#x200b;::&#x200b;as_<span class='shy'></span>awaitable</span> <a class='abbr_ref' href='exec.as.awaitable'>[exec.as.awaitable]</a></h3><div class='para' id='exec.as.awaitable-1'><div class='marginalizedparent'><a class='marginalized' href='#exec.as.awaitable-1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6653'>#</a></div><div class='texpara'><div id='exec.as.awaitable-1.sentence-1' class='sentence'><span class='texttt'>as_<span class='shy'></span>awaitable</span> transforms an object into one
that is awaitable within a particular coroutine<a class='hidden_link' href='#exec.as.awaitable-1.sentence-1'>.</a></div> <div id='exec.as.awaitable-1.sentence-2' class='sentence'>Subclause [exec.<span class='shy'></span>coro.<span class='shy'></span>util] makes use of
the following exposition-only entities:
<span class='codeblock'><span class='keyword'>namespace</span> std<span class='operator'>::</span>execution <span class='curlybracket'>{</span>
  <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Sndr, <span class='keyword'>class</span> Promise<span class='anglebracket'>&gt;</span>
    <span class='keyword'>concept</span> <a class='hidden_link' href='#concept:awaitable-sender' title='33.13.1&emsp;execution&#x200b;::&#x200b;as_&shy;awaitable&emsp;[exec.as.awaitable]'><span id='concept:awaitable-sender'><span class='tcode_in_codeblock'><i >awaitable-sender</i></span></span></a> <span class='operator'>=</span>
      <a href='execution.syn#concept:single-sender' title='33.4&emsp;Header &lt;execution&gt; synopsis&emsp;[execution.syn]'><span id='conceptref:single-sender'><span class='tcode_in_codeblock'><i >single-sender</i></span></span></a><span class='anglebracket'>&lt;</span>Sndr, env_of_t<span class='anglebracket'>&lt;</span>Promise<span class='anglebracket'>&gt;</span><span class='anglebracket'>&gt;</span> <span class='operator'>&amp;</span><span class='operator'>&amp;</span>
      <a href='exec.snd.concepts#concept:sender_to' title='33.9.3&emsp;Sender concepts&emsp;[exec.snd.concepts]'><span id='conceptref:sender_to'><span class='tcode_in_codeblock'>sender_<span class='shy'></span>to</span></span></a><span class='anglebracket'>&lt;</span>Sndr, <i >awaitable-receiver</i><span class='anglebracket'>&gt;</span> <span class='operator'>&amp;</span><span class='operator'>&amp;</span>    <span class='comment'>// <i ><span class='texttt'>see below</span></i></span>
      <span class='keyword'>requires</span> <span class='parenthesis'>(</span>Promise<span class='operator'>&amp;</span> p<span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
        <span class='curlybracket'>{</span> p<span class='operator'>.</span>unhandled_stopped<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='curlybracket'>}</span> <span class='operator'>-</span><span class='anglebracket'>&gt;</span> <a href='concept.convertible#concept:convertible_to' title='18.4.4&emsp;Concept convertible_&shy;to&emsp;[concept.convertible]'><span id='conceptref:convertible_to'><span class='tcode_in_codeblock'>convertible_<span class='shy'></span>to</span></span></a><span class='anglebracket'>&lt;</span>coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span><span class='anglebracket'>&gt;</span>;
      <span class='curlybracket'>}</span>;

  <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Sndr<span class='anglebracket'>&gt;</span>
    <span class='keyword'>concept</span> <a class='hidden_link' href='#concept:has-queryable-await-completion-adaptor' title='33.13.1&emsp;execution&#x200b;::&#x200b;as_&shy;awaitable&emsp;[exec.as.awaitable]'><span id='concept:has-queryable-await-completion-adaptor'><span class='tcode_in_codeblock'><i >has-queryable-await-completion-adaptor</i></span></span></a> <span class='operator'>=</span>            <span class='comment'>// <i >exposition only</i></span>
      <a href='exec.snd.concepts#concept:sender' title='33.9.3&emsp;Sender concepts&emsp;[exec.snd.concepts]'><span id='conceptref:sender'><span class='tcode_in_codeblock'>sender</span></span></a><span class='anglebracket'>&lt;</span>Sndr<span class='anglebracket'>&gt;</span> <span class='operator'>&amp;</span><span class='operator'>&amp;</span>
      <span class='keyword'>requires</span><span class='parenthesis'>(</span>Sndr<span class='operator'>&amp;</span><span class='operator'>&amp;</span> sender<span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
        get_await_completion_adaptor<span class='parenthesis'>(</span>get_env<span class='parenthesis'>(</span>sender<span class='parenthesis'>)</span><span class='parenthesis'>)</span>;
      <span class='curlybracket'>}</span>;

  <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Sndr, <span class='keyword'>class</span> Promise<span class='anglebracket'>&gt;</span>
    <span class='keyword'>class</span> <i >sender-awaitable</i>;                                     <span class='comment'>// <i >exposition only</i></span>
<span class='curlybracket'>}</span>
</span></div></div></div><div class='para' id='exec.as.awaitable-2'><div class='marginalizedparent'><a class='marginalized' href='#exec.as.awaitable-2'>2</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6680'>#</a></div><div class='texpara'><div id='exec.as.awaitable-2.sentence-1' class='sentence'>The type <span class='texttt'><span class='texttt'><i >sender-awaitable</i></span><span class='anglebracket'>&lt;</span>Sndr, Promise<span class='anglebracket'>&gt;</span></span> is equivalent to:</div></div><div class='texpara'><span class='codeblock'><span class='keyword'>namespace</span> std<span class='operator'>::</span>execution <span class='curlybracket'>{</span>
  <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Sndr, <span class='keyword'>class</span> Promise<span class='anglebracket'>&gt;</span>
  <span class='keyword'>class</span> <i >sender-awaitable</i> <span class='curlybracket'>{</span>
    <span class='keyword'>struct</span> <i >unit</i> <span class='curlybracket'>{</span><span class='curlybracket'>}</span>;                                             <span class='comment'>// <i >exposition only</i></span>
    <span class='keyword'>using</span> <i >value-type</i> <span class='operator'>=</span>                                          <span class='comment'>// <i >exposition only</i></span>
      <i >single-sender-value-type</i><span class='anglebracket'>&lt;</span>Sndr, env_of_t<span class='anglebracket'>&lt;</span>Promise<span class='anglebracket'>&gt;</span><span class='anglebracket'>&gt;</span>;
    <span class='keyword'>using</span> <i >result-type </i><span class='operator'>=</span>                                         <span class='comment'>// <i >exposition only</i></span>
      conditional_t<span class='anglebracket'>&lt;</span>is_void_v<span class='anglebracket'>&lt;</span><i >value-type</i><span class='anglebracket'>&gt;</span>, unit, <i >value-type</i><span class='anglebracket'>&gt;</span>;
    <span class='keyword'>struct</span> <i >awaitable-receiver</i>;                                  <span class='comment'>// <i >exposition only</i></span>

    variant<span class='anglebracket'>&lt;</span>monostate, <i >result-type</i>, exception_ptr<span class='anglebracket'>&gt;</span> <i >result</i><span class='curlybracket'>{</span><span class='curlybracket'>}</span>;    <span class='comment'>// <i >exposition only</i></span>
    connect_result_t<span class='anglebracket'>&lt;</span>Sndr, <i >awaitable-receiver</i><span class='anglebracket'>&gt;</span> <i >state</i>;           <span class='comment'>// <i >exposition only</i></span>

  <span class='keyword'>public</span><span class='operator'>:</span>
    <i >sender-awaitable</i><span class='parenthesis'>(</span>Sndr<span class='operator'>&amp;</span><span class='operator'>&amp;</span> sndr, Promise<span class='operator'>&amp;</span> p<span class='parenthesis'>)</span>;
    <span class='keyword'>static</span> <span class='keyword'>constexpr</span> <span class='keyword'>bool</span> await_ready<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span> <span class='curlybracket'>{</span> <span class='keyword'>return</span> <span class='literal'>false</span>; <span class='curlybracket'>}</span>
    <span class='keyword'>void</span> await_suspend<span class='parenthesis'>(</span>coroutine_handle<span class='anglebracket'>&lt;</span>Promise<span class='anglebracket'>&gt;</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span> <span class='curlybracket'>{</span> start<span class='parenthesis'>(</span><i >state</i><span class='parenthesis'>)</span>; <span class='curlybracket'>}</span>
    <i >value-type</i> await_resume<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  <span class='curlybracket'>}</span>;
<span class='curlybracket'>}</span>
</span></div></div><div class='para' id='exec.as.awaitable-3'><div class='marginalizedparent'><a class='marginalized' href='#exec.as.awaitable-3'>3</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6706'>#</a></div><div class='texpara'><div id='exec.as.awaitable-3.sentence-1' class='sentence'><span class='texttt'><i >awaitable-receiver</i></span> is equivalent to:
<span class='codeblock'><span class='keyword'>struct</span> <i >awaitable-receiver</i> <span class='curlybracket'>{</span>
  <span class='keyword'>using</span> receiver_concept <span class='operator'>=</span> receiver_t;
  variant<span class='anglebracket'>&lt;</span>monostate, <i >result-type</i>, exception_ptr<span class='anglebracket'>&gt;</span><span class='operator'>*</span> <i >result-ptr</i>;   <span class='comment'>// <i >exposition only</i></span>
  coroutine_handle<span class='anglebracket'>&lt;</span>Promise<span class='anglebracket'>&gt;</span> <i >continuation</i>;                       <span class='comment'>// <i >exposition only</i></span>
  <span class='comment'>// <i ><span class='texttt'>see below</span></i></span>
<span class='curlybracket'>}</span>;
</span></div></div></div><div class='para' id='exec.as.awaitable-4'><div class='marginalizedparent'><a class='marginalized' href='#exec.as.awaitable-4'>4</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6717'>#</a></div><div class='texpara'><div id='exec.as.awaitable-4.sentence-1' class='sentence'>Let <span class='texttt'>rcvr</span> be an rvalue expression of type <span class='texttt'><i >awaitable-receiver</i></span>,
let <span class='texttt'>crcvr</span> be a const lvalue that refers to <span class='texttt'>rcvr</span>,
let <span class='texttt'>vs</span> be a pack of subexpressions, and
let <span class='texttt'>err</span> be an expression of type <span class='texttt'>Err</span><a class='hidden_link' href='#exec.as.awaitable-4.sentence-1'>.</a></div> <div id='exec.as.awaitable-4.sentence-2' class='sentence'>Then:
<ul class='itemize'><li id='exec.as.awaitable-4.1'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#exec.as.awaitable-4.1'>(4.1)</a></div>If <span class='texttt'><a href='concept.constructible#concept:constructible_from' title='18.4.11&emsp;Concept constructible_&shy;from&emsp;[concept.constructible]'><span id='conceptref:constructible_from'><span class='texttt'>constructible_<span class='shy'></span>from</span></span></a><span class='anglebracket'>&lt;</span><span class='texttt'><i >result-type</i></span>, <span class='keyword'>decltype</span><span class='parenthesis'>(</span><span class='parenthesis'>(</span>vs<span class='parenthesis'>)</span><span class='parenthesis'>)</span><span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='anglebracket'>&gt;</span></span>
is satisfied,
the expression <span class='texttt'>set_<span class='shy'></span>value<span class='parenthesis'>(</span><br>rcvr, vs<span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='parenthesis'>)</span></span> is equivalent to:
<span class='codeblock'><span class='keyword'>try</span> <span class='curlybracket'>{</span>
  rcvr<span class='operator'>.</span><i >result-ptr</i><span class='operator'>-</span><span class='anglebracket'>&gt;</span><span class='keyword'>template</span> emplace<span class='anglebracket'>&lt;</span><span class='literal'>1</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>vs<span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='parenthesis'>)</span>;
<span class='curlybracket'>}</span> <span class='keyword'>catch</span><span class='parenthesis'>(</span><span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  rcvr<span class='operator'>.</span><i >result-ptr</i><span class='operator'>-</span><span class='anglebracket'>&gt;</span><span class='keyword'>template</span> emplace<span class='anglebracket'>&lt;</span><span class='literal'>2</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>current_exception<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span>;
<span class='curlybracket'>}</span>
rcvr<span class='operator'>.</span><i >continuation</i><span class='operator'>.</span>resume<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
</span> <div class='texpara'><div id='exec.as.awaitable-4.1.sentence-2' class='sentence'>
Otherwise, <span class='texttt'>set_<span class='shy'></span>value<span class='parenthesis'>(</span>rcvr, vs<span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='parenthesis'>)</span></span> is ill-formed<a class='hidden_link' href='#exec.as.awaitable-4.1.sentence-2'>.</a></div></div></li><li id='exec.as.awaitable-4.2'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#exec.as.awaitable-4.2'>(4.2)</a></div>The expression <span class='texttt'>set_<span class='shy'></span>error<span class='parenthesis'>(</span>rcvr, err<span class='parenthesis'>)</span></span> is equivalent to:
<span class='codeblock'>rcvr<span class='operator'>.</span><i >result-ptr</i><span class='operator'>-</span><span class='anglebracket'>&gt;</span><span class='keyword'>template</span> emplace<span class='anglebracket'>&lt;</span><span class='literal'>2</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span><i >AS-EXCEPT-PTR</i><span class='parenthesis'>(</span>err<span class='parenthesis'>)</span><span class='parenthesis'>)</span>;    <span class='comment'>// see <a href='exec.general' title='33.1&emsp;General'>[exec.<span class='shy'></span>general]</a></span>
rcvr<span class='operator'>.</span><i >continuation</i><span class='operator'>.</span>resume<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
</span></li><li id='exec.as.awaitable-4.3'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#exec.as.awaitable-4.3'>(4.3)</a></div>The expression <span class='texttt'>set_<span class='shy'></span>stopped<span class='parenthesis'>(</span>rcvr<span class='parenthesis'>)</span></span> is equivalent to:
<span class='codeblock'><span class='keyword'>static_cast</span><span class='anglebracket'>&lt;</span>coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>rcvr<span class='operator'>.</span><i >continuation</i><span class='operator'>.</span>promise<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='operator'>.</span>unhandled_stopped<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span><span class='operator'>.</span>resume<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
</span></li><li id='exec.as.awaitable-4.4'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#exec.as.awaitable-4.4'>(4.4)</a></div>For any expression <span class='texttt'>tag</span>
whose type satisfies <a href='execution.syn#concept:forwarding-query' title='33.4&emsp;Header &lt;execution&gt; synopsis&emsp;[execution.syn]'><span id='conceptref:forwarding-query'><span class='texttt'><i >forwarding-query</i></span></span></a> and
for any pack of subexpressions <span class='texttt'>as</span>,
<span class='texttt'>get_<span class='shy'></span>env<span class='parenthesis'>(</span>crcvr<span class='parenthesis'>)</span><span class='operator'>.</span>query<span class='parenthesis'>(</span>tag, as<span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='parenthesis'>)</span></span> is expression-equivalent to:
<span class='codeblock'>tag<span class='parenthesis'>(</span>get_env<span class='parenthesis'>(</span>as_const<span class='parenthesis'>(</span>crcvr<span class='operator'>.</span><i >continuation</i><span class='operator'>.</span>promise<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span>, as<span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='parenthesis'>)</span>
</span></li></ul></div></div></div><div class='texpara'><div class='itemdecl' id='exec.as.awaitable-itemdecl:1'><div class='marginalizedparent'><a class='itemDeclLink' href='#exec.as.awaitable-itemdecl:1'>🔗</a></div><code class='itemdeclcode'><span class='texttt'><i >sender-awaitable</i></span><span class='parenthesis'>(</span>Sndr<span class='operator'>&amp;</span><span class='operator'>&amp;</span> sndr, Promise<span class='operator'>&amp;</span> p<span class='parenthesis'>)</span>;
</code></div></div><div class='para' id='exec.as.awaitable-5'><div class='marginalizedparent'><a class='marginalized' href='#exec.as.awaitable-5'>5</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6762'>#</a></div><div class='texpara'><div id='exec.as.awaitable-5.sentence-1' class='sentence'><i >Effects</i>: Initializes <span class='texttt'><i >state</i></span> with
<span class='codeblock'>connect<span class='parenthesis'>(</span>std<span class='operator'>::</span>forward<span class='anglebracket'>&lt;</span>Sndr<span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>sndr<span class='parenthesis'>)</span>,
        <i >awaitable-receiver</i><span class='curlybracket'>{</span>addressof<span class='parenthesis'>(</span>result<span class='parenthesis'>)</span>, coroutine_handle<span class='anglebracket'>&lt;</span>Promise<span class='anglebracket'>&gt;</span><span class='operator'>::</span>from_promise<span class='parenthesis'>(</span>p<span class='parenthesis'>)</span><span class='curlybracket'>}</span><span class='parenthesis'>)</span>
</span></div></div></div></div><div class='texpara'><div class='itemdecl' id='exec.as.awaitable-itemdecl:2'><div class='marginalizedparent'><a class='itemDeclLink' href='#exec.as.awaitable-itemdecl:2'>🔗</a></div><code class='itemdeclcode'><span class='texttt'><i >value-type</i></span> await_resume<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
</code></div></div><div class='para' id='exec.as.awaitable-6'><div class='marginalizedparent'><a class='marginalized' href='#exec.as.awaitable-6'>6</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6776'>#</a></div><div class='texpara'><div id='exec.as.awaitable-6.sentence-1' class='sentence'><i >Effects</i>: Equivalent to:
<span class='codeblock'><span class='keyword'>if</span> <span class='parenthesis'>(</span><i >result</i><span class='operator'>.</span>index<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='operator'>=</span><span class='operator'>=</span> <span class='literal'>2</span><span class='parenthesis'>)</span>
  rethrow_exception<span class='parenthesis'>(</span>get<span class='anglebracket'>&lt;</span><span class='literal'>2</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span><i >result</i><span class='parenthesis'>)</span><span class='parenthesis'>)</span>;
<span class='keyword'>if</span> <span class='keyword'>constexpr</span> <span class='parenthesis'>(</span><span class='operator'>!</span>is_void_v<span class='anglebracket'>&lt;</span><i >value-type</i><span class='anglebracket'>&gt;</span><span class='parenthesis'>)</span>
  <span class='keyword'>return</span> std<span class='operator'>::</span>forward<span class='anglebracket'>&lt;</span><i >value-type</i><span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>get<span class='anglebracket'>&lt;</span><span class='literal'>1</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span><i >result</i><span class='parenthesis'>)</span><span class='parenthesis'>)</span>;
</span></div></div></div></div><div class='para' id='exec.as.awaitable-7'><div class='marginalizedparent'><a class='marginalized' href='#exec.as.awaitable-7'>7</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6787'>#</a></div><div class='texpara'><div id='exec.as.awaitable-7.sentence-1' class='sentence'><span class='texttt'>as_<span class='shy'></span>awaitable</span> is a customization point object<a class='hidden_link' href='#exec.as.awaitable-7.sentence-1'>.</a></div> <div id='exec.as.awaitable-7.sentence-2' class='sentence'>For subexpressions <span class='texttt'>expr</span> and <span class='texttt'>p</span>
where <span class='texttt'>p</span> is an lvalue,
<span class='texttt'>Expr</span> names the type <span class='texttt'><span class='keyword'>decltype</span><span class='parenthesis'>(</span><span class='parenthesis'>(</span>expr<span class='parenthesis'>)</span><span class='parenthesis'>)</span></span> and
<span class='texttt'>Promise</span> names the type <span class='texttt'>decay_<span class='shy'></span>t<span class='anglebracket'>&lt;</span><span class='keyword'>decltype</span><span class='parenthesis'>(</span><span class='parenthesis'>(</span>p<span class='parenthesis'>)</span><span class='parenthesis'>)</span><span class='anglebracket'>&gt;</span></span>,
<span class='texttt'>as_<span class='shy'></span>awaitable<span class='parenthesis'>(</span>expr, p<span class='parenthesis'>)</span></span> is expression-equivalent to,
except that the evaluations of <span class='texttt'>expr</span> and <span class='texttt'>p</span>
are indeterminately sequenced:
<ul class='itemize'><li id='exec.as.awaitable-7.1'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#exec.as.awaitable-7.1'>(7.1)</a></div><div class='texpara'><div id='exec.as.awaitable-7.1.sentence-1' class='sentence'><span class='texttt'>expr<span class='operator'>.</span>as_<span class='shy'></span>awaitable<span class='parenthesis'>(</span>p<span class='parenthesis'>)</span></span> if that expression is well-formed<a class='hidden_link' href='#exec.as.awaitable-7.1.sentence-1'>.</a></div></div><div class='texpara'><div id='exec.as.awaitable-7.1.sentence-2' class='sentence'><i >Mandates</i>: <span class='texttt'><a href='exec.awaitable#concept:is-awaitable' title='33.9.4&emsp;Awaitable helpers&emsp;[exec.awaitable]'><span id='conceptref:is-awaitable'><span class='texttt'><i >is-awaitable</i></span></span></a><span class='anglebracket'>&lt;</span>A, Promise<span class='anglebracket'>&gt;</span></span> is <span class='texttt'><span class='literal'>true</span></span>,
where <span class='texttt'>A</span> is the type of the expression above<a class='hidden_link' href='#exec.as.awaitable-7.1.sentence-2'>.</a></div></div></li><li id='exec.as.awaitable-7.2'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#exec.as.awaitable-7.2'>(7.2)</a></div><div class='texpara'><div id='exec.as.awaitable-7.2.sentence-1' class='sentence'>Otherwise, <span class='texttt'><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='parenthesis'>(</span>p<span class='parenthesis'>)</span>, expr<span class='parenthesis'>)</span></span>
if <span class='texttt'><a href='exec.awaitable#concept:is-awaitable' title='33.9.4&emsp;Awaitable helpers&emsp;[exec.awaitable]'><span id='conceptref:is-awaitable_'><span class='texttt'><i >is-awaitable</i></span></span></a><span class='anglebracket'>&lt;</span>Expr, U<span class='anglebracket'>&gt;</span></span> is <span class='texttt'><span class='literal'>true</span></span>,
where <span class='texttt'>U</span> is an unspecified class type
that is not <span class='texttt'>Promise</span> and
that lacks a member named <span class='texttt'>await_<span class='shy'></span>transform</span><a class='hidden_link' href='#exec.as.awaitable-7.2.sentence-1'>.</a></div></div><div class='texpara'><div id='exec.as.awaitable-7.2.sentence-2' class='sentence'><i >Preconditions</i>: <span class='texttt'><a href='exec.awaitable#concept:is-awaitable' title='33.9.4&emsp;Awaitable helpers&emsp;[exec.awaitable]'><span id='conceptref:is-awaitable__'><span class='texttt'><i >is-awaitable</i></span></span></a><span class='anglebracket'>&lt;</span>Expr, Promise<span class='anglebracket'>&gt;</span></span> is <span class='texttt'><span class='literal'>true</span></span> and
the expression <span class='texttt'><span class='keyword'>co_<span class='shy'></span>await</span> expr</span>
in a coroutine with promise type <span class='texttt'>U</span> is expression-equivalent to
the same expression in a coroutine with promise type <span class='texttt'>Promise</span><a class='hidden_link' href='#exec.as.awaitable-7.2.sentence-2'>.</a></div></div></li><li id='exec.as.awaitable-7.3'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#exec.as.awaitable-7.3'>(7.3)</a></div><div class='texpara'><div id='exec.as.awaitable-7.3.sentence-1' class='sentence'>Otherwise, <span class='texttt'><span class='texttt'><i >sender-awaitable</i></span><span class='curlybracket'>{</span><span class='texttt'><i >adapted-expr</i></span>, p<span class='curlybracket'>}</span></span>
if
<span class='codeblock'><i >has-queryable-await-completion-adaptor</i><span class='anglebracket'>&lt;</span>Expr<span class='anglebracket'>&gt;</span>
</span>
and
<span class='codeblock'><i >awaitable-sender</i><span class='anglebracket'>&lt;</span><span class='keyword'>decltype</span><span class='parenthesis'>(</span><span class='parenthesis'>(</span><i >adapted-expr</i><span class='parenthesis'>)</span><span class='parenthesis'>)</span>, Promise<span class='anglebracket'>&gt;</span><span class='curlybracket'>}</span>
</span>
are both satisfied, where <span class='texttt'><i >adapted-expr</i></span> is
<span class='texttt'>get_<span class='shy'></span>await_<span class='shy'></span>completion_<span class='shy'></span>adaptor<span class='parenthesis'>(</span>get_<span class='shy'></span>env<span class='parenthesis'>(</span>expr<span class='parenthesis'>)</span><span class='parenthesis'>)</span><span class='parenthesis'>(</span>expr<span class='parenthesis'>)</span></span>,
except that <span class='texttt'>expr</span> is evaluated only once<a class='hidden_link' href='#exec.as.awaitable-7.3.sentence-1'>.</a></div></div></li><li id='exec.as.awaitable-7.4'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#exec.as.awaitable-7.4'>(7.4)</a></div><div class='texpara'><div id='exec.as.awaitable-7.4.sentence-1' class='sentence'>Otherwise, <span class='texttt'><span class='texttt'><i >sender-awaitable</i></span><span class='curlybracket'>{</span>expr, p<span class='curlybracket'>}</span></span>
if <span class='texttt'><a href='#concept:awaitable-sender' title='33.13.1&emsp;execution&#x200b;::&#x200b;as_&shy;awaitable&emsp;[exec.as.awaitable]'><span id='conceptref:awaitable-sender'><span class='texttt'><i >awaitable-sender</i></span></span></a><span class='anglebracket'>&lt;</span>Expr, Promise<span class='anglebracket'>&gt;</span></span> is <span class='texttt'><span class='literal'>true</span></span><a class='hidden_link' href='#exec.as.awaitable-7.4.sentence-1'>.</a></div></div></li><li id='exec.as.awaitable-7.5'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#exec.as.awaitable-7.5'>(7.5)</a></div><div class='texpara'><div id='exec.as.awaitable-7.5.sentence-1' class='sentence'>Otherwise, <span class='texttt'><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='parenthesis'>(</span>p<span class='parenthesis'>)</span>, expr<span class='parenthesis'>)</span></span><a class='hidden_link' href='#exec.as.awaitable-7.5.sentence-1'>.</a></div></div></li></ul></div></div></div></div><div id='exec.with.awaitable.senders' class='section'><h3 ><a class='secnum' href='#exec.with.awaitable.senders' style='min-width:80pt'>33.13.2</a> <span class='texttt'>execution&#x200b;::&#x200b;with_<span class='shy'></span>awaitable_<span class='shy'></span>senders</span> <a class='abbr_ref' href='exec.with.awaitable.senders'>[exec.with.awaitable.senders]</a></h3><div class='para' id='exec.with.awaitable.senders-1'><div class='marginalizedparent'><a class='marginalized' href='#exec.with.awaitable.senders-1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6837'>#</a></div><div class='texpara'><div id='exec.with.awaitable.senders-1.sentence-1' class='sentence'><span class='texttt'>with_<span class='shy'></span>awaitable_<span class='shy'></span>senders</span>,
when used as the base class of a coroutine promise type,
makes senders awaitable in that coroutine type<a class='hidden_link' href='#exec.with.awaitable.senders-1.sentence-1'>.</a></div></div><div class='texpara'><div id='exec.with.awaitable.senders-1.sentence-2' class='sentence'>In addition, it provides a default implementation of <span class='texttt'>unhandled_<span class='shy'></span>stopped</span>
such that if a sender completes by calling <span class='texttt'>set_<span class='shy'></span>stopped</span>,
it is treated as if an uncatchable "stopped" exception were thrown
from the <a href='expr.await#nt:await-expression' title='7.6.2.4&emsp;Await&emsp;[expr.await]'><span id='ntref:await-expression'><span class='textsf'><i >await-expression</i></span></span></a><a class='hidden_link' href='#exec.with.awaitable.senders-1.sentence-2'>.</a></div> <div id='exec.with.awaitable.senders-note-1' class='note'><div class='texpara'>[<i>Note&nbsp;<a href='#exec.with.awaitable.senders-note-1'>1</a></i>:&ensp;<div id='exec.with.awaitable.senders-1.sentence-3' class='sentence'>The coroutine is never resumed, and
the <span class='texttt'>unhandled_<span class='shy'></span>stopped</span> of the coroutine caller's promise type is called<a class='hidden_link' href='#exec.with.awaitable.senders-1.sentence-3'>.</a></div> —&nbsp;<i>end note</i>]</div></div></div><div class='texpara'><span class='codeblock'><span class='keyword'>namespace</span> std<span class='operator'>::</span>execution <span class='curlybracket'>{</span>
  <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><a href='execution.syn#concept:class-type' title='33.4&emsp;Header &lt;execution&gt; synopsis&emsp;[execution.syn]'><span id='conceptref:class-type'><span class='tcode_in_codeblock'><i >class-type</i></span></span></a> Promise<span class='anglebracket'>&gt;</span>
    <span class='keyword'>struct</span> <span id='lib:with_awaitable_senders'><a class='hidden_link' href='#lib:with_awaitable_senders' title='33.13.2&emsp;execution&#x200b;::&#x200b;with_&shy;awaitable_&shy;senders&emsp;[exec.with.awaitable.senders]'>with_awaitable_senders</a></span> <span class='curlybracket'>{</span>
      <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> OtherPromise<span class='anglebracket'>&gt;</span>
        <span class='keyword'>requires</span> <span class='parenthesis'>(</span><span class='operator'>!</span><a href='concept.same#concept:same_as' title='18.4.2&emsp;Concept same_&shy;as&emsp;[concept.same]'><span id='conceptref:same_as'><span class='tcode_in_codeblock'>same_<span class='shy'></span>as</span></span></a><span class='anglebracket'>&lt;</span>OtherPromise, <span class='keyword'>void</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>)</span>
      <span class='keyword'>void</span> set_continuation<span class='parenthesis'>(</span>coroutine_handle<span class='anglebracket'>&lt;</span>OtherPromise<span class='anglebracket'>&gt;</span> h<span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;

      coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span> <span id='lib:with_awaitable_senders,continuation'><span id='lib:continuation,with_awaitable_senders'><a class='hidden_link' href='#lib:with_awaitable_senders,continuation' title='33.13.2&emsp;execution&#x200b;::&#x200b;with_&shy;awaitable_&shy;senders&emsp;[exec.with.awaitable.senders]'>continuation</a></span></span><span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='keyword'>const</span> <span class='keyword'>noexcept</span> <span class='curlybracket'>{</span> <span class='keyword'>return</span> <i >continuation</i>; <span class='curlybracket'>}</span>

      coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span> <span id='lib:with_awaitable_senders,unhandled_stopped'><span id='lib:unhandled_stopped,with_awaitable_senders'><a class='hidden_link' href='#lib:with_awaitable_senders,unhandled_stopped' title='33.13.2&emsp;execution&#x200b;::&#x200b;with_&shy;awaitable_&shy;senders&emsp;[exec.with.awaitable.senders]'>unhandled_stopped</a></span></span><span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span> <span class='curlybracket'>{</span>
        <span class='keyword'>return</span> <i >stopped-handler</i><span class='parenthesis'>(</span><i >continuation</i><span class='operator'>.</span>address<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span>;
      <span class='curlybracket'>}</span>

      <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Value<span class='anglebracket'>&gt;</span>
      <i ><span class='texttt'>see below</span></i> await_transform<span class='parenthesis'>(</span>Value<span class='operator'>&amp;</span><span class='operator'>&amp;</span> value<span class='parenthesis'>)</span>;

    <span class='keyword'>private</span><span class='operator'>:</span>
      <span class='squarebracket'>[</span><span class='squarebracket'>[</span>noreturn<span class='squarebracket'>]</span><span class='squarebracket'>]</span> <span class='keyword'>static</span> coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span>
        <i >default-unhandled-stopped</i><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span> <span class='curlybracket'>{</span>             <span class='comment'>// <i >exposition only</i></span>
        terminate<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
      <span class='curlybracket'>}</span>
      coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span> <i >continuation</i><span class='curlybracket'>{</span><span class='curlybracket'>}</span>;                        <span class='comment'>// <i >exposition only</i></span>
      coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span> <span class='parenthesis'>(</span><span class='operator'>*</span><i >stopped-handler</i><span class='parenthesis'>)</span><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span> <span class='operator'>=</span>   <span class='comment'>// <i >exposition only</i></span>
        <span class='operator'>&amp;</span><i >default-unhandled-stopped</i>;
    <span class='curlybracket'>}</span>;
<span class='curlybracket'>}</span>
</span></div></div><div class='texpara'><div id='lib:with_awaitable_senders,set_continuation'><div id='lib:set_continuation,with_awaitable_senders'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:set_continuation,with_awaitable_senders'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> OtherPromise<span class='anglebracket'>&gt;</span>
  <span class='keyword'>requires</span> <span class='parenthesis'>(</span><span class='operator'>!</span><a href='concept.same#concept:same_as' title='18.4.2&emsp;Concept same_&shy;as&emsp;[concept.same]'><span id='conceptref:same_as_'><span class='texttt'>same_<span class='shy'></span>as</span></span></a><span class='anglebracket'>&lt;</span>OtherPromise, <span class='keyword'>void</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>)</span>
<span class='keyword'>void</span> set_continuation<span class='parenthesis'>(</span>coroutine_handle<span class='anglebracket'>&lt;</span>OtherPromise<span class='anglebracket'>&gt;</span> h<span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;
</code></div></div></div></div><div class='para' id='exec.with.awaitable.senders-2'><div class='marginalizedparent'><a class='marginalized' href='#exec.with.awaitable.senders-2'>2</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6888'>#</a></div><div class='texpara'><div id='exec.with.awaitable.senders-2.sentence-1' class='sentence'><i >Effects</i>: Equivalent to:
<span class='codeblock'><i >continuation</i> <span class='operator'>=</span> h;
<span class='keyword'>if</span> <span class='keyword'>constexpr</span> <span class='parenthesis'>(</span> <span class='keyword'>requires</span><span class='parenthesis'>(</span>OtherPromise<span class='operator'>&amp;</span> other<span class='parenthesis'>)</span> <span class='curlybracket'>{</span> other<span class='operator'>.</span>unhandled_stopped<span class='parenthesis'>(</span><span class='parenthesis'>)</span>; <span class='curlybracket'>}</span> <span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
  <i >stopped-handler</i> <span class='operator'>=</span> <span class='squarebracket'>[</span><span class='squarebracket'>]</span><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span> p<span class='parenthesis'>)</span> <span class='keyword'>noexcept</span> <span class='operator'>-</span><span class='anglebracket'>&gt;</span> coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span> <span class='curlybracket'>{</span>
    <span class='keyword'>return</span> coroutine_handle<span class='anglebracket'>&lt;</span>OtherPromise<span class='anglebracket'>&gt;</span><span class='operator'>::</span>from_address<span class='parenthesis'>(</span>p<span class='parenthesis'>)</span>
      <span class='operator'>.</span>promise<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='operator'>.</span>unhandled_stopped<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
  <span class='curlybracket'>}</span>;
<span class='curlybracket'>}</span> <span class='keyword'>else</span> <span class='curlybracket'>{</span>
  <i >stopped-handler</i> <span class='operator'>=</span> <span class='operator'>&amp;</span><i >default-unhandled-stopped</i>;
<span class='curlybracket'>}</span>
</span></div></div></div></div><div class='texpara'><div id='lib:with_awaitable_senders,await_transform'><div id='lib:await_transform,with_awaitable_senders'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:await_transform,with_awaitable_senders'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Value<span class='anglebracket'>&gt;</span>
<span class='texttt'><i >call-result-t</i></span><span class='anglebracket'>&lt;</span>as_awaitable_t, Value, Promise<span class='operator'>&amp;</span><span class='anglebracket'>&gt;</span> await_transform<span class='parenthesis'>(</span>Value<span class='operator'>&amp;</span><span class='operator'>&amp;</span> value<span class='parenthesis'>)</span>;
</code></div></div></div></div><div class='para' id='exec.with.awaitable.senders-3'><div class='marginalizedparent'><a class='marginalized' href='#exec.with.awaitable.senders-3'>3</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6911'>#</a></div><div class='texpara'><div id='exec.with.awaitable.senders-3.sentence-1' class='sentence'><i >Effects</i>: Equivalent to:
<span class='codeblock'><span class='keyword'>return</span> as_awaitable<span class='parenthesis'>(</span>std<span class='operator'>::</span>forward<span class='anglebracket'>&lt;</span>Value<span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>value<span class='parenthesis'>)</span>, <span class='keyword'>static_cast</span><span class='anglebracket'>&lt;</span>Promise<span class='operator'>&amp;</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span>;
</span></div></div></div></div></div><div id='exec.affine.on' class='section'><h3 ><a class='secnum' href='#exec.affine.on' style='min-width:80pt'>33.13.3</a> <span class='texttt'>execution&#x200b;::&#x200b;affine_<span class='shy'></span>on</span> <a class='abbr_ref' href='exec.affine.on'>[exec.affine.on]</a></h3><div class='para' id='exec.affine.on-1'><div class='marginalizedparent'><a class='marginalized' href='#exec.affine.on-1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6921'>#</a></div><div class='texpara'><div id='exec.affine.on-1.sentence-1' class='sentence'><span class='texttt'>affine_<span class='shy'></span>on</span> adapts a sender into one that completes on
the specified scheduler<a class='hidden_link' href='#exec.affine.on-1.sentence-1'>.</a></div> <div id='exec.affine.on-1.sentence-2' class='sentence'>If the algorithm determines that the adapted sender already completes
on the correct scheduler it can avoid any scheduling operation<a class='hidden_link' href='#exec.affine.on-1.sentence-2'>.</a></div></div></div><div class='para' id='exec.affine.on-2'><div class='marginalizedparent'><a class='marginalized' href='#exec.affine.on-2'>2</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6927'>#</a></div><div class='texpara'><div id='exec.affine.on-2.sentence-1' class='sentence'>The name <span class='texttt'>affine_<span class='shy'></span>on</span> denotes a pipeable sender adaptor
object<a class='hidden_link' href='#exec.affine.on-2.sentence-1'>.</a></div> <div id='exec.affine.on-2.sentence-2' class='sentence'>For subexpressions <span class='texttt'>sch</span> and <span class='texttt'>sndr</span>, if <span class='texttt'><span class='keyword'>decltype</span><span class='parenthesis'>(</span><span class='parenthesis'>(</span>sch<span class='parenthesis'>)</span><span class='parenthesis'>)</span></span>
does not satisfy <a href='exec.sched#concept:scheduler' title='33.6&emsp;Schedulers&emsp;[exec.sched]'><span id='conceptref:scheduler'><span class='texttt'>scheduler</span></span></a>, or <span class='texttt'><span class='keyword'>decltype</span><span class='parenthesis'>(</span><span class='parenthesis'>(</span>sndr<span class='parenthesis'>)</span><span class='parenthesis'>)</span></span>
does not satisfy <a href='exec.snd.concepts#concept:sender' title='33.9.3&emsp;Sender concepts&emsp;[exec.snd.concepts]'><span id='conceptref:sender_'><span class='texttt'>sender</span></span></a>, <span class='texttt'>affine_<span class='shy'></span>on<span class='parenthesis'>(</span>sndr, sch<span class='parenthesis'>)</span></span>
is ill-formed<a class='hidden_link' href='#exec.affine.on-2.sentence-2'>.</a></div></div></div><div class='para' id='exec.affine.on-3'><div class='marginalizedparent'><a class='marginalized' href='#exec.affine.on-3'>3</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6935'>#</a></div><div class='texpara'><div id='exec.affine.on-3.sentence-1' class='sentence'>Otherwise, the expression <span class='texttt'>affine_<span class='shy'></span>on<span class='parenthesis'>(</span>sndr, sch<span class='parenthesis'>)</span></span> is
expression-equivalent to:
<span class='codeblock'>transform_sender<span class='parenthesis'>(</span><i >get-domain-early</i><span class='parenthesis'>(</span>sndr<span class='parenthesis'>)</span>, <i >make-sender</i><span class='parenthesis'>(</span>affine_on, sch, sndr<span class='parenthesis'>)</span><span class='parenthesis'>)</span>
</span>
except that <span class='texttt'>sndr</span> is evaluated only once<a class='hidden_link' href='#exec.affine.on-3.sentence-1'>.</a></div></div></div><div class='para' id='exec.affine.on-4'><div class='marginalizedparent'><a class='marginalized' href='#exec.affine.on-4'>4</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6943'>#</a></div><div class='texpara'><div id='exec.affine.on-4.sentence-1' class='sentence'>The exposition-only class template <span class='texttt'><i >impls-for</i></span>
is specialized for <span class='texttt'>affine_<span class='shy'></span>on_<span class='shy'></span>t</span> as follows:</div></div><div class='texpara'><span class='codeblock'><span class='keyword'>namespace</span> std<span class='operator'>::</span>execution <span class='curlybracket'>{</span>
  <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span>
  <span class='keyword'>struct</span> <i >impls-for</i><span class='anglebracket'>&lt;</span>affine_on_t<span class='anglebracket'>&gt;</span> <span class='operator'>:</span> <i >default-impls</i> <span class='curlybracket'>{</span>
    <span class='keyword'>static</span> <span class='keyword'>constexpr</span> <span class='keyword'>auto</span> <i >get-attrs</i> <span class='operator'>=</span>
      <span class='squarebracket'>[</span><span class='squarebracket'>]</span><span class='parenthesis'>(</span><span class='keyword'>const</span> <span class='keyword'>auto</span><span class='operator'>&amp;</span> data, <span class='keyword'>const</span> <span class='keyword'>auto</span><span class='operator'>&amp;</span> child<span class='parenthesis'>)</span> <span class='keyword'>noexcept</span> <span class='operator'>-</span><span class='anglebracket'>&gt;</span> <span class='keyword'>decltype</span><span class='parenthesis'>(</span><span class='keyword'>auto</span><span class='parenthesis'>)</span> <span class='curlybracket'>{</span>
        <span class='keyword'>return</span> <i >JOIN-ENV</i><span class='parenthesis'>(</span><i >SCHED-ATTRS</i><span class='parenthesis'>(</span>data<span class='parenthesis'>)</span>, <i >FWD-ENV</i><span class='parenthesis'>(</span>get_env<span class='parenthesis'>(</span>child<span class='parenthesis'>)</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span>;
      <span class='curlybracket'>}</span>;
  <span class='curlybracket'>}</span>;
<span class='curlybracket'>}</span>
</span></div></div><div class='para' id='exec.affine.on-5'><div class='marginalizedparent'><a class='marginalized' href='#exec.affine.on-5'>5</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6959'>#</a></div><div class='texpara'><div id='exec.affine.on-5.sentence-1' class='sentence'>Let <span class='texttt'><i >out_<span class='shy'></span>sndr</i></span> be a subexpression denoting a sender
returned from <span class='texttt'>affine_<span class='shy'></span>on<span class='parenthesis'>(</span>sndr, sch<span class='parenthesis'>)</span></span> or one equal to such,
and let <span class='texttt'><i >OutSndr</i></span> be the type <span class='texttt'><span class='keyword'>decltype</span><span class='parenthesis'>(</span><span class='parenthesis'>(</span><i >out_<span class='shy'></span>sndr</i><span class='parenthesis'>)</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#exec.affine.on-5.sentence-1'>.</a></div> <div id='exec.affine.on-5.sentence-2' class='sentence'>Let <span class='texttt'><i >out_<span class='shy'></span>rcvr</i></span> be a subexpression denoting a receiver that
has an environment of type <span class='texttt'>Env</span> such that <span class='texttt'><a href='exec.snd.concepts#concept:sender_in' title='33.9.3&emsp;Sender concepts&emsp;[exec.snd.concepts]'><span id='conceptref:sender_in'><span class='texttt'>sender_<span class='shy'></span>in</span></span></a><span class='anglebracket'>&lt;</span><i >OutSndr</i>, Env<span class='anglebracket'>&gt;</span></span>
is <span class='texttt'><span class='literal'>true</span></span><a class='hidden_link' href='#exec.affine.on-5.sentence-2'>.</a></div> <div id='exec.affine.on-5.sentence-3' class='sentence'>Let <span class='texttt'><i >op</i></span> be an lvalue referring to the operation state that
results from connecting <span class='texttt'><i >out_<span class='shy'></span>sndr</i></span> to <span class='texttt'><i >out_<span class='shy'></span>rcvr</i></span><a class='hidden_link' href='#exec.affine.on-5.sentence-3'>.</a></div> <div id='exec.affine.on-5.sentence-4' class='sentence'>Calling <span class='texttt'>start<span class='parenthesis'>(</span><i >op</i><span class='parenthesis'>)</span></span> will start <span class='texttt'>sndr</span> on the current
execution agent and execute completion operations on <span class='texttt'><i >out_<span class='shy'></span>rcvr</i></span>
on an execution agent of the execution resource associated with
<span class='texttt'>sch</span><a class='hidden_link' href='#exec.affine.on-5.sentence-4'>.</a></div> <div id='exec.affine.on-5.sentence-5' class='sentence'>If the current execution resource is the same as the execution
resource associated with <span class='texttt'>sch</span>, the completion operation on
<span class='texttt'><i >out_<span class='shy'></span>rcvr</i></span> may be called before <span class='texttt'>start<span class='parenthesis'>(</span>op<span class='parenthesis'>)</span></span> completes<a class='hidden_link' href='#exec.affine.on-5.sentence-5'>.</a></div> <div id='exec.affine.on-5.sentence-6' class='sentence'>If scheduling onto <span class='texttt'>sch</span> fails, an error completion on
<span class='texttt'><i >out_<span class='shy'></span>rcvr</i></span> shall be executed on an unspecified execution
agent<a class='hidden_link' href='#exec.affine.on-5.sentence-6'>.</a></div></div></div></div><div id='exec.inline.scheduler' class='section'><h3 ><a class='secnum' href='#exec.inline.scheduler' style='min-width:80pt'>33.13.4</a> <span class='texttt'>execution&#x200b;::&#x200b;inline_<span class='shy'></span>scheduler</span> <a class='abbr_ref' href='exec.inline.scheduler'>[exec.inline.scheduler]</a></h3><div class='texpara'><span class='codeblock'><span class='keyword'>namespace</span> std<span class='operator'>::</span>execution <span class='curlybracket'>{</span>
  <span class='keyword'>class</span> <span id='lib:inline_scheduler'><a class='hidden_link' href='#lib:inline_scheduler' title='33.13.4&emsp;execution&#x200b;::&#x200b;inline_&shy;scheduler&emsp;[exec.inline.scheduler]'>inline_scheduler</a></span> <span class='curlybracket'>{</span>
    <span class='keyword'>class</span> <i >inline-sender</i>;                <span class='comment'>// <i >exposition only</i></span>

    <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><a href='exec.recv.concepts#concept:receiver' title='33.7.1&emsp;Receiver concepts&emsp;[exec.recv.concepts]'><span id='conceptref:receiver'><span class='tcode_in_codeblock'>receiver</span></span></a> R<span class='anglebracket'>&gt;</span>
      <span class='keyword'>class</span> <i >inline-state</i>;               <span class='comment'>// <i >exposition only</i></span>

  <span class='keyword'>public</span><span class='operator'>:</span>
    <span class='keyword'>using</span> scheduler_concept <span class='operator'>=</span> scheduler_t;

    <span class='keyword'>constexpr</span> <i >inline-sender</i> schedule<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span> <span class='curlybracket'>{</span> <span class='keyword'>return</span> <span class='curlybracket'>{</span><span class='curlybracket'>}</span>; <span class='curlybracket'>}</span>
    <span class='keyword'>constexpr</span> <span class='keyword'>bool</span> <span class='keyword'>operator</span><span class='operator'>=</span><span class='operator'>=</span><span class='parenthesis'>(</span><span class='keyword'>const</span> inline_scheduler<span class='operator'>&amp;</span><span class='parenthesis'>)</span> <span class='keyword'>const</span> <span class='keyword'>noexcept</span> <span class='operator'>=</span> <span class='keyword'>default</span>;
  <span class='curlybracket'>}</span>;
<span class='curlybracket'>}</span>
</span></div><div class='para' id='exec.inline.scheduler-1'><div class='marginalizedparent'><a class='marginalized' href='#exec.inline.scheduler-1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L6998'>#</a></div><div class='texpara'><div id='exec.inline.scheduler-1.sentence-1' class='sentence'><span class='texttt'>inline_<span class='shy'></span>scheduler</span> is a class that models
<a href='exec.sched#concept:scheduler' title='33.6&emsp;Schedulers&emsp;[exec.sched]'><span id='conceptref:scheduler_'><span class='texttt'>scheduler</span></span></a> (<a href='exec.sched' title='33.6&emsp;Schedulers'>[exec.<span class='shy'></span>sched]</a>)<a class='hidden_link' href='#exec.inline.scheduler-1.sentence-1'>.</a></div> <div id='exec.inline.scheduler-1.sentence-2' class='sentence'>All objects of type <span class='texttt'>inline_<span class='shy'></span>scheduler</span> are equal<a class='hidden_link' href='#exec.inline.scheduler-1.sentence-2'>.</a></div></div></div><div class='para' id='exec.inline.scheduler-2'><div class='marginalizedparent'><a class='marginalized' href='#exec.inline.scheduler-2'>2</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7003'>#</a></div><div class='texpara'><div id='exec.inline.scheduler-2.sentence-1' class='sentence'><span class='texttt'><i >inline-sender</i></span> is an exposition-only type that satisfies
<a href='exec.snd.concepts#concept:sender' title='33.9.3&emsp;Sender concepts&emsp;[exec.snd.concepts]'><span id='conceptref:sender__'><span class='texttt'>sender</span></span></a><a class='hidden_link' href='#exec.inline.scheduler-2.sentence-1'>.</a></div> <div id='exec.inline.scheduler-2.sentence-2' class='sentence'>The type <span class='texttt'>completion_<span class='shy'></span>signatures_<span class='shy'></span>of_<span class='shy'></span>t<span class='anglebracket'>&lt;</span><span class='texttt'><i >inline-sender</i></span><span class='anglebracket'>&gt;</span></span>
is <span class='texttt'>completion_<span class='shy'></span>signatures<span class='anglebracket'>&lt;</span>set_<span class='shy'></span>value_<span class='shy'></span>t<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='anglebracket'>&gt;</span></span><a class='hidden_link' href='#exec.inline.scheduler-2.sentence-2'>.</a></div></div></div><div class='para' id='exec.inline.scheduler-3'><div class='marginalizedparent'><a class='marginalized' href='#exec.inline.scheduler-3'>3</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7009'>#</a></div><div class='texpara'><div id='exec.inline.scheduler-3.sentence-1' class='sentence'>Let <span class='texttt'>sndr</span> be an expression of type <span class='texttt'><i >inline-sender</i></span>,
let <span class='texttt'>rcvr</span> be an expression such that
<span class='texttt'><a href='exec.recv.concepts#concept:receiver_of' title='33.7.1&emsp;Receiver concepts&emsp;[exec.recv.concepts]'><span id='conceptref:receiver_of'><span class='texttt'>receiver_<span class='shy'></span>of</span></span></a><span class='anglebracket'>&lt;</span><span class='keyword'>decltype</span><span class='parenthesis'>(</span><span class='parenthesis'>(</span>rcvr<span class='parenthesis'>)</span><span class='parenthesis'>)</span>, CS<span class='anglebracket'>&gt;</span></span> is <span class='texttt'><span class='literal'>true</span></span>
where <span class='texttt'>CS</span> is <span class='texttt'>completion_<span class='shy'></span>signatures<span class='anglebracket'>&lt;</span>set_<span class='shy'></span>value_<span class='shy'></span>t<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='anglebracket'>&gt;</span></span>,
then:
<ul class='itemize'><li id='exec.inline.scheduler-3.1'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#exec.inline.scheduler-3.1'>(3.1)</a></div>the expression <span class='texttt'>connect<span class='parenthesis'>(</span>sndr, rcvr<span class='parenthesis'>)</span></span> has
type <span class='texttt'><span class='texttt'><i >inline-state</i></span><span class='anglebracket'>&lt;</span>remove_<span class='shy'></span>cvref_<span class='shy'></span>t<span class='anglebracket'>&lt;</span><span class='keyword'>decltype</span><span class='parenthesis'>(</span><span class='parenthesis'>(</span>rcvr<span class='parenthesis'>)</span><span class='parenthesis'>)</span><span class='anglebracket'>&gt;</span><span class='anglebracket'>&gt;</span></span>
and is potentially-throwing if and only if
<span class='texttt'><span class='parenthesis'>(</span><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='parenthesis'>)</span>sndr, <span class='keyword'>auto</span><span class='parenthesis'>(</span>rcvr<span class='parenthesis'>)</span><span class='parenthesis'>)</span></span> is potentially-throwing, and</li><li id='exec.inline.scheduler-3.2'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#exec.inline.scheduler-3.2'>(3.2)</a></div>the expression
<span class='texttt'>get_<span class='shy'></span>completion_<span class='shy'></span>scheduler<span class='anglebracket'>&lt;</span>set_<span class='shy'></span>value_<span class='shy'></span>t<span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>get_<span class='shy'></span>env<span class='parenthesis'>(</span>sndr<span class='parenthesis'>)</span><span class='parenthesis'>)</span></span> has
type&#x200b; <span class='texttt'>inline_<span class='shy'></span>scheduler</span> and is potentially-throwing
if and only if <span class='texttt'>get_<span class='shy'></span>env<span class='parenthesis'>(</span>sndr<span class='parenthesis'>)</span></span> is potentially-throwing<a class='hidden_link' href='#exec.inline.scheduler-3.sentence-1'>.</a></li></ul></div></div></div><div class='para' id='exec.inline.scheduler-4'><div class='marginalizedparent'><a class='marginalized' href='#exec.inline.scheduler-4'>4</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7026'>#</a></div><div class='texpara'><div id='exec.inline.scheduler-4.sentence-1' class='sentence'>Let <span class='texttt'><i >o</i></span> be a non-<span class='texttt'><span class='keyword'>const</span></span> lvalue of type
<span class='texttt'><span class='texttt'><i >inline-state</i></span><span class='anglebracket'>&lt;</span>Rcvr<span class='anglebracket'>&gt;</span></span>, and let <span class='texttt'>REC<span class='parenthesis'>(</span><i >o</i><span class='parenthesis'>)</span></span> be
a non-<span class='texttt'><span class='keyword'>const</span></span> lvalue reference to an object of type <span class='texttt'>Rcvr</span> that
was initialized with the expression <span class='texttt'>rcvr</span> passed to an
invocation of <span class='texttt'>connect</span> that returned <span class='texttt'><i >o</i></span>, then:
<ul class='itemize'><li id='exec.inline.scheduler-4.1'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#exec.inline.scheduler-4.1'>(4.1)</a></div>the object to which <span class='texttt'>REC<span class='parenthesis'>(</span><i >o</i><span class='parenthesis'>)</span></span> refers remains valid for
the lifetime of the object to which <span class='texttt'><i >o</i></span> refers, and</li><li id='exec.inline.scheduler-4.2'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#exec.inline.scheduler-4.2'>(4.2)</a></div>the expression <span class='texttt'>start<span class='parenthesis'>(</span><i >o</i><span class='parenthesis'>)</span></span> is equivalent to
<span class='texttt'>set_<span class='shy'></span>value<span class='parenthesis'>(</span>std<span class='operator'>&#x200b;::&#x200b;</span>move<span class='parenthesis'>(</span>REC<span class='parenthesis'>(</span><i >o</i><span class='parenthesis'>)</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#exec.inline.scheduler-4.sentence-1'>.</a></li></ul></div></div></div></div><div id='exec.task.scheduler' class='section'><h3 ><a class='secnum' href='#exec.task.scheduler' style='min-width:80pt'>33.13.5</a> <span class='texttt'>execution&#x200b;::&#x200b;task_<span class='shy'></span>scheduler</span> <a class='abbr_ref' href='exec.task.scheduler'>[exec.task.scheduler]</a></h3><div class='texpara'><span class='codeblock'><span class='keyword'>namespace</span> std<span class='operator'>::</span>execution <span class='curlybracket'>{</span>
  <span class='keyword'>class</span> <span id='lib:task_scheduler'><a class='hidden_link' href='#lib:task_scheduler' title='33.13.5&emsp;execution&#x200b;::&#x200b;task_&shy;scheduler&emsp;[exec.task.scheduler]'>task_scheduler</a></span> <span class='curlybracket'>{</span>
    <span class='keyword'>class</span> <i >ts-sender</i>;                    <span class='comment'>// <i >exposition only</i></span>

    <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><a href='exec.recv.concepts#concept:receiver' title='33.7.1&emsp;Receiver concepts&emsp;[exec.recv.concepts]'><span id='conceptref:receiver_'><span class='tcode_in_codeblock'>receiver</span></span></a> R<span class='anglebracket'>&gt;</span>
      <span class='keyword'>class</span> <i >state</i>;                      <span class='comment'>// <i >exposition only</i></span>

  <span class='keyword'>public</span><span class='operator'>:</span>
    <span class='keyword'>using</span> scheduler_concept <span class='operator'>=</span> scheduler_t;

    <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Sch, <span class='keyword'>class</span> Allocator <span class='operator'>=</span> allocator<span class='anglebracket'>&lt;</span><span class='keyword'>void</span><span class='anglebracket'>&gt;</span><span class='anglebracket'>&gt;</span>
      <span class='keyword'>requires</span> <span class='parenthesis'>(</span><span class='operator'>!</span><a href='concept.same#concept:same_as' title='18.4.2&emsp;Concept same_&shy;as&emsp;[concept.same]'><span id='conceptref:same_as__'><span class='tcode_in_codeblock'>same_<span class='shy'></span>as</span></span></a><span class='anglebracket'>&lt;</span>task_scheduler, remove_cvref_t<span class='anglebracket'>&lt;</span>Sch<span class='anglebracket'>&gt;</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>)</span>
        <span class='operator'>&amp;</span><span class='operator'>&amp;</span> <a href='exec.sched#concept:scheduler' title='33.6&emsp;Schedulers&emsp;[exec.sched]'><span id='conceptref:scheduler__'><span class='tcode_in_codeblock'>scheduler</span></span></a><span class='anglebracket'>&lt;</span>Sch<span class='anglebracket'>&gt;</span>
    <span class='keyword'>explicit</span> task_scheduler<span class='parenthesis'>(</span>Sch<span class='operator'>&amp;</span><span class='operator'>&amp;</span> sch, Allocator alloc <span class='operator'>=</span> <span class='curlybracket'>{</span><span class='curlybracket'>}</span><span class='parenthesis'>)</span>;

    <i >ts-sender</i> schedule<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;

    <span class='keyword'>friend</span> <span class='keyword'>bool</span> <span class='keyword'>operator</span><span class='operator'>=</span><span class='operator'>=</span><span class='parenthesis'>(</span><span class='keyword'>const</span> task_scheduler<span class='operator'>&amp;</span> lhs, <span class='keyword'>const</span> task_scheduler<span class='operator'>&amp;</span> rhs<span class='parenthesis'>)</span>
        <span class='keyword'>noexcept</span>;
    <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Sch<span class='anglebracket'>&gt;</span>
      <span class='keyword'>requires</span> <span class='parenthesis'>(</span><span class='operator'>!</span><a href='concept.same#concept:same_as' title='18.4.2&emsp;Concept same_&shy;as&emsp;[concept.same]'><span id='conceptref:same_as___'><span class='tcode_in_codeblock'>same_<span class='shy'></span>as</span></span></a><span class='anglebracket'>&lt;</span>task_scheduler, Sch<span class='anglebracket'>&gt;</span><span class='parenthesis'>)</span>
      <span class='operator'>&amp;</span><span class='operator'>&amp;</span> <a href='exec.sched#concept:scheduler' title='33.6&emsp;Schedulers&emsp;[exec.sched]'><span id='conceptref:scheduler___'><span class='tcode_in_codeblock'>scheduler</span></span></a><span class='anglebracket'>&lt;</span>Sch<span class='anglebracket'>&gt;</span>
    <span class='keyword'>friend</span> <span class='keyword'>bool</span> <span class='keyword'>operator</span><span class='operator'>=</span><span class='operator'>=</span><span class='parenthesis'>(</span><span class='keyword'>const</span> task_scheduler<span class='operator'>&amp;</span> lhs, <span class='keyword'>const</span> Sch<span class='operator'>&amp;</span> rhs<span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;

  <span class='keyword'>private</span><span class='operator'>:</span>
    shared_ptr<span class='anglebracket'>&lt;</span><span class='keyword'>void</span><span class='anglebracket'>&gt;</span> <i >sch_</i>; <span class='comment'>// <i >exposition only</i></span>
  <span class='curlybracket'>}</span>;
<span class='curlybracket'>}</span>
</span></div><div class='para' id='exec.task.scheduler-1'><div class='marginalizedparent'><a class='marginalized' href='#exec.task.scheduler-1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7072'>#</a></div><div class='texpara'><div id='exec.task.scheduler-1.sentence-1' class='sentence'><span class='texttt'>task_<span class='shy'></span>scheduler</span> is a class that models
<a href='exec.sched#concept:scheduler' title='33.6&emsp;Schedulers&emsp;[exec.sched]'><span id='conceptref:scheduler____'><span class='texttt'>scheduler</span></span></a> (<a href='exec.sched' title='33.6&emsp;Schedulers'>[exec.<span class='shy'></span>sched]</a>)<a class='hidden_link' href='#exec.task.scheduler-1.sentence-1'>.</a></div> <div id='exec.task.scheduler-1.sentence-2' class='sentence'>Given an object <span class='texttt'>s</span> of type <span class='texttt'>task_<span class='shy'></span>scheduler</span>, let
<span class='texttt'><span class='texttt'><i >SCHED</i></span><span class='parenthesis'>(</span>s<span class='parenthesis'>)</span></span> be the object owned by <span class='texttt'>s<span class='operator'>.</span><span class='texttt'><i >sch_<span class='shy'></span></i></span></span><a class='hidden_link' href='#exec.task.scheduler-1.sentence-2'>.</a></div></div></div><div class='texpara'><div id='lib:task_scheduler,constructor'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:task_scheduler,constructor'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Sch, <span class='keyword'>class</span> Allocator <span class='operator'>=</span> allocator<span class='anglebracket'>&lt;</span><span class='keyword'>void</span><span class='anglebracket'>&gt;</span><span class='anglebracket'>&gt;</span>
  <span class='keyword'>requires</span><span class='parenthesis'>(</span><span class='operator'>!</span><a href='concept.same#concept:same_as' title='18.4.2&emsp;Concept same_&shy;as&emsp;[concept.same]'><span id='conceptref:same_as____'><span class='texttt'>same_<span class='shy'></span>as</span></span></a><span class='anglebracket'>&lt;</span>task_scheduler, remove_cvref_t<span class='anglebracket'>&lt;</span>Sch<span class='anglebracket'>&gt;</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>)</span> <span class='operator'>&amp;</span><span class='operator'>&amp;</span> <a href='exec.sched#concept:scheduler' title='33.6&emsp;Schedulers&emsp;[exec.sched]'><span id='conceptref:scheduler_____'><span class='texttt'>scheduler</span></span></a><span class='anglebracket'>&lt;</span>Sch<span class='anglebracket'>&gt;</span>
<span class='keyword'>explicit</span> task_scheduler<span class='parenthesis'>(</span>Sch<span class='operator'>&amp;</span><span class='operator'>&amp;</span> sch, Allocator alloc <span class='operator'>=</span> <span class='curlybracket'>{</span><span class='curlybracket'>}</span><span class='parenthesis'>)</span>;
</code></div></div></div><div class='para' id='exec.task.scheduler-2'><div class='marginalizedparent'><a class='marginalized' href='#exec.task.scheduler-2'>2</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7085'>#</a></div><div class='texpara'><div id='exec.task.scheduler-2.sentence-1' class='sentence'><i >Effects</i>: Initialize <span class='texttt'><i >sch_<span class='shy'></span></i></span> with
<span class='texttt'>allocate_<span class='shy'></span>shared<span class='anglebracket'>&lt;</span>remove_<span class='shy'></span>cvref_<span class='shy'></span>t<span class='anglebracket'>&lt;</span>Sch<span class='anglebracket'>&gt;</span><span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>alloc,&#x200b; std<span class='operator'>&#x200b;::&#x200b;</span>forward<span class='anglebracket'>&lt;</span>Sch<span class='anglebracket'>&gt;</span>&#x200b;<span class='parenthesis'>(</span>sch<span class='parenthesis'>)</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#exec.task.scheduler-2.sentence-1'>.</a></div></div></div></div><div class='para' id='exec.task.scheduler-3'><div class='marginalizedparent'><a class='marginalized' href='#exec.task.scheduler-3'>3</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7090'>#</a></div><div class='texpara'><div id='exec.task.scheduler-3.sentence-1' class='sentence'><i >Recommended practice</i>: Implementations should avoid the use of dynamically
allocated memory for small scheduler objects<a class='hidden_link' href='#exec.task.scheduler-3.sentence-1'>.</a></div></div></div></div><div class='para' id='exec.task.scheduler-4'><div class='marginalizedparent'><a class='marginalized' href='#exec.task.scheduler-4'>4</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7095'>#</a></div><div class='texpara'><div id='exec.task.scheduler-4.sentence-1' class='sentence'><i >Remarks</i>: Any allocations performed by construction of <span class='texttt'><i >ts-sender</i></span> or
<span class='texttt'><i >state</i></span> objects resulting from calls on <span class='texttt'><span class='operator'>*</span><span class='keyword'>this</span></span> are
performed using a copy of <span class='texttt'>alloc</span><a class='hidden_link' href='#exec.task.scheduler-4.sentence-1'>.</a></div></div></div></div><div class='texpara'><div id='lib:task_scheduler,scheduler'><div id='lib:scheduler,task_scheduler'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:scheduler,task_scheduler'>🔗</a></div><code class='itemdeclcode'><span class='texttt'><i >ts-sender</i></span> schedule<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
</code></div></div></div></div><div class='para' id='exec.task.scheduler-5'><div class='marginalizedparent'><a class='marginalized' href='#exec.task.scheduler-5'>5</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7107'>#</a></div><div class='texpara'><div id='exec.task.scheduler-5.sentence-1' class='sentence'><i >Effects</i>: Returns an object of type <span class='texttt'><i >ts-sender</i></span> containing a sender
initialized with <span class='texttt'>schedule<span class='parenthesis'>(</span>&#x200b;<span class='texttt'><i >SCHED</i></span>&#x200b;<span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#exec.task.scheduler-5.sentence-1'>.</a></div></div></div></div><div class='texpara'><div id='lib:task_scheduler,operator=='><div id='lib:operator==,task_scheduler'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:operator==,task_scheduler'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>bool</span> <span class='keyword'>operator</span><span class='operator'>=</span><span class='operator'>=</span><span class='parenthesis'>(</span><span class='keyword'>const</span> task_scheduler<span class='operator'>&amp;</span> lhs, <span class='keyword'>const</span> task_scheduler<span class='operator'>&amp;</span> rhs<span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;
</code></div></div></div></div><div class='para' id='exec.task.scheduler-6'><div class='marginalizedparent'><a class='marginalized' href='#exec.task.scheduler-6'>6</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7118'>#</a></div><div class='texpara'><div id='exec.task.scheduler-6.sentence-1' class='sentence'><i >Effects</i>: Equivalent to: <span class='texttt'><span class='keyword'>return</span> lhs <span class='operator'>=</span><span class='operator'>=</span> <span class='texttt'><i >SCHED</i></span><span class='parenthesis'>(</span>rhs<span class='parenthesis'>)</span>;</span></div></div></div></div><div class='texpara'><div id='lib:task_scheduler,operator==_'><div id='lib:operator==,task_scheduler_'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:operator==,task_scheduler_'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Sch<span class='anglebracket'>&gt;</span>
  <span class='keyword'>requires</span> <span class='parenthesis'>(</span><span class='operator'>!</span><a href='concept.same#concept:same_as' title='18.4.2&emsp;Concept same_&shy;as&emsp;[concept.same]'><span id='conceptref:same_as_____'><span class='texttt'>same_<span class='shy'></span>as</span></span></a><span class='anglebracket'>&lt;</span>task_scheduler, Sch<span class='anglebracket'>&gt;</span><span class='parenthesis'>)</span>
        <span class='operator'>&amp;</span><span class='operator'>&amp;</span> <a href='exec.sched#concept:scheduler' title='33.6&emsp;Schedulers&emsp;[exec.sched]'><span id='conceptref:scheduler______'><span class='texttt'>scheduler</span></span></a><span class='anglebracket'>&lt;</span>Sch<span class='anglebracket'>&gt;</span>
<span class='keyword'>bool</span> <span class='keyword'>operator</span><span class='operator'>=</span><span class='operator'>=</span><span class='parenthesis'>(</span><span class='keyword'>const</span> task_scheduler<span class='operator'>&amp;</span> lhs, <span class='keyword'>const</span> Sch<span class='operator'>&amp;</span> rhs<span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;
</code></div></div></div></div><div class='para' id='exec.task.scheduler-7'><div class='marginalizedparent'><a class='marginalized' href='#exec.task.scheduler-7'>7</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7131'>#</a></div><div class='texpara'><div id='exec.task.scheduler-7.sentence-1' class='sentence'><i >Returns</i>: <span class='texttt'><span class='literal'>false</span></span> if type of <span class='texttt'><span class='texttt'><i >SCHED</i></span><span class='parenthesis'>(</span>lhs<span class='parenthesis'>)</span></span> is not <span class='texttt'>Sch</span>,
otherwise <span class='texttt'><span class='texttt'><i >SCHED</i></span><span class='parenthesis'>(</span>lhs<span class='parenthesis'>)</span> <span class='operator'>=</span><span class='operator'>=</span> rhs;</span></div></div></div></div><div class='para' id='exec.task.scheduler-8'><div class='marginalizedparent'><a class='marginalized' href='#exec.task.scheduler-8'>8</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7137'>#</a></div><div class='texpara'><div id='exec.task.scheduler-8.sentence-1' class='sentence'><span class='codeblock'><span class='keyword'>namespace</span> std<span class='operator'>::</span>execution <span class='curlybracket'>{</span>
  <span class='keyword'>class</span> task_scheduler<span class='operator'>::</span><i >ts-sender</i> <span class='curlybracket'>{</span>     <span class='comment'>// <i >exposition only</i></span>
  <span class='keyword'>public</span><span class='operator'>:</span>
    <span class='keyword'>using</span> sender_concept <span class='operator'>=</span> sender_t;

    <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><a href='exec.recv.concepts#concept:receiver' title='33.7.1&emsp;Receiver concepts&emsp;[exec.recv.concepts]'><span id='conceptref:receiver__'><span class='tcode_in_codeblock'>receiver</span></span></a> Rcvr<span class='anglebracket'>&gt;</span>
      <i >state</i><span class='anglebracket'>&lt;</span>Rcvr<span class='anglebracket'>&gt;</span> connect<span class='parenthesis'>(</span>Rcvr<span class='operator'>&amp;</span><span class='operator'>&amp;</span> rcvr<span class='parenthesis'>)</span>;
  <span class='curlybracket'>}</span>;
<span class='curlybracket'>}</span>
</span>
<span class='texttt'><i >ts-sender</i></span> is an exposition-only class that models
<a href='exec.snd.concepts#concept:sender' title='33.9.3&emsp;Sender concepts&emsp;[exec.snd.concepts]'><span id='conceptref:sender___'><span class='texttt'>sender</span></span></a> (<a href='exec.snd' title='33.9&emsp;Senders'>[exec.<span class='shy'></span>snd]</a>) and for which
<span class='texttt'>completion_<span class='shy'></span>signatures_<span class='shy'></span>of_<span class='shy'></span>t<span class='anglebracket'>&lt;</span><span class='texttt'><i >ts-sender</i></span><span class='anglebracket'>&gt;</span></span> denotes:
<span class='codeblock'>completion_signatures<span class='anglebracket'>&lt;</span>
  set_value_t<span class='parenthesis'>(</span><span class='parenthesis'>)</span>,
  set_error_t<span class='parenthesis'>(</span>error_code<span class='parenthesis'>)</span>,
  set_error_t<span class='parenthesis'>(</span>exception_ptr<span class='parenthesis'>)</span>,
  set_stopped_t<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='anglebracket'>&gt;</span>
</span></div></div></div><div class='para' id='exec.task.scheduler-9'><div class='marginalizedparent'><a class='marginalized' href='#exec.task.scheduler-9'>9</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7160'>#</a></div><div class='texpara'><div id='exec.task.scheduler-9.sentence-1' class='sentence'>Let <span class='texttt'><i >sch</i></span> be an object of type <span class='texttt'>task_<span class='shy'></span>scheduler</span>
and let <span class='texttt'>sndr</span> be an object of type <span class='texttt'><i >ts-sender</i></span> obtained
from <span class='texttt'>schedule<span class='parenthesis'>(</span><i >sch</i><span class='parenthesis'>)</span></span><a class='hidden_link' href='#exec.task.scheduler-9.sentence-1'>.</a></div> <div id='exec.task.scheduler-9.sentence-2' class='sentence'>Then <span class='texttt'>get_<span class='shy'></span>completion_<span class='shy'></span>scheduler<span class='anglebracket'>&lt;</span>set_<span class='shy'></span>value_<span class='shy'></span>t<span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>get_<span class='shy'></span>env<span class='parenthesis'>(</span>sndr<span class='parenthesis'>)</span><span class='parenthesis'>)</span> <span class='operator'>=</span><span class='operator'>=</span> <i >sch</i></span>
is <span class='texttt'><span class='literal'>true</span></span><a class='hidden_link' href='#exec.task.scheduler-9.sentence-2'>.</a></div> <div id='exec.task.scheduler-9.sentence-3' class='sentence'>The object <span class='texttt'><span class='texttt'><i >SENDER</i></span><span class='parenthesis'>(</span>sndr<span class='parenthesis'>)</span></span> is the sender object contained by
<span class='texttt'>sndr</span> or an object move constructed from it<a class='hidden_link' href='#exec.task.scheduler-9.sentence-3'>.</a></div></div></div><div class='texpara'><div id='lib:task_scheduler::ts-sender,connect'><div id='lib:connect,task_scheduler::ts-sender'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:connect,task_scheduler::ts-sender'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><a href='exec.recv.concepts#concept:receiver' title='33.7.1&emsp;Receiver concepts&emsp;[exec.recv.concepts]'><span id='conceptref:receiver___'><span class='texttt'>receiver</span></span></a> Rcvr<span class='anglebracket'>&gt;</span>
  <span class='texttt'><i >state</i></span><span class='anglebracket'>&lt;</span>Rcvr<span class='anglebracket'>&gt;</span> connect<span class='parenthesis'>(</span>Rcvr<span class='operator'>&amp;</span><span class='operator'>&amp;</span> rcvr<span class='parenthesis'>)</span>;
</code></div></div></div></div><div class='para' id='exec.task.scheduler-10'><div class='marginalizedparent'><a class='marginalized' href='#exec.task.scheduler-10'>10</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7175'>#</a></div><div class='texpara'><div id='exec.task.scheduler-10.sentence-1' class='sentence'><i >Effects</i>: Let <span class='texttt'><i >r</i></span> be an object of a type that models <a href='exec.recv.concepts#concept:receiver' title='33.7.1&emsp;Receiver concepts&emsp;[exec.recv.concepts]'><span id='conceptref:receiver____'><span class='texttt'>receiver</span></span></a>
and whose completion handlers result in invoking the corresponding
completion handlers of <span class='texttt'>rcvr</span> or copy thereof<a class='hidden_link' href='#exec.task.scheduler-10.sentence-1'>.</a></div> <div id='exec.task.scheduler-10.sentence-2' class='sentence'>Returns an object of type <span class='texttt'><span class='texttt'><i >state</i></span><span class='anglebracket'>&lt;</span>Rcvr<span class='anglebracket'>&gt;</span></span> containing
an operation state object initialized with <span class='texttt'>connect<span class='parenthesis'>(</span><span class='texttt'><i >SENDER</i></span><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span>,
std<span class='operator'>&#x200b;::&#x200b;</span>move<span class='parenthesis'>(</span><i >r</i><span class='parenthesis'>)</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#exec.task.scheduler-10.sentence-2'>.</a></div></div></div></div><div class='para' id='exec.task.scheduler-11'><div class='marginalizedparent'><a class='marginalized' href='#exec.task.scheduler-11'>11</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7185'>#</a></div><div class='texpara'><div id='exec.task.scheduler-11.sentence-1' class='sentence'><span class='codeblock'><span class='keyword'>namespace</span> std<span class='operator'>::</span>execution <span class='curlybracket'>{</span>
  <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><a href='exec.recv.concepts#concept:receiver' title='33.7.1&emsp;Receiver concepts&emsp;[exec.recv.concepts]'><span id='conceptref:receiver_____'><span class='tcode_in_codeblock'>receiver</span></span></a> R<span class='anglebracket'>&gt;</span>
  <span class='keyword'>class</span> task_scheduler<span class='operator'>::</span><i >state</i> <span class='curlybracket'>{</span>         <span class='comment'>// <i >exposition only</i></span>
  <span class='keyword'>public</span><span class='operator'>:</span>
    <span class='keyword'>using</span> operation_state_concept <span class='operator'>=</span> operation_state_t;

    <span class='keyword'>void</span> start<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='operator'>&amp;</span> <span class='keyword'>noexcept</span>;
  <span class='curlybracket'>}</span>;
<span class='curlybracket'>}</span>
</span>
<span class='texttt'><i >state</i></span> is an exposition-only class template whose
specializations model <a href='exec.opstate.general#concept:operation_state' title='33.8.1&emsp;General&emsp;[exec.opstate.general]'><span id='conceptref:operation_state'><span class='texttt'>operation_<span class='shy'></span>state</span></span></a> (<a href='exec.opstate' title='33.8&emsp;Operation states'>[exec.<span class='shy'></span>opstate]</a>)<a class='hidden_link' href='#exec.task.scheduler-11.sentence-1'>.</a></div></div></div><div class='texpara'><div id='lib:task_scheduler::state,start'><div id='lib:start,task_scheduler::state'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:start,task_scheduler::state'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>void</span> start<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='operator'>&amp;</span> <span class='keyword'>noexcept</span>;
</code></div></div></div></div><div class='para' id='exec.task.scheduler-12'><div class='marginalizedparent'><a class='marginalized' href='#exec.task.scheduler-12'>12</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7205'>#</a></div><div class='texpara'><div id='exec.task.scheduler-12.sentence-1' class='sentence'><i >Effects</i>: Equivalent to <span class='texttt'>start<span class='parenthesis'>(</span>st<span class='parenthesis'>)</span></span> where <span class='texttt'>st</span> is the operation
state object contained by <span class='texttt'><span class='operator'>*</span><span class='keyword'>this</span></span><a class='hidden_link' href='#exec.task.scheduler-12.sentence-1'>.</a></div></div></div></div></div><div id='exec.task' class='section'><h3 ><a class='secnum' href='#exec.task' style='min-width:80pt'>33.13.6</a> <span class='texttt'>execution&#x200b;::&#x200b;task</span> <a class='abbr_ref' href='exec.task'>[exec.task]</a></h3><div id='task.overview' class='section'><h4 ><a class='secnum' href='#task.overview' style='min-width:95pt'>33.13.6.1</a> <span class='texttt'>task</span> overview <a class='abbr_ref' href='task.overview'>[task.overview]</a></h4><div class='para' id='task.overview-1'><div class='marginalizedparent'><a class='marginalized' href='#task.overview-1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7215'>#</a></div><div class='texpara'><div id='task.overview-1.sentence-1' class='sentence'>The <span class='texttt'>task</span> class template represents a sender that can
be used as the return type of coroutines<a class='hidden_link' href='#task.overview-1.sentence-1'>.</a></div> <div id='task.overview-1.sentence-2' class='sentence'>The first template parameter <span class='texttt'>T</span> defines the type of the value
completion datum (<a href='exec.async.ops' title='33.3&emsp;Asynchronous operations'>[exec.<span class='shy'></span>async.<span class='shy'></span>ops]</a>) if <span class='texttt'>T</span> is not <span class='texttt'><span class='keyword'>void</span></span><a class='hidden_link' href='#task.overview-1.sentence-2'>.</a></div> <div id='task.overview-1.sentence-3' class='sentence'>Otherwise, there are no value completion datums<a class='hidden_link' href='#task.overview-1.sentence-3'>.</a></div> <div id='task.overview-1.sentence-4' class='sentence'>Inside coroutines returning <span class='texttt'>task<span class='anglebracket'>&lt;</span>T, E<span class='anglebracket'>&gt;</span></span> the operand of
<span class='texttt'><span class='keyword'>co_<span class='shy'></span>return</span></span> (if any) becomes the argument of <span class='texttt'>set_<span class='shy'></span>value</span><a class='hidden_link' href='#task.overview-1.sentence-4'>.</a></div> <div id='task.overview-1.sentence-5' class='sentence'>The second template parameter <span class='texttt'>Environment</span> is used to customize
the behavior of <span class='texttt'>task</span><a class='hidden_link' href='#task.overview-1.sentence-5'>.</a></div></div></div></div><div id='task.class' class='section'><h4 ><a class='secnum' href='#task.class' style='min-width:95pt'>33.13.6.2</a> Class template <span class='texttt'>task</span> <a class='abbr_ref' href='task.class'>[task.class]</a></h4><div class='texpara'><span class='codeblock'><span class='keyword'>namespace</span> std<span class='operator'>::</span>execution <span class='curlybracket'>{</span>
  <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> T, <span class='keyword'>class</span> Environment<span class='anglebracket'>&gt;</span>
  <span class='keyword'>class</span> <span id='lib:task'><a class='hidden_link' href='#lib:task' title='33.13.6.2&emsp;Class template task&emsp;[task.class]'>task</a></span> <span class='curlybracket'>{</span>
    <span class='comment'>// <a href='#task.state' title='33.13.6.4&emsp;Class template task&#x200b;::&#x200b;state'>[task.<span class='shy'></span>state]</a></span>
    <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><a href='exec.recv.concepts#concept:receiver' title='33.7.1&emsp;Receiver concepts&emsp;[exec.recv.concepts]'><span id='conceptref:receiver______'><span class='tcode_in_codeblock'>receiver</span></span></a> Rcvr<span class='anglebracket'>&gt;</span>
      <span class='keyword'>class</span> <i >state</i>;                              <span class='comment'>// <i >exposition only</i></span>

  <span class='keyword'>public</span><span class='operator'>:</span>
    <span class='keyword'>using</span> sender_concept <span class='operator'>=</span> sender_t;
    <span class='keyword'>using</span> completion_signatures <span class='operator'>=</span> <i ><span class='texttt'>see below</span></i>;
    <span class='keyword'>using</span> allocator_type <span class='operator'>=</span> <i ><span class='texttt'>see below</span></i>;
    <span class='keyword'>using</span> scheduler_type <span class='operator'>=</span> <i ><span class='texttt'>see below</span></i>;
    <span class='keyword'>using</span> stop_source_type <span class='operator'>=</span> <i ><span class='texttt'>see below</span></i>;
    <span class='keyword'>using</span> stop_token_type <span class='operator'>=</span> <span class='keyword'>decltype</span><span class='parenthesis'>(</span>declval<span class='anglebracket'>&lt;</span>stop_source_type<span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='operator'>.</span>get_token<span class='parenthesis'>(</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span>;
    <span class='keyword'>using</span> error_types <span class='operator'>=</span> <i ><span class='texttt'>see below</span></i>;

    <span class='comment'>// <a href='#task.promise' title='33.13.6.5&emsp;Class task&#x200b;::&#x200b;promise_&shy;type'>[task.<span class='shy'></span>promise]</a></span>
    <span class='keyword'>class</span> promise_type;

    task<span class='parenthesis'>(</span>task<span class='operator'>&amp;</span><span class='operator'>&amp;</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;
    <span class='operator'>~</span>task<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;

    <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><a href='exec.recv.concepts#concept:receiver' title='33.7.1&emsp;Receiver concepts&emsp;[exec.recv.concepts]'><span id='conceptref:receiver_______'><span class='tcode_in_codeblock'>receiver</span></span></a> Rcvr<span class='anglebracket'>&gt;</span>
      <i >state</i><span class='anglebracket'>&lt;</span>Rcvr<span class='anglebracket'>&gt;</span> connect<span class='parenthesis'>(</span>Rcvr<span class='operator'>&amp;</span><span class='operator'>&amp;</span> rcvr<span class='parenthesis'>)</span>;

  <span class='keyword'>private</span><span class='operator'>:</span>
    coroutine_handle<span class='anglebracket'>&lt;</span>promise_type<span class='anglebracket'>&gt;</span> <i >handle</i>;      <span class='comment'>// <i >exposition only</i></span>
  <span class='curlybracket'>}</span>;
<span class='curlybracket'>}</span>
</span></div><div class='para' id='task.class-1'><div class='marginalizedparent'><a class='marginalized' href='#task.class-1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7260'>#</a></div><div class='texpara'><div id='task.class-1.sentence-1' class='sentence'><span class='texttt'>task<span class='anglebracket'>&lt;</span>T, E<span class='anglebracket'>&gt;</span></span> models <a href='exec.snd.concepts#concept:sender' title='33.9.3&emsp;Sender concepts&emsp;[exec.snd.concepts]'><span id='conceptref:sender____'><span class='texttt'>sender</span></span></a> (<a href='exec.snd' title='33.9&emsp;Senders'>[exec.<span class='shy'></span>snd]</a>)
if <span class='texttt'>T</span> is <span class='texttt'><span class='keyword'>void</span></span>, a reference type, or a <span class='mathit'>cv</span>-unqualified
non-array object type and <span class='texttt'>E</span> is a class type<a class='hidden_link' href='#task.class-1.sentence-1'>.</a></div> <div id='task.class-1.sentence-2' class='sentence'>Otherwise a program that instantiates the definition of <span class='texttt'>task<span class='anglebracket'>&lt;</span>T, E<span class='anglebracket'>&gt;</span></span>
is ill-formed<a class='hidden_link' href='#task.class-1.sentence-2'>.</a></div></div></div><div class='para' id='task.class-2'><div class='marginalizedparent'><a class='marginalized' href='#task.class-2'>2</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7267'>#</a></div><div class='texpara'><div id='task.class-2.sentence-1' class='sentence'>The nested types of <span class='texttt'>task</span> template specializations
are determined based on the <span class='texttt'>Environment</span> parameter:
<ul class='itemize'><li id='task.class-2.1'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#task.class-2.1'>(2.1)</a></div><div class='texpara'><div id='task.class-2.1.sentence-1' class='sentence'><span class='texttt'>allocator_<span class='shy'></span>type</span> is <span class='texttt'>Environment<span class='operator'>&#x200b;::&#x200b;</span>allocator_<span class='shy'></span>type</span>
if that <a href='expr.prim.id.qual#nt:qualified-id' title='7.5.5.3&emsp;Qualified names&emsp;[expr.prim.id.qual]'><span id='ntref:qualified-id'><span class='textsf'><i >qualified-id</i></span></span></a> is valid and denotes a type,
<span class='texttt'>allocator<span class='anglebracket'>&lt;</span>byte<span class='anglebracket'>&gt;</span></span> otherwise<a class='hidden_link' href='#task.class-2.1.sentence-1'>.</a></div></div></li><li id='task.class-2.2'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#task.class-2.2'>(2.2)</a></div><div class='texpara'><div id='task.class-2.2.sentence-1' class='sentence'><span class='texttt'>scheduler_<span class='shy'></span>type</span> is <span class='texttt'>Environment<span class='operator'>&#x200b;::&#x200b;</span>scheduler_<span class='shy'></span>type</span>
if that <a href='expr.prim.id.qual#nt:qualified-id' title='7.5.5.3&emsp;Qualified names&emsp;[expr.prim.id.qual]'><span id='ntref:qualified-id_'><span class='textsf'><i >qualified-id</i></span></span></a> is valid and denotes a type,
<span class='texttt'>task_<span class='shy'></span>scheduler</span> otherwise<a class='hidden_link' href='#task.class-2.2.sentence-1'>.</a></div></div></li><li id='task.class-2.3'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#task.class-2.3'>(2.3)</a></div><div class='texpara'><div id='task.class-2.3.sentence-1' class='sentence'><span class='texttt'>stop_<span class='shy'></span>source_<span class='shy'></span>type</span> is <span class='texttt'>Environment<span class='operator'>&#x200b;::&#x200b;</span>stop_<span class='shy'></span>source_<span class='shy'></span>type</span>
if that <a href='expr.prim.id.qual#nt:qualified-id' title='7.5.5.3&emsp;Qualified names&emsp;[expr.prim.id.qual]'><span id='ntref:qualified-id__'><span class='textsf'><i >qualified-id</i></span></span></a> is valid and denotes a type,
<span class='texttt'>inplace_<span class='shy'></span>stop_<span class='shy'></span>source</span> otherwise<a class='hidden_link' href='#task.class-2.3.sentence-1'>.</a></div></div></li><li id='task.class-2.4'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#task.class-2.4'>(2.4)</a></div><div class='texpara'><div id='task.class-2.4.sentence-1' class='sentence'><span class='texttt'>error_<span class='shy'></span>types</span> is <span class='texttt'>Environment<span class='operator'>&#x200b;::&#x200b;</span>error_<span class='shy'></span>types</span> if
that <a href='expr.prim.id.qual#nt:qualified-id' title='7.5.5.3&emsp;Qualified names&emsp;[expr.prim.id.qual]'><span id='ntref:qualified-id___'><span class='textsf'><i >qualified-id</i></span></span></a> is valid and denotes a type,
<span class='texttt'>completion_<span class='shy'></span>signatures<span class='anglebracket'>&lt;</span>set_<span class='shy'></span>error_<span class='shy'></span>t<span class='parenthesis'>(</span>exception_<span class='shy'></span>ptr<span class='parenthesis'>)</span><span class='anglebracket'>&gt;</span></span> otherwise<a class='hidden_link' href='#task.class-2.4.sentence-1'>.</a></div></div></li></ul></div></div></div><div class='para' id='task.class-3'><div class='marginalizedparent'><a class='marginalized' href='#task.class-3'>3</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7285'>#</a></div><div class='texpara'><div id='task.class-3.sentence-1' class='sentence'>A program is ill-formed if <span class='texttt'>error_<span class='shy'></span>types</span> is not a
specialization of <span class='texttt'>completion_<span class='shy'></span>signatures<span class='anglebracket'>&lt;</span>ErrorSigs<span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='anglebracket'>&gt;</span></span> or
<span class='texttt'>ErrorSigs</span> contains an element which is not of the form
<span class='texttt'>set_<span class='shy'></span>error_<span class='shy'></span>t<span class='parenthesis'>(</span>E<span class='parenthesis'>)</span></span> for some type <span class='texttt'>E</span><a class='hidden_link' href='#task.class-3.sentence-1'>.</a></div></div></div><div class='para' id='task.class-4'><div class='marginalizedparent'><a class='marginalized' href='#task.class-4'>4</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7291'>#</a></div><div class='texpara'><div id='task.class-4.sentence-1' class='sentence'>The type alias <span class='texttt'>completion_<span class='shy'></span>signatures</span> is a specialization
of <span class='texttt'>execution<span class='operator'>&#x200b;::&#x200b;</span>completion_<span class='shy'></span>signatures</span> with the template
arguments (in unspecified order):
<ul class='itemize'><li id='task.class-4.1'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#task.class-4.1'>(4.1)</a></div><span class='texttt'>set_<span class='shy'></span>value_<span class='shy'></span>t<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> if <span class='texttt'>T</span> is <span class='texttt'><span class='keyword'>void</span></span>,
and <span class='texttt'>set_<span class='shy'></span>value_<span class='shy'></span>t<span class='parenthesis'>(</span>T<span class='parenthesis'>)</span></span> otherwise;</li><li id='task.class-4.2'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#task.class-4.2'>(4.2)</a></div>template arguments of the specialization of
<span class='texttt'>execution<span class='operator'>&#x200b;::&#x200b;</span>completion_<span class='shy'></span>signatures</span> denoted by <span class='texttt'>error_<span class='shy'></span>types</span>;
and</li><li id='task.class-4.3'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#task.class-4.3'>(4.3)</a></div><span class='texttt'>set_<span class='shy'></span>stopped_<span class='shy'></span>t<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.class-4.sentence-1'>.</a></li></ul></div></div></div><div class='para' id='task.class-5'><div class='marginalizedparent'><a class='marginalized' href='#task.class-5'>5</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7304'>#</a></div><div class='texpara'><div id='task.class-5.sentence-1' class='sentence'><span class='texttt'>allocator_<span class='shy'></span>type</span> shall meet the <i >Cpp17Allocator</i>
requirements<a class='hidden_link' href='#task.class-5.sentence-1'>.</a></div></div></div></div><div id='task.members' class='section'><h4 ><a class='secnum' href='#task.members' style='min-width:95pt'>33.13.6.3</a> <span class='texttt'>task</span> members <a class='abbr_ref' href='task.members'>[task.members]</a></h4><div class='texpara'><div id='lib:task,constructor'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:task,constructor'>🔗</a></div><code class='itemdeclcode'>task<span class='parenthesis'>(</span>task<span class='operator'>&amp;</span><span class='operator'>&amp;</span> other<span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;
</code></div></div></div><div class='para' id='task.members-1'><div class='marginalizedparent'><a class='marginalized' href='#task.members-1'>1</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7315'>#</a></div><div class='texpara'><div id='task.members-1.sentence-1' class='sentence'><i >Effects</i>: Initializes <span class='texttt'><i >handle</i></span> with <span class='texttt'>exchange<span class='parenthesis'>(</span>other<span class='operator'>.</span><span class='texttt'><i >handle</i></span>,
<span class='curlybracket'>{</span><span class='curlybracket'>}</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.members-1.sentence-1'>.</a></div></div></div></div><div class='texpara'><div id='lib:task,destructor'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:task,destructor'>🔗</a></div><code class='itemdeclcode'><span class='operator'>~</span>task<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
</code></div></div></div><div class='para' id='task.members-2'><div class='marginalizedparent'><a class='marginalized' href='#task.members-2'>2</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7326'>#</a></div><div class='texpara'><div id='task.members-2.sentence-1' class='sentence'><i >Effects</i>: Equivalent to:
<span class='codeblock'><span class='keyword'>if</span> <span class='parenthesis'>(</span><i >handle</i><span class='parenthesis'>)</span>
  <i >handle</i><span class='operator'>.</span>destroy<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
</span></div></div></div></div><div class='texpara'><div id='lib:task,connect'><div id='lib:connect,task'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:connect,task'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><a href='exec.recv.concepts#concept:receiver' title='33.7.1&emsp;Receiver concepts&emsp;[exec.recv.concepts]'><span id='conceptref:receiver________'><span class='texttt'>receiver</span></span></a> R<span class='anglebracket'>&gt;</span>
  <span class='texttt'><i >state</i></span><span class='anglebracket'>&lt;</span>R<span class='anglebracket'>&gt;</span> connect<span class='parenthesis'>(</span>R<span class='operator'>&amp;</span><span class='operator'>&amp;</span> recv<span class='parenthesis'>)</span>;
</code></div></div></div></div><div class='para' id='task.members-3'><div class='marginalizedparent'><a class='marginalized' href='#task.members-3'>3</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7341'>#</a></div><div class='texpara'><div id='task.members-3.sentence-1' class='sentence'><i >Preconditions</i>: <span class='texttt'><span class='keyword'>bool</span><span class='parenthesis'>(</span><span class='texttt'><i >handle</i></span><span class='parenthesis'>)</span></span> is <span class='texttt'><span class='literal'>true</span></span><a class='hidden_link' href='#task.members-3.sentence-1'>.</a></div></div></div></div><div class='para' id='task.members-4'><div class='marginalizedparent'><a class='marginalized' href='#task.members-4'>4</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7345'>#</a></div><div class='texpara'><div id='task.members-4.sentence-1' class='sentence'><i >Effects</i>: Equivalent to: <span class='texttt'><span class='keyword'>return</span> <span class='texttt'><i >state</i></span><span class='anglebracket'>&lt;</span>R<span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>exchange<span class='parenthesis'>(</span><span class='texttt'><i >handle</i></span>,
<span class='curlybracket'>{</span><span class='curlybracket'>}</span><span class='parenthesis'>)</span>, std<span class='operator'>&#x200b;::&#x200b;</span>forward<span class='anglebracket'>&lt;</span>R<span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>recv<span class='parenthesis'>)</span><span class='parenthesis'>)</span>;</span></div></div></div></div></div><div id='task.state' class='section'><h4 ><a class='secnum' href='#task.state' style='min-width:95pt'>33.13.6.4</a> <span class='texttt'>Class template <span class='texttt'>task&#x200b;::&#x200b;state</span></span> <a class='abbr_ref' href='task.state'>[task.state]</a></h4><div class='texpara'><span class='codeblock'><span class='keyword'>namespace</span> std<span class='operator'>::</span>execution <span class='curlybracket'>{</span>
  <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> T, <span class='keyword'>class</span> Environment<span class='anglebracket'>&gt;</span>
  <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><a href='exec.recv.concepts#concept:receiver' title='33.7.1&emsp;Receiver concepts&emsp;[exec.recv.concepts]'><span id='conceptref:receiver_________'><span class='tcode_in_codeblock'>receiver</span></span></a> Rcvr<span class='anglebracket'>&gt;</span>
  <span class='keyword'>class</span> task<span class='anglebracket'>&lt;</span>T, Environment<span class='anglebracket'>&gt;</span><span class='operator'>::</span><i >state</i> <span class='curlybracket'>{</span>           <span class='comment'>// <i >exposition only</i></span>
  <span class='keyword'>public</span><span class='operator'>:</span>
    <span class='keyword'>using</span> operation_state_concept <span class='operator'>=</span> operation_state_t;

    <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> R<span class='anglebracket'>&gt;</span>
      <i >state</i><span class='parenthesis'>(</span>coroutine_handle<span class='anglebracket'>&lt;</span>promise_type<span class='anglebracket'>&gt;</span> h, R<span class='operator'>&amp;</span><span class='operator'>&amp;</span> rr<span class='parenthesis'>)</span>;

    <span class='operator'>~</span><i >state</i><span class='parenthesis'>(</span><span class='parenthesis'>)</span>;

    <span class='keyword'>void</span> start<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='operator'>&amp;</span> <span class='keyword'>noexcept</span>;

  <span class='keyword'>private</span><span class='operator'>:</span>
    <span class='keyword'>using</span> <i >own-env-t</i> <span class='operator'>=</span> <i ><span class='texttt'>see below</span></i>;                <span class='comment'>// <i >exposition only</i></span>
    coroutine_handle<span class='anglebracket'>&lt;</span>promise_type<span class='anglebracket'>&gt;</span> <i >handle</i>;      <span class='comment'>// <i >exposition only</i></span>
    remove_cvref_t<span class='anglebracket'>&lt;</span>Rcvr<span class='anglebracket'>&gt;</span>           <i >rcvr</i>;        <span class='comment'>// <i >exposition only</i></span>
    <i >own-env-t</i>                      <i >own-env</i>;     <span class='comment'>// <i >exposition only</i></span>
    Environment                    <i >environment</i>; <span class='comment'>// <i >exposition only</i></span>
  <span class='curlybracket'>}</span>;
<span class='curlybracket'>}</span>
</span></div><div class='para' id='task.state-1'><div class='marginalizedparent'><a class='marginalized' href='#task.state-1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7378'>#</a></div><div class='texpara'><div id='task.state-1.sentence-1' class='sentence'>The type <span class='texttt'><i >own-env-t</i></span> is <span class='texttt'>Environment<span class='operator'>&#x200b;::&#x200b;</span><span class='keyword'>template</span>
env_<span class='shy'></span>type<span class='anglebracket'>&lt;</span><span class='keyword'>decltype</span><span class='parenthesis'>(</span>get_<span class='shy'></span>env<span class='parenthesis'>(</span>&#x200b;declval&#x200b;<span class='anglebracket'>&lt;</span>Rcvr<span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>&#x200b;<span class='parenthesis'>)</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span>&#x200b;<span class='anglebracket'>&gt;</span></span> if that
<a href='expr.prim.id.qual#nt:qualified-id' title='7.5.5.3&emsp;Qualified names&emsp;[expr.prim.id.qual]'><span id='ntref:qualified-id____'><span class='textsf'><i >qualified-id</i></span></span></a> is valid and denotes a type, <span class='texttt'>env<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span></span> otherwise<a class='hidden_link' href='#task.state-1.sentence-1'>.</a></div></div></div><div class='texpara'><div id='lib:task::state,constructor'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:task::state,constructor'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> R<span class='anglebracket'>&gt;</span>
  <span class='texttt'><i >state</i></span><span class='parenthesis'>(</span>coroutine_handle<span class='anglebracket'>&lt;</span>promise_type<span class='anglebracket'>&gt;</span> h, R<span class='operator'>&amp;</span><span class='operator'>&amp;</span> rr<span class='parenthesis'>)</span>;
</code></div></div></div><div class='para' id='task.state-2'><div class='marginalizedparent'><a class='marginalized' href='#task.state-2'>2</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7389'>#</a></div><div class='texpara'><div id='task.state-2.sentence-1' class='sentence'><i >Effects</i>: Initializes
<ul class='itemize'><li id='task.state-2.1'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.state-2.1'>(2.1)</a></div><span class='texttt'><i >handle</i></span> with <span class='texttt'>std<span class='operator'>&#x200b;::&#x200b;</span>move<span class='parenthesis'>(</span>h<span class='parenthesis'>)</span></span>;</li><li id='task.state-2.2'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.state-2.2'>(2.2)</a></div><span class='texttt'><i >rcvr</i></span> with <span class='texttt'>std<span class='operator'>&#x200b;::&#x200b;</span>forward<span class='anglebracket'>&lt;</span>R<span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>rr<span class='parenthesis'>)</span></span>;</li><li id='task.state-2.3'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.state-2.3'>(2.3)</a></div><span class='texttt'><i >own-env</i></span>
with <span class='texttt'><span class='texttt'><i >own-env-t</i></span><span class='parenthesis'>(</span>get_<span class='shy'></span>env<span class='parenthesis'>(</span><span class='texttt'><i >rcvr</i></span><span class='parenthesis'>)</span><span class='parenthesis'>)</span></span> if that expression
is valid and <span class='texttt'><span class='texttt'><i >own-env-t</i></span><span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> otherwise<a class='hidden_link' href='#task.state-2.sentence-1'>.</a></li></ul></div> <div id='task.state-2.sentence-2' class='sentence'>
If neither of these expressions is valid, the program is ill-formed<a class='hidden_link' href='#task.state-2.sentence-2'>.</a></div> <div id='task.state-2.sentence-3' class='sentence'><span class='item'></span><span class='texttt'><i >environment</i></span> with <span class='texttt'>Environment<span class='parenthesis'>(</span><span class='texttt'><i >own-env</i></span><span class='parenthesis'>)</span></span> if that expression is
valid, otherwise <span class='texttt'>Environment<span class='parenthesis'>(</span>get_<span class='shy'></span>env<span class='parenthesis'>(</span><span class='texttt'><i >rcvr</i></span><span class='parenthesis'>)</span><span class='parenthesis'>)</span></span>
if this expression is valid, otherwise <span class='texttt'>Environment<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.state-2.sentence-3'>.</a></div> <div id='task.state-2.sentence-4' class='sentence'>If neither of these expressions is valid, the program is ill-formed<a class='hidden_link' href='#task.state-2.sentence-4'>.</a></div></div></div></div><div class='texpara'><div id='lib:task::state,destructor'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:task::state,destructor'>🔗</a></div><code class='itemdeclcode'><span class='operator'>~</span><span class='texttt'><i >state</i></span><span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
</code></div></div></div><div class='para' id='task.state-3'><div class='marginalizedparent'><a class='marginalized' href='#task.state-3'>3</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7411'>#</a></div><div class='texpara'><div id='task.state-3.sentence-1' class='sentence'><i >Effects</i>: Equivalent to:
<span class='codeblock'><span class='keyword'>if</span> <span class='parenthesis'>(</span><i >handle</i><span class='parenthesis'>)</span>
  <i >handle</i><span class='operator'>.</span>destroy<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
</span></div></div></div></div><div class='texpara'><div id='lib:task::state,start'><div id='lib:start,task::state'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:start,task::state'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>void</span> start<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='operator'>&amp;</span> <span class='keyword'>noexcept</span>;
</code></div></div></div></div><div class='para' id='task.state-4'><div class='marginalizedparent'><a class='marginalized' href='#task.state-4'>4</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7425'>#</a></div><div class='texpara'><div id='task.state-4.sentence-1' class='sentence'><i >Effects</i>: Let <span class='texttt'><i >prom</i></span> be the object <span class='texttt'><span class='texttt'><i >handle</i></span><span class='operator'>.</span>promise<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.state-4.sentence-1'>.</a></div> <div id='task.state-4.sentence-2' class='sentence'>Associates <span class='texttt'><span class='texttt'><i >STATE</i></span><span class='parenthesis'>(</span><i >prom</i><span class='parenthesis'>)</span></span>, <span class='texttt'><span class='texttt'><i >RCVR</i></span><span class='parenthesis'>(</span><i >prom</i><span class='parenthesis'>)</span></span>, and <span class='texttt'><span class='texttt'><i >SCHED</i></span><span class='parenthesis'>(</span><i >prom</i><span class='parenthesis'>)</span></span>
with <span class='texttt'><span class='operator'>*</span><span class='keyword'>this</span></span> as follows:
<ul class='itemize'><li id='task.state-4.1'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.state-4.1'>(4.1)</a></div><div class='texpara'><div id='task.state-4.1.sentence-1' class='sentence'><span class='texttt'><span class='texttt'><i >STATE</i></span><span class='parenthesis'>(</span><i >prom</i><span class='parenthesis'>)</span></span> is <span class='texttt'><span class='operator'>*</span><span class='keyword'>this</span></span><a class='hidden_link' href='#task.state-4.1.sentence-1'>.</a></div></div></li><li id='task.state-4.2'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.state-4.2'>(4.2)</a></div><div class='texpara'><div id='task.state-4.2.sentence-1' class='sentence'><span class='texttt'><span class='texttt'><i >RCVR</i></span><span class='parenthesis'>(</span><i >prom</i><span class='parenthesis'>)</span></span> is <span class='texttt'><i >rcvr</i></span><a class='hidden_link' href='#task.state-4.2.sentence-1'>.</a></div></div></li><li id='task.state-4.3'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.state-4.3'>(4.3)</a></div><div class='texpara'><div id='task.state-4.3.sentence-1' class='sentence'><span class='texttt'><span class='texttt'><i >SCHED</i></span><span class='parenthesis'>(</span><i >prom</i><span class='parenthesis'>)</span></span> is the object initialized
with <span class='texttt'>scheduler_<span class='shy'></span>type<span class='parenthesis'>(</span>get_<span class='shy'></span>scheduler<span class='parenthesis'>(</span>get_<span class='shy'></span>env<span class='parenthesis'>(</span><span class='texttt'><i >rcvr</i></span><span class='parenthesis'>)</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span></span>
if that expression is valid and <span class='texttt'>scheduler_<span class='shy'></span>type<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> otherwise<a class='hidden_link' href='#task.state-4.3.sentence-1'>.</a></div> <div id='task.state-4.3.sentence-2' class='sentence'>If neither of these expressions is valid, the program is ill-formed<a class='hidden_link' href='#task.state-4.3.sentence-2'>.</a></div></div></li></ul></div> <div id='task.state-4.sentence-3' class='sentence'>
Let <span class='texttt'><i >st</i></span> be <span class='texttt'>get_<span class='shy'></span>stop_<span class='shy'></span>token<span class='parenthesis'>(</span>get_<span class='shy'></span>env<span class='parenthesis'>(</span><span class='texttt'><i >rcvr</i></span><span class='parenthesis'>)</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.state-4.sentence-3'>.</a></div> <div id='task.state-4.sentence-4' class='sentence'>Initializes <span class='texttt'><i >prom</i><span class='operator'>.</span><span class='texttt'><i >token</i></span></span> and
<span class='texttt'><i >prom</i><span class='operator'>.</span><span class='texttt'><i >source</i></span></span> such that
<ul class='itemize'><li id='task.state-4.4'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.state-4.4'>(4.4)</a></div><span class='texttt'><i >prom</i><span class='operator'>.</span><span class='texttt'><i >token</i></span><span class='operator'>.</span>stop_<span class='shy'></span>requested<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> returns
<span class='texttt'><i >st</i><span class='operator'>.</span>stop_<span class='shy'></span>requested<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>;</li><li id='task.state-4.5'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.state-4.5'>(4.5)</a></div><span class='texttt'><i >prom</i><span class='operator'>.</span><span class='texttt'><i >token</i></span><span class='operator'>.</span>stop_<span class='shy'></span>possible<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> returns
<span class='texttt'><i >st</i><span class='operator'>.</span>stop_<span class='shy'></span>possible<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span>; and</li><li id='task.state-4.6'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.state-4.6'>(4.6)</a></div>for types <span class='texttt'>Fn</span> and <span class='texttt'>Init</span> such that both
<span class='texttt'><a href='concept.invocable#concept:invocable' title='18.7.2&emsp;Concept invocable&emsp;[concept.invocable]'><span id='conceptref:invocable'><span class='texttt'>invocable</span></span></a><span class='anglebracket'>&lt;</span>Fn<span class='anglebracket'>&gt;</span></span> and
<span class='texttt'><a href='concept.constructible#concept:constructible_from' title='18.4.11&emsp;Concept constructible_&shy;from&emsp;[concept.constructible]'><span id='conceptref:constructible_from_'><span class='texttt'>constructible_<span class='shy'></span>from</span></span></a><span class='anglebracket'>&lt;</span>Fn, Init<span class='anglebracket'>&gt;</span></span> are modeled,
<span class='texttt'>stop_<span class='shy'></span>token_<span class='shy'></span>type<span class='operator'>&#x200b;::&#x200b;</span>callback_<span class='shy'></span>type<span class='anglebracket'>&lt;</span>Fn<span class='anglebracket'>&gt;</span></span> models
<span class='texttt'><a href='stoptoken.concepts#concept:stoppable-callback-for' title='32.3.3&emsp;Stop token concepts&emsp;[stoptoken.concepts]'><span id='conceptref:stoppable-callback-for'><span class='texttt'><i >stoppable-callback-for</i></span></span></a><span class='anglebracket'>&lt;</span>Fn,&#x200b; stop_<span class='shy'></span>token_<span class='shy'></span>type, Init<span class='anglebracket'>&gt;</span></span><a class='hidden_link' href='#task.state-4.sentence-4'>.</a></li></ul></div> <div id='task.state-4.sentence-5' class='sentence'>
After that invokes <span class='texttt'><span class='texttt'><i >handle</i></span><span class='operator'>.</span>resume<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.state-4.sentence-5'>.</a></div></div></div></div></div><div id='task.promise' class='section'><h4 ><a class='secnum' href='#task.promise' style='min-width:95pt'>33.13.6.5</a> Class <span class='texttt'>task&#x200b;::&#x200b;promise_<span class='shy'></span>type</span> <a class='abbr_ref' href='task.promise'>[task.promise]</a></h4><div class='texpara'><span class='codeblock'><span class='keyword'>namespace</span> std<span class='operator'>::</span>execution <span class='curlybracket'>{</span>
  <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> T, <span class='keyword'>class</span> Environment<span class='anglebracket'>&gt;</span>
  <span class='keyword'>class</span> task<span class='anglebracket'>&lt;</span>T, Environment<span class='anglebracket'>&gt;</span><span class='operator'>::</span>promise_type <span class='curlybracket'>{</span>
  <span class='keyword'>public</span><span class='operator'>:</span>
    <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span><span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span> Args<span class='anglebracket'>&gt;</span>
      promise_type<span class='parenthesis'>(</span><span class='keyword'>const</span> Args<span class='operator'>&amp;</span><span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span> args<span class='parenthesis'>)</span>;

    task get_return_object<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;

    <span class='keyword'>auto</span> initial_suspend<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;
    <span class='keyword'>auto</span> final_suspend<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;

    <span class='keyword'>void</span> uncaught_exception<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
    coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span> unhandled_stopped<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;

    <span class='keyword'>void</span> return_void<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;                 <span class='comment'>// present only if <span class='tcode_in_codeblock'>is_<span class='shy'></span>void_<span class='shy'></span>v&lt;T&gt;</span> is <span class='tcode_in_codeblock'>true</span>;</span>
    <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> V<span class='anglebracket'>&gt;</span>
      <span class='keyword'>void</span> return_value<span class='parenthesis'>(</span>V<span class='operator'>&amp;</span><span class='operator'>&amp;</span> value<span class='parenthesis'>)</span>;     <span class='comment'>// present only if <span class='tcode_in_codeblock'>is_<span class='shy'></span>void_<span class='shy'></span>v&lt;T&gt;</span> is <span class='tcode_in_codeblock'>false</span>;</span>

    <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> E<span class='anglebracket'>&gt;</span>
      <i ><span class='texttt'>unspecified</span></i> yield_value<span class='parenthesis'>(</span>with_error<span class='anglebracket'>&lt;</span>E<span class='anglebracket'>&gt;</span> error<span class='parenthesis'>)</span>;

    <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> A<span class='anglebracket'>&gt;</span>
      <span class='keyword'>auto</span> await_transform<span class='parenthesis'>(</span>A<span class='operator'>&amp;</span><span class='operator'>&amp;</span> a<span class='parenthesis'>)</span>;
    <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Sch<span class='anglebracket'>&gt;</span>
      <span class='keyword'>auto</span> await_transform<span class='parenthesis'>(</span>change_coroutine_scheduler<span class='anglebracket'>&lt;</span>Sch<span class='anglebracket'>&gt;</span> sch<span class='parenthesis'>)</span>;

    <i ><span class='texttt'>unspecified</span></i> get_env<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='keyword'>const</span> <span class='keyword'>noexcept</span>;

    <span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span><span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span> Args<span class='anglebracket'>&gt;</span>
      <span class='keyword'>void</span><span class='operator'>*</span> <span class='keyword'>operator</span> <span class='keyword'>new</span><span class='parenthesis'>(</span>size_t size, Args<span class='operator'>&amp;</span><span class='operator'>&amp;</span><span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span> args<span class='parenthesis'>)</span>;

    <span class='keyword'>void</span> <span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span> pointer, size_t size<span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;

  <span class='keyword'>private</span><span class='operator'>:</span>
    <span class='keyword'>using</span> <i >error-variant</i> <span class='operator'>=</span> <i ><span class='texttt'>see below</span></i>;    <span class='comment'>// <i >exposition only</i></span>

    allocator_type    <i >alloc</i>;            <span class='comment'>// <i >exposition only</i></span>
    stop_source_type  <i >source</i>;           <span class='comment'>// <i >exposition only</i></span>
    stop_token_type   <i >token</i>;            <span class='comment'>// <i >exposition only</i></span>
    optional<span class='anglebracket'>&lt;</span>T<span class='anglebracket'>&gt;</span>       <i >result</i>;           <span class='comment'>// <i >exposition only</i>; present only if <span class='tcode_in_codeblock'>is_<span class='shy'></span>void_<span class='shy'></span>v&lt;T&gt;</span> is <span class='tcode_in_codeblock'>false</span>;</span>
    <i >error-variant</i>     <i >errors</i>;           <span class='comment'>// <i >exposition only</i></span>
  <span class='curlybracket'>}</span>;
<span class='curlybracket'>}</span>
</span></div><div class='para' id='task.promise-1'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7507'>#</a></div><div class='texpara'><div id='task.promise-1.sentence-1' class='sentence'>Let <span class='texttt'><i >prom</i></span> be an object of <span class='texttt'>promise_<span class='shy'></span>type</span>
and let <span class='texttt'><i >tsk</i></span> be the <span class='texttt'>task</span> object
created by <span class='texttt'><i >prom</i><span class='operator'>.</span>get_<span class='shy'></span>return_<span class='shy'></span>object<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.promise-1.sentence-1'>.</a></div> <div id='task.promise-1.sentence-2' class='sentence'>The description below
refers to objects <span class='texttt'><span class='texttt'><i >STATE</i></span><span class='parenthesis'>(</span><i >prom</i><span class='parenthesis'>)</span></span>,
<span class='texttt'><span class='texttt'><i >RCVR</i></span><span class='parenthesis'>(</span><i >prom</i><span class='parenthesis'>)</span></span>,
and <span class='texttt'><span class='texttt'><i >SCHED</i></span><span class='parenthesis'>(</span><i >prom</i><span class='parenthesis'>)</span></span>
associated with <span class='texttt'><i >tsk</i></span>
during evaluation of <span class='texttt'>task<span class='operator'>&#x200b;::&#x200b;</span><span class='texttt'><i >state</i></span><span class='anglebracket'>&lt;</span>Rcvr<span class='anglebracket'>&gt;</span><span class='operator'>&#x200b;::&#x200b;</span>start</span>
for some receiver <span class='texttt'>Rcvr</span><a class='hidden_link' href='#task.promise-1.sentence-2'>.</a></div></div></div><div class='para' id='task.promise-2'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-2'>2</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7519'>#</a></div><div class='texpara'><div id='task.promise-2.sentence-1' class='sentence'><span class='texttt'><i >error-variant</i></span> is a <span class='texttt'>variant<span class='anglebracket'>&lt;</span>monostate,
remove_<span class='shy'></span>cvref_<span class='shy'></span>t<span class='anglebracket'>&lt;</span>E<span class='anglebracket'>&gt;</span><span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='anglebracket'>&gt;</span></span>, with duplicate types removed, where <span class='texttt'>E<span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span></span>
are template arguments of the specialization of
<span class='texttt'>execution<span class='operator'>&#x200b;::&#x200b;</span>completion_<span class='shy'></span>signatures</span> denoted by
<span class='texttt'>error_<span class='shy'></span>types</span><a class='hidden_link' href='#task.promise-2.sentence-1'>.</a></div></div></div><div class='texpara'><div id='lib:task::promise_type,constructor'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:task::promise_type,constructor'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span><span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span> Args<span class='anglebracket'>&gt;</span>
  promise_type<span class='parenthesis'>(</span><span class='keyword'>const</span> Args<span class='operator'>&amp;</span><span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span> args<span class='parenthesis'>)</span>;
</code></div></div></div><div class='para' id='task.promise-3'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-3'>3</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7532'>#</a></div><div class='texpara'><div id='task.promise-3.sentence-1' class='sentence'><i >Mandates</i>: The first parameter of type <span class='texttt'>allocator_<span class='shy'></span>arg_<span class='shy'></span>t</span> (if any) is not
the last parameter<a class='hidden_link' href='#task.promise-3.sentence-1'>.</a></div></div></div></div><div class='para' id='task.promise-4'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-4'>4</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7537'>#</a></div><div class='texpara'><div id='task.promise-4.sentence-1' class='sentence'><i >Effects</i>: If <span class='texttt'>Args</span> contains an element of type <span class='texttt'>allocator_<span class='shy'></span>arg_<span class='shy'></span>t</span>
then <span class='texttt'><i >alloc</i></span> is initialized with the corresponding next
element of <span class='texttt'>args</span><a class='hidden_link' href='#task.promise-4.sentence-1'>.</a></div> <div id='task.promise-4.sentence-2' class='sentence'>Otherwise, <span class='texttt'><i >alloc</i></span> is initialized with <span class='texttt'>allocator_<span class='shy'></span>type<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.promise-4.sentence-2'>.</a></div></div></div></div><div class='texpara'><div id='lib:task::promise_type,get_return_object'><div id='lib:get_return_object,task::promise_type'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:get_return_object,task::promise_type'>🔗</a></div><code class='itemdeclcode'>task get_return_object<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;
</code></div></div></div></div><div class='para' id='task.promise-5'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-5'>5</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7550'>#</a></div><div class='texpara'><div id='task.promise-5.sentence-1' class='sentence'><i >Returns</i>: A <span class='texttt'>task</span> object whose member <span class='texttt'><i >handle</i></span> is
<span class='texttt'>coroutine_<span class='shy'></span>handle<span class='anglebracket'>&lt;</span>promise_<span class='shy'></span>type<span class='anglebracket'>&gt;</span><span class='operator'>&#x200b;::&#x200b;</span>&#x200b;from_<span class='shy'></span>promise&#x200b;<span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.promise-5.sentence-1'>.</a></div></div></div></div><div class='texpara'><div id='lib:task::promise_type,initial_suspend'><div id='lib:initial_suspend,task::promise_type'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:initial_suspend,task::promise_type'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>auto</span> initial_suspend<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;
</code></div></div></div></div><div class='para' id='task.promise-6'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-6'>6</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7561'>#</a></div><div class='texpara'><div id='task.promise-6.sentence-1' class='sentence'><i >Returns</i>: An awaitable object of unspecified type (<a href='expr.await' title='7.6.2.4&emsp;Await'>[expr.<span class='shy'></span>await]</a>) whose
member functions arrange for
<ul class='itemize'><li id='task.promise-6.1'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.promise-6.1'>(6.1)</a></div>the calling coroutine to be suspended,</li><li id='task.promise-6.2'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.promise-6.2'>(6.2)</a></div>the coroutine to be resumed on an execution agent of the
execution resource associated with <span class='texttt'><span class='texttt'><i >SCHED</i></span><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.promise-6.sentence-1'>.</a></li></ul></div></div></div></div><div class='texpara'><div id='lib:task::promise_type,final_suspend'><div id='lib:final_suspend,task::promise_type'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:final_suspend,task::promise_type'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>auto</span> final_suspend<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;
</code></div></div></div></div><div class='para' id='task.promise-7'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-7'>7</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7577'>#</a></div><div class='texpara'><div id='task.promise-7.sentence-1' class='sentence'><i >Returns</i>: An awaitable object of unspecified type (<a href='expr.await' title='7.6.2.4&emsp;Await'>[expr.<span class='shy'></span>await]</a>) whose
member functions arrange for the completion of the asynchronous
operation associated with <span class='texttt'><span class='texttt'><i >STATE</i></span><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span></span> by invoking:
<ul class='itemize'><li id='task.promise-7.1'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.promise-7.1'>(7.1)</a></div><span class='texttt'>set_<span class='shy'></span>error<span class='parenthesis'>(</span>std<span class='operator'>&#x200b;::&#x200b;</span>move<span class='parenthesis'>(</span><span class='texttt'><i >RCVR</i></span><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span>, std<span class='operator'>&#x200b;::&#x200b;</span>move<span class='parenthesis'>(</span>e<span class='parenthesis'>)</span><span class='parenthesis'>)</span></span>
if <span class='texttt'><span class='texttt'><i >errors</i></span><span class='operator'>.</span>index<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> is greater than zero and
<span class='texttt'>e</span> is the value held by <span class='texttt'><i >errors</i></span>, otherwise</li><li id='task.promise-7.2'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.promise-7.2'>(7.2)</a></div><span class='texttt'>set_<span class='shy'></span>value<span class='parenthesis'>(</span>std<span class='operator'>&#x200b;::&#x200b;</span>move<span class='parenthesis'>(</span><span class='texttt'><i >RCVR</i></span><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span></span> if <span class='texttt'>is_<span class='shy'></span>void<span class='anglebracket'>&lt;</span>T<span class='anglebracket'>&gt;</span></span> is <span class='texttt'><span class='literal'>true</span></span>,
and otherwise</li><li id='task.promise-7.3'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.promise-7.3'>(7.3)</a></div><span class='texttt'>set_<span class='shy'></span>value<span class='parenthesis'>(</span>std<span class='operator'>&#x200b;::&#x200b;</span>move<span class='parenthesis'>(</span><span class='texttt'><i >RCVR</i></span><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span>, <span class='operator'>*</span><span class='texttt'><i >result</i></span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.promise-7.sentence-1'>.</a></li></ul></div></div></div></div><div class='texpara'><div id='lib:task::promise_type,yield_value'><div id='lib:yield_value,task::promise_type'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:yield_value,task::promise_type'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Err<span class='anglebracket'>&gt;</span>
  <span class='keyword'>auto</span> yield_value<span class='parenthesis'>(</span>with_error<span class='anglebracket'>&lt;</span>Err<span class='anglebracket'>&gt;</span> err<span class='parenthesis'>)</span>;
</code></div></div></div></div><div class='para' id='task.promise-8'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-8'>8</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7601'>#</a></div><div class='texpara'><div id='task.promise-8.sentence-1' class='sentence'><i >Mandates</i>: <span class='texttt'>std<span class='operator'>&#x200b;::&#x200b;</span>move<span class='parenthesis'>(</span>err<span class='operator'>.</span>error<span class='parenthesis'>)</span></span> is convertible to exactly one of the
<span class='texttt'>set_<span class='shy'></span>error_<span class='shy'></span>t</span> argument types of <span class='texttt'>error_<span class='shy'></span>types</span><a class='hidden_link' href='#task.promise-8.sentence-1'>.</a></div> <div id='task.promise-8.sentence-2' class='sentence'>Let <span class='texttt'><i >Cerr</i></span> be that type<a class='hidden_link' href='#task.promise-8.sentence-2'>.</a></div></div></div></div><div class='para' id='task.promise-9'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-9'>9</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7607'>#</a></div><div class='texpara'><div id='task.promise-9.sentence-1' class='sentence'><i >Returns</i>: An awaitable object of unspecified type (<a href='expr.await' title='7.6.2.4&emsp;Await'>[expr.<span class='shy'></span>await]</a>) whose
member functions arrange for the calling coroutine to be suspended
and then completes the asynchronous operation associated with
<span class='texttt'><span class='texttt'><i >STATE</i></span><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span></span> by invoking <span class='texttt'>set_<span class='shy'></span>error<span class='parenthesis'>(</span>std<span class='operator'>&#x200b;::&#x200b;</span>move<span class='parenthesis'>(</span><span class='texttt'><i >RCVR</i></span><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span>,
<i >Cerr</i><span class='parenthesis'>(</span>std<span class='operator'>&#x200b;::&#x200b;</span>move<span class='parenthesis'>(</span>err<span class='operator'>.</span>error<span class='parenthesis'>)</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.promise-9.sentence-1'>.</a></div></div></div></div><div class='texpara'><div id='lib:task::promise_type,await_transform'><div id='lib:await_transform,task::promise_type'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:await_transform,task::promise_type'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><a href='exec.snd.concepts#concept:sender' title='33.9.3&emsp;Sender concepts&emsp;[exec.snd.concepts]'><span id='conceptref:sender_____'><span class='texttt'>sender</span></span></a> Sender<span class='anglebracket'>&gt;</span>
  <span class='keyword'>auto</span> await_transform<span class='parenthesis'>(</span>Sender<span class='operator'>&amp;</span><span class='operator'>&amp;</span> sndr<span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;
</code></div></div></div></div><div class='para' id='task.promise-10'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-10'>10</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7622'>#</a></div><div class='texpara'><div id='task.promise-10.sentence-1' class='sentence'><i >Returns</i>: If <span class='texttt'><a href='concept.same#concept:same_as' title='18.4.2&emsp;Concept same_&shy;as&emsp;[concept.same]'><span id='conceptref:same_as______'><span class='texttt'>same_<span class='shy'></span>as</span></span></a><span class='anglebracket'>&lt;</span>inline_<span class='shy'></span>scheduler, scheduler_<span class='shy'></span>type<span class='anglebracket'>&gt;</span></span> is <span class='texttt'><span class='literal'>true</span></span>
returns <span class='texttt'>as_<span class='shy'></span>awaitable<span class='parenthesis'>(</span>&#x200b;std<span class='operator'>&#x200b;::&#x200b;</span>&#x200b;forward<span class='anglebracket'>&lt;</span>Sender<span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>sndr<span class='parenthesis'>)</span>, <span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span></span>;
otherwise returns
<span class='texttt'>as_<span class='shy'></span>awaitable<span class='parenthesis'>(</span>affine_<span class='shy'></span>on<span class='parenthesis'>(</span>&#x200b;std<span class='operator'>&#x200b;::&#x200b;</span>&#x200b;forward<span class='anglebracket'>&lt;</span>Sender<span class='anglebracket'>&gt;</span><span class='parenthesis'>(</span>sndr<span class='parenthesis'>)</span>, <span class='texttt'><i >SCHED</i></span><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span>, <span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.promise-10.sentence-1'>.</a></div></div></div></div><div class='texpara'><div id='lib:task::promise_type,await_transform_'><div id='lib:await_transform,task::promise_type_'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:await_transform,task::promise_type_'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span> Sch<span class='anglebracket'>&gt;</span>
  <span class='keyword'>auto</span> await_transform<span class='parenthesis'>(</span>change_coroutine_scheduler<span class='anglebracket'>&lt;</span>Sch<span class='anglebracket'>&gt;</span> sch<span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;
</code></div></div></div></div><div class='para' id='task.promise-11'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-11'>11</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7636'>#</a></div><div class='texpara'><div id='task.promise-11.sentence-1' class='sentence'><i >Effects</i>: Equivalent to:
<span class='codeblock'><span class='keyword'>return</span> await_transform<span class='parenthesis'>(</span>just<span class='parenthesis'>(</span>exchange<span class='parenthesis'>(</span><i >SCHED</i><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span>, scheduler_type<span class='parenthesis'>(</span>sch<span class='operator'>.</span>scheduler<span class='parenthesis'>)</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span>, <span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span>;
</span></div></div></div></div><div class='texpara'><div id='lib:task::promise_type,uncaught_exception'><div id='lib:uncaught_exception,task::promise_type'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:uncaught_exception,task::promise_type'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>void</span> uncaught_exception<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
</code></div></div></div></div><div class='para' id='task.promise-12'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-12'>12</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7649'>#</a></div><div class='texpara'><div id='task.promise-12.sentence-1' class='sentence'><i >Effects</i>: If the signature <span class='texttt'>set_<span class='shy'></span>error_<span class='shy'></span>t<span class='parenthesis'>(</span>exception_<span class='shy'></span>ptr<span class='parenthesis'>)</span></span> is not an element
of <span class='texttt'>error_<span class='shy'></span>types</span>, calls <span class='texttt'>terminate<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> (<a href='except.terminate' title='14.6.2&emsp;The std&#x200b;::&#x200b;terminate function'>[except.<span class='shy'></span>terminate]</a>)<a class='hidden_link' href='#task.promise-12.sentence-1'>.</a></div> <div id='task.promise-12.sentence-2' class='sentence'>Otherwise, stores <span class='texttt'>current_<span class='shy'></span>exception<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> into <span class='texttt'><i >errors</i></span><a class='hidden_link' href='#task.promise-12.sentence-2'>.</a></div></div></div></div><div class='texpara'><div id='lib:task::promise_type,unhandled_stopped'><div id='lib:unhandled_stopped,task::promise_type'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:unhandled_stopped,task::promise_type'>🔗</a></div><code class='itemdeclcode'>coroutine_handle<span class='anglebracket'>&lt;</span><span class='anglebracket'>&gt;</span> unhandled_stopped<span class='parenthesis'>(</span><span class='parenthesis'>)</span>;
</code></div></div></div></div><div class='para' id='task.promise-13'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-13'>13</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7661'>#</a></div><div class='texpara'><div id='task.promise-13.sentence-1' class='sentence'><i >Effects</i>: Completes the asynchronous operation associated with <span class='texttt'><span class='texttt'><i >STATE</i></span><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span></span>
by invoking <span class='texttt'>set_<span class='shy'></span>stopped<span class='parenthesis'>(</span>std<span class='operator'>&#x200b;::&#x200b;</span>move<span class='parenthesis'>(</span><span class='texttt'><i >RCVR</i></span><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.promise-13.sentence-1'>.</a></div></div></div></div><div class='para' id='task.promise-14'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-14'>14</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7667'>#</a></div><div class='texpara'><div id='task.promise-14.sentence-1' class='sentence'><i >Returns</i>: <span class='texttt'>noop_<span class='shy'></span>coroutine<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.promise-14.sentence-1'>.</a></div></div></div></div><div class='texpara'><div id='lib:task::promise_type,get_env'><div id='lib:get_env,task::promise_type'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:get_env,task::promise_type'>🔗</a></div><code class='itemdeclcode'><i ><span class='texttt'>unspecified</span></i> get_env<span class='parenthesis'>(</span><span class='parenthesis'>)</span> <span class='keyword'>const</span> <span class='keyword'>noexcept</span>;
</code></div></div></div></div><div class='para' id='task.promise-15'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-15'>15</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7677'>#</a></div><div class='texpara'><div id='task.promise-15.sentence-1' class='sentence'><i >Returns</i>: An object <span class='texttt'>env</span> such that queries are forwarded as follows:
<ul class='itemize'><li id='task.promise-15.1'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.promise-15.1'>(15.1)</a></div><div class='texpara'><div id='task.promise-15.1.sentence-1' class='sentence'><span class='texttt'>env<span class='operator'>.</span>query<span class='parenthesis'>(</span>get_<span class='shy'></span>scheduler<span class='parenthesis'>)</span></span> returns <span class='texttt'>scheduler_<span class='shy'></span>type<span class='parenthesis'>(</span><span class='texttt'><i >SCHED</i></span><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.promise-15.1.sentence-1'>.</a></div></div></li><li id='task.promise-15.2'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.promise-15.2'>(15.2)</a></div><div class='texpara'><div id='task.promise-15.2.sentence-1' class='sentence'><span class='texttt'>env<span class='operator'>.</span>query<span class='parenthesis'>(</span>get_<span class='shy'></span>allocator<span class='parenthesis'>)</span></span> returns <span class='texttt'><i >alloc</i></span><a class='hidden_link' href='#task.promise-15.2.sentence-1'>.</a></div></div></li><li id='task.promise-15.3'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.promise-15.3'>(15.3)</a></div><div class='texpara'><div id='task.promise-15.3.sentence-1' class='sentence'><span class='texttt'>env<span class='operator'>.</span>query<span class='parenthesis'>(</span>get_<span class='shy'></span>stop_<span class='shy'></span>token<span class='parenthesis'>)</span></span> returns <span class='texttt'><i >token</i></span><a class='hidden_link' href='#task.promise-15.3.sentence-1'>.</a></div></div></li><li id='task.promise-15.4'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.promise-15.4'>(15.4)</a></div><div class='texpara'><div id='task.promise-15.4.sentence-1' class='sentence'>For any other query <span class='texttt'>q</span> and arguments <span class='texttt'>a<span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span></span> a
call to <span class='texttt'>env<span class='operator'>.</span>query<span class='parenthesis'>(</span>q, a<span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='parenthesis'>)</span></span> returns
<span class='texttt'><span class='texttt'><i >STATE</i></span><span class='parenthesis'>(</span><span class='operator'>*</span><span class='keyword'>this</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.promise-15.4.sentence-1'>.</a></div> <div id='task.promise-15.4.sentence-2' class='sentence'><span class='texttt'>environment<span class='operator'>.</span>query<span class='parenthesis'>(</span>q, a<span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='parenthesis'>)</span></span> if this expression
is well-formed and <span class='texttt'>forwarding_<span class='shy'></span>query<span class='parenthesis'>(</span>q<span class='parenthesis'>)</span></span> is well-formed and is <span class='texttt'><span class='literal'>true</span></span><a class='hidden_link' href='#task.promise-15.4.sentence-2'>.</a></div> <div id='task.promise-15.4.sentence-3' class='sentence'>Otherwise <span class='texttt'>env<span class='operator'>.</span>query<span class='parenthesis'>(</span>q, a<span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span><span class='parenthesis'>)</span></span> is ill-formed<a class='hidden_link' href='#task.promise-15.4.sentence-3'>.</a></div></div></li></ul></div></div></div></div><div class='texpara'><div id='lib:task::promise_type,operator_new'><div id='lib:operator_new,task::promise_type'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:operator_new,task::promise_type'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>template</span><span class='anglebracket'>&lt;</span><span class='keyword'>class</span><span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span> Args<span class='anglebracket'>&gt;</span>
  <span class='keyword'>void</span><span class='operator'>*</span> <span class='keyword'>operator</span> <span class='keyword'>new</span><span class='parenthesis'>(</span>size_t size, <span class='keyword'>const</span> Args<span class='operator'>&amp;</span><span class='operator'>.</span><span class='operator'>.</span><span class='operator'>.</span> args<span class='parenthesis'>)</span>;
</code></div></div></div></div><div class='para' id='task.promise-16'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-16'>16</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7698'>#</a></div><div class='texpara'><div id='task.promise-16.sentence-1' class='sentence'>If there is no parameter with type <span class='texttt'>allocator_<span class='shy'></span>arg_<span class='shy'></span>t</span> then let
<span class='texttt'><i >alloc</i></span> be <span class='texttt'>Allocator<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.promise-16.sentence-1'>.</a></div> <div id='task.promise-16.sentence-2' class='sentence'>Let <span class='texttt'><i >arg_<span class='shy'></span>next</i></span> be the parameter following the first
<span class='texttt'>allocator_<span class='shy'></span>arg_<span class='shy'></span>t</span> parameter (if any) and let <span class='texttt'><i >alloc</i></span>
be <span class='texttt'>Allocator<span class='parenthesis'>(</span><i >arg_<span class='shy'></span>next</i><span class='parenthesis'>)</span></span><a class='hidden_link' href='#task.promise-16.sentence-2'>.</a></div> <div id='task.promise-16.sentence-3' class='sentence'>Then <span class='texttt'>PAlloc</span> is <span class='texttt'>allocator_<span class='shy'></span>traits<span class='anglebracket'>&lt;</span>Allocator<span class='anglebracket'>&gt;</span><span class='operator'>&#x200b;::&#x200b;</span><span class='keyword'>template</span>
rebind_<span class='shy'></span>alloc&#x200b;<span class='anglebracket'>&lt;</span>U<span class='anglebracket'>&gt;</span></span> where <span class='texttt'>U</span> is an unspecified type
whose size and alignment are both <span class='texttt'>__STDCPP_<span class='shy'></span>DEFAULT_<span class='shy'></span>NEW_<span class='shy'></span>ALIGNMENT__</span><a class='hidden_link' href='#task.promise-16.sentence-3'>.</a></div></div></div></div><div class='para' id='task.promise-17'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-17'>17</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7708'>#</a></div><div class='texpara'><div id='task.promise-17.sentence-1' class='sentence'><i >Mandates</i>: <ul class='itemize'><li id='task.promise-17.1'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.promise-17.1'>(17.1)</a></div><div class='texpara'><div id='task.promise-17.1.sentence-1' class='sentence'>The first parameter of type <span class='texttt'>allocator_<span class='shy'></span>arg_<span class='shy'></span>t</span> (if any) is not the last parameter<a class='hidden_link' href='#task.promise-17.1.sentence-1'>.</a></div></div></li><li id='task.promise-17.2'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.promise-17.2'>(17.2)</a></div><div class='texpara'><div id='task.promise-17.2.sentence-1' class='sentence'><span class='texttt'>Allocator<span class='parenthesis'>(</span><i >arg_<span class='shy'></span>next</i><span class='parenthesis'>)</span></span> is a valid expression if there is a parameter
of type <span class='texttt'>allocator_<span class='shy'></span>arg_<span class='shy'></span>t</span><a class='hidden_link' href='#task.promise-17.2.sentence-1'>.</a></div></div></li><li id='task.promise-17.3'><div class='marginalizedparent' style='left:-39mm'><a class='marginalized' href='#task.promise-17.3'>(17.3)</a></div><div class='texpara'><div id='task.promise-17.3.sentence-1' class='sentence'><span class='texttt'>allocator_<span class='shy'></span>traits<span class='anglebracket'>&lt;</span>PAlloc<span class='anglebracket'>&gt;</span><span class='operator'>&#x200b;::&#x200b;</span>pointer</span> is a pointer type<a class='hidden_link' href='#task.promise-17.3.sentence-1'>.</a></div></div></li></ul></div></div></div></div><div class='para' id='task.promise-18'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-18'>18</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7717'>#</a></div><div class='texpara'><div id='task.promise-18.sentence-1' class='sentence'><i >Effects</i>: Initializes an allocator <span class='texttt'>palloc</span> of type <span class='texttt'>PAlloc</span> with
<span class='texttt'><i >alloc</i></span><a class='hidden_link' href='#task.promise-18.sentence-1'>.</a></div> <div id='task.promise-18.sentence-2' class='sentence'>Uses <span class='texttt'>palloc</span> to allocate storage for the
smallest array of <span class='texttt'>U</span> sufficient to provide storage for a
coroutine state of size <span class='texttt'>size</span>, and unspecified additional
state necessary to ensure that <span class='texttt'><span class='keyword'>operator</span> <span class='keyword'>delete</span></span> can later
deallocate this memory block with an allocator equal to <span class='texttt'>palloc</span><a class='hidden_link' href='#task.promise-18.sentence-2'>.</a></div></div></div></div><div class='para' id='task.promise-19'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-19'>19</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7727'>#</a></div><div class='texpara'><div id='task.promise-19.sentence-1' class='sentence'><i >Returns</i>: A pointer to the allocated storage<a class='hidden_link' href='#task.promise-19.sentence-1'>.</a></div></div></div></div><div class='texpara'><div id='lib:task::promise_type,operator_delete'><div id='lib:operator_delete,task::promise_type'><div class='itemdecl'><div class='marginalizedparent'><a class='itemDeclLink' href='#lib:operator_delete,task::promise_type'>🔗</a></div><code class='itemdeclcode'><span class='keyword'>void</span> <span class='keyword'>operator</span> <span class='keyword'>delete</span><span class='parenthesis'>(</span><span class='keyword'>void</span><span class='operator'>*</span> pointer, size_t size<span class='parenthesis'>)</span> <span class='keyword'>noexcept</span>;
</code></div></div></div></div><div class='para' id='task.promise-20'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-20'>20</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7737'>#</a></div><div class='texpara'><div id='task.promise-20.sentence-1' class='sentence'><i >Preconditions</i>: <span class='texttt'>pointer</span> was returned from an invocation of the above overload
of <span class='texttt'><span class='keyword'>operator</span> <span class='keyword'>new</span></span> with a size argument equal to <span class='texttt'>size</span><a class='hidden_link' href='#task.promise-20.sentence-1'>.</a></div></div></div></div><div class='para' id='task.promise-21'><div class='marginalizedparent'><a class='marginalized' href='#task.promise-21'>21</a></div><div class='itemdescr'><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/454ba171cb14531639e641cb1200617fbf8d943f/source/exec.tex#L7742'>#</a></div><div class='texpara'><div id='task.promise-21.sentence-1' class='sentence'><i >Effects</i>: Deallocates the storage pointed to by <span class='texttt'>pointer</span> using an
allocator equal to that used to allocate it<a class='hidden_link' href='#task.promise-21.sentence-1'>.</a></div></div></div></div></div></div></div></body></html>