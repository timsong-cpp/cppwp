<!DOCTYPE html><html lang='en'><head><title>[futures.state]</title><meta charset='UTF-8'><link rel='stylesheet' type='text/css' href='14882.css'><link rel='stylesheet' type='text/css' href='https://fonts.googleapis.com/css2?family=Noto+Serif'><link rel='stylesheet' type='text/css' href='https://fonts.googleapis.com/css2?family=Noto+Sans'><link rel='stylesheet' type='text/css' href='https://fonts.googleapis.com/css2?family=Noto+Sans+Mono'><link rel='icon' href='icon.png'><link rel='stylesheet' type='text/css' href='expanded.css' title='Normal'><link rel='alternate stylesheet' type='text/css' href='colored.css' title='Notes and examples colored'><link rel='alternate stylesheet' type='text/css' href='normative-only.css' title='Notes and examples hidden'></head><body><div class='wrapper'><h1 ><a class='secnum' style='min-width:50pt'>32</a> Concurrency support library <a class='abbr_ref' href='./#thread'>[thread]</a></h1><h2 ><a class='secnum' style='min-width:65pt'>32.10</a> Futures <a class='abbr_ref' href='futures#state'>[futures]</a></h2><h3 ><a class='secnum' style='min-width:80pt'>32.10.5</a> Shared state <a class='abbr_ref'>[futures.state]</a></h3><div class='para' id='1'><div class='marginalizedparent'><a class='marginalized' href='#1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/2d59c792e2a0228e77a0316d39bde9e51f31d146/source/threads.tex#L10571'>#</a></div><div class='texpara'><div id='1.sentence-1' class='sentence'>Many of the classes introduced in subclause <a href='futures' title='32.10&emsp;Futures'>[futures]</a> use some state to communicate results<a class='hidden_link' href='#1.sentence-1'>.</a></div> <div id='1.sentence-2' class='sentence'>This

<a class='hidden_link' href='#def:future,shared_state' title='32.10.5&emsp;Shared state&emsp;[futures.state]'><span id='def:future,shared_state'><i >shared state</i></span></a> consists of some state information and some (possibly not
yet evaluated) <a class='hidden_link' href='#def:result' id='def:result'><i>result</i></a>, which can be a (possibly void) value or an exception<a class='hidden_link' href='#1.sentence-2'>.</a></div> <div id='note-1' class='note'><div class='texpara'>[<i>Note&nbsp;<a href='#note-1'>1</a></i>:&ensp;<div id='1.sentence-3' class='sentence'>Futures, promises, and tasks defined in this Clause reference such shared state<a class='hidden_link' href='#1.sentence-3'>.</a></div> —&nbsp;<i>end note</i>]</div></div></div></div><div class='para nonNormativeOnly' id='2'><div class='marginalizedparent'><a class='marginalized' href='#2'>2</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/2d59c792e2a0228e77a0316d39bde9e51f31d146/source/threads.tex#L10580'>#</a></div><div class='texpara'><div id='note-2' class='note'><div class='texpara'>[<i>Note&nbsp;<a href='#note-2'>2</a></i>:&ensp;<div id='2.sentence-1' class='sentence'>The result can be any kind of object including a function to compute that result,
as used by <span class='texttt'>async</span> when <span class='texttt'>policy</span> is <span class='texttt'>launch<span class='operator'>&#x200b;::&#x200b;</span>deferred</span><a class='hidden_link' href='#2.sentence-1'>.</a></div> —&nbsp;<i>end note</i>]</div></div></div></div><div class='para' id='3'><div class='marginalizedparent'><a class='marginalized' href='#3'>3</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/2d59c792e2a0228e77a0316d39bde9e51f31d146/source/threads.tex#L10586'>#</a></div><div class='texpara'><div id='3.sentence-1' class='sentence'>An <a class='hidden_link' href='#def:asynchronous_return_object' title='32.10.5&emsp;Shared state&emsp;[futures.state]'><span id='def:asynchronous_return_object'><i >asynchronous return object</i></span></a> is an object that reads results from a
shared state<a class='hidden_link' href='#3.sentence-1'>.</a></div> <div id='3.sentence-2' class='sentence'>A <a class='hidden_link' href='#def:function,waiting' title='32.10.5&emsp;Shared state&emsp;[futures.state]'><span id='def:function,waiting'><i >waiting function</i></span></a> of an asynchronous return object is one
that potentially blocks to wait for the shared state to be made
ready<a class='hidden_link' href='#3.sentence-2'>.</a></div> <div id='3.sentence-3' class='sentence'>If a waiting function can return before the state is made ready because of a
timeout (<a href='thread.req.lockable' title='32.2.5&emsp;Requirements for Cpp17Lockable types'>[thread.<span class='shy'></span>req.<span class='shy'></span>lockable]</a>), then it is a <a class='hidden_link' href='#def:timed_waiting_function' id='def:timed_waiting_function'><i>timed waiting function</i></a>, otherwise
it is a <a class='hidden_link' href='#def:non-timed_waiting_function' id='def:non-timed_waiting_function'><i>non-timed waiting function</i></a><a class='hidden_link' href='#3.sentence-3'>.</a></div></div></div><div class='para' id='4'><div class='marginalizedparent'><a class='marginalized' href='#4'>4</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/2d59c792e2a0228e77a0316d39bde9e51f31d146/source/threads.tex#L10595'>#</a></div><div class='texpara'><div id='4.sentence-1' class='sentence'>An <a class='hidden_link' href='#def:asynchronous_provider' title='32.10.5&emsp;Shared state&emsp;[futures.state]'><span id='def:asynchronous_provider'><i >asynchronous provider</i></span></a> is an object that provides a result to a shared
state<a class='hidden_link' href='#4.sentence-1'>.</a></div> <div id='4.sentence-2' class='sentence'>The result of a shared state is set by
respective functions on the asynchronous provider<a class='hidden_link' href='#4.sentence-2'>.</a></div> <div id='example-1' class='example'><div class='texpara'>[<i>Example&nbsp;<a href='#example-1'>1</a></i>:&ensp;<div id='4.sentence-3' class='sentence'>Promises and tasks are examples of asynchronous providers<a class='hidden_link' href='#4.sentence-3'>.</a></div> —&nbsp;<i>end example</i>]</div></div> <div id='4.sentence-4' class='sentence'>
The means of setting the result of a shared state is specified
in the description of those classes and functions that create such a state object<a class='hidden_link' href='#4.sentence-4'>.</a></div></div></div><div class='para' id='5'><div class='marginalizedparent'><a class='marginalized' href='#5'>5</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/2d59c792e2a0228e77a0316d39bde9e51f31d146/source/threads.tex#L10606'>#</a></div><div class='texpara'><div id='5.sentence-1' class='sentence'>When an asynchronous return object or an asynchronous provider is said to release its
shared state, it means:
<ul class='itemize'><li id='5.1'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#5.1'>(5.1)</a></div>if the return object or provider holds the last reference to its shared state,
the shared state is destroyed; and</li><li id='5.2'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#5.2'>(5.2)</a></div>the return object or provider gives up its reference to its shared state; and</li><li id='5.3'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#5.3'>(5.3)</a></div>these actions will not block for the shared state to become ready, except that it
may block if all of the following are true: the shared state was created by a call to
<span class='texttt'>std<span class='operator'>&#x200b;::&#x200b;</span>async</span>, the shared state is not yet ready, and this was the last reference
to the shared state<a class='hidden_link' href='#5.sentence-1'>.</a></li></ul></div></div></div><div class='para' id='6'><div class='marginalizedparent'><a class='marginalized' href='#6'>6</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/2d59c792e2a0228e77a0316d39bde9e51f31d146/source/threads.tex#L10623'>#</a></div><div class='texpara'><div id='6.sentence-1' class='sentence'>When an asynchronous provider is said to make its shared state ready, it means:
<ul class='itemize'><li id='6.1'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#6.1'>(6.1)</a></div>first, the provider marks its shared state as ready; and</li><li id='6.2'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#6.2'>(6.2)</a></div>second, the provider unblocks any execution agents waiting for its shared
state to become ready<a class='hidden_link' href='#6.sentence-1'>.</a></li></ul></div></div></div><div class='para' id='7'><div class='marginalizedparent'><a class='marginalized' href='#7'>7</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/2d59c792e2a0228e77a0316d39bde9e51f31d146/source/threads.tex#L10633'>#</a></div><div class='texpara'><div id='7.sentence-1' class='sentence'>When an asynchronous provider is said to abandon its shared state, it means:
<ul class='itemize'><li id='7.1'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#7.1'>(7.1)</a></div>first, if that state is not ready, the provider
<ul class='itemize'><li id='7.1.1'><div class='marginalizedparent' style='left:-36mm'><a class='marginalized' href='#7.1.1'>(7.1.1)</a></div>stores an exception object of type <span class='texttt'>future_<span class='shy'></span>error</span> with an error condition of
<span class='texttt'>broken_<span class='shy'></span>promise</span> within its shared state; and then</li><li id='7.1.2'><div class='marginalizedparent' style='left:-36mm'><a class='marginalized' href='#7.1.2'>(7.1.2)</a></div>makes its shared state ready;</li></ul></li><li id='7.2'><div class='marginalizedparent' style='left:-27mm'><a class='marginalized' href='#7.2'>(7.2)</a></div>second, the provider releases its shared state<a class='hidden_link' href='#7.sentence-1'>.</a></li></ul></div></div></div><div class='para' id='8'><div class='marginalizedparent'><a class='marginalized' href='#8'>8</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/2d59c792e2a0228e77a0316d39bde9e51f31d146/source/threads.tex#L10649'>#</a></div><div class='texpara'><div id='8.sentence-1' class='sentence'>A shared state is <a class='hidden_link' href='#def:ready' title='32.10.5&emsp;Shared state&emsp;[futures.state]'><span id='def:ready'><i >ready</i></span></a> only if it holds a value or an exception ready for
retrieval<a class='hidden_link' href='#8.sentence-1'>.</a></div> <div id='8.sentence-2' class='sentence'>Waiting for a shared state to become ready may invoke code to compute the result on
the waiting thread if so specified in the description of the class or function that creates
the state object<a class='hidden_link' href='#8.sentence-2'>.</a></div></div></div><div class='para' id='9'><div class='marginalizedparent'><a class='marginalized' href='#9'>9</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/2d59c792e2a0228e77a0316d39bde9e51f31d146/source/threads.tex#L10656'>#</a></div><div class='texpara'><div id='9.sentence-1' class='sentence'>Calls to functions that successfully set the stored result of a shared
state <a href='intro.multithread#def:synchronize_with' title='6.9.2&emsp;Multi-threaded executions and data races&emsp;[intro.multithread]'>synchronize with</a> calls to functions
successfully detecting the ready state resulting from that setting<a class='hidden_link' href='#9.sentence-1'>.</a></div> <div id='9.sentence-2' class='sentence'>The storage of the result
(whether normal or exceptional) into the shared state
<a href='intro.multithread#def:synchronize_with' title='6.9.2&emsp;Multi-threaded executions and data races&emsp;[intro.multithread]'>synchronizes with</a>
the successful return from a call to a waiting function on the shared state<a class='hidden_link' href='#9.sentence-2'>.</a></div></div></div><div class='para' id='10'><div class='marginalizedparent'><a class='marginalized' href='#10'>10</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/2d59c792e2a0228e77a0316d39bde9e51f31d146/source/threads.tex#L10665'>#</a></div><div class='texpara'><div id='10.sentence-1' class='sentence'>Some functions (e.g., <span class='texttt'>promise<span class='operator'>&#x200b;::&#x200b;</span>set_<span class='shy'></span>value_<span class='shy'></span>at_<span class='shy'></span>thread_<span class='shy'></span>exit</span>) delay making
the shared state ready until the calling thread exits<a class='hidden_link' href='#10.sentence-1'>.</a></div> <div id='10.sentence-2' class='sentence'>The destruction of
each of that thread's objects with <a href='basic.stc.thread' title='6.7.6.3&emsp;Thread storage duration&emsp;[basic.stc.thread]'>thread storage duration</a>
is sequenced before making that shared state ready<a class='hidden_link' href='#10.sentence-2'>.</a></div></div></div><div class='para' id='11'><div class='marginalizedparent'><a class='marginalized' href='#11'>11</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/2d59c792e2a0228e77a0316d39bde9e51f31d146/source/threads.tex#L10671'>#</a></div><div class='texpara'><div id='11.sentence-1' class='sentence'>Access to the result of the same shared state may <a href='intro.multithread#def:conflict' title='6.9.2&emsp;Multi-threaded executions and data races&emsp;[intro.multithread]'>conflict</a><a class='hidden_link' href='#11.sentence-1'>.</a></div> <div id='note-3' class='note'><div class='texpara'>[<i>Note&nbsp;<a href='#note-3'>3</a></i>:&ensp;<div id='11.sentence-2' class='sentence'>This explicitly specifies that the result of the shared state is
visible in the objects that reference this state in the sense of data race
avoidance (<a href='res.on.data.races' title='16.4.6.10&emsp;Data race avoidance'>[res.<span class='shy'></span>on.<span class='shy'></span>data.<span class='shy'></span>races]</a>)<a class='hidden_link' href='#11.sentence-2'>.</a></div> <div id='11.sentence-3' class='sentence'>For example, concurrent accesses through
references returned by <span class='texttt'>shared_<span class='shy'></span>future<span class='operator'>&#x200b;::&#x200b;</span>get<span class='parenthesis'>(</span><span class='parenthesis'>)</span></span> (<a href='futures.shared.future' title='32.10.8&emsp;Class template shared_&shy;future'>[futures.<span class='shy'></span>shared.<span class='shy'></span>future]</a>)
must either use read-only operations or provide additional synchronization<a class='hidden_link' href='#11.sentence-3'>.</a></div> —&nbsp;<i>end note</i>]</div></div></div></div></div></body></html>